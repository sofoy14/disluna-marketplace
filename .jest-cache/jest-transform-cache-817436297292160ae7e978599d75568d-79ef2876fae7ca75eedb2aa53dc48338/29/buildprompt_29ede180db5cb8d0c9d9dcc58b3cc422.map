{"version":3,"names":["exports","buildFinalMessages","cov_2iye9afjex","s","adaptMessagesForGoogleGemini","gpt_tokenizer_1","require","utils_1","buildBasePrompt","prompt","profileContext","workspaceInstructions","assistant","f","fullPrompt","b","name","Date","toLocaleDateString","payload","profile","chatImages","chatSettings","chatMessages","messageFileItems","chatFileItems","BUILT_PROMPT","includeProfileContext","profile_context","includeWorkspaceInstructions","CHUNK_SIZE","contextLength","PROMPT_TOKENS","encode","length","remainingTokens","usedTokens","processedChatMessages","map","chatMessage","index","nextChatMessage","undefined","nextChatMessageFileItems","fileItems","findFileItems","fileItemId","find","chatFileItem","id","filter","item","retrievalText","buildRetrievalText","message","content","finalMessages","i","messageTokens","unshift","tempSystemMessage","chat_id","assistant_id","created_at","image_paths","model","role","sequence_number","updated_at","user_id","type","text","path","formedUrl","startsWith","chatImage","image","base64","image_url","url","join","adaptSingleMessageForGoogleGemini","adaptedParts","rawParts","Array","isArray","push","rawPart","inlineData","data","getBase64FromDataURL","mimeType","getMediaTypeFromDataURL","includes","parts","adaptMessagesForGeminiVision","messages","basePrompt","baseRole","lastMessage","visualMessageParts","visualQueryMessages","slice","geminiMessages","adaptedMessage"],"sources":["C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\lib\\build-prompt.ts"],"sourcesContent":["import { Tables } from \"@/supabase/types\"\nimport { ChatPayload, MessageImage } from \"@/types\"\nimport { encode } from \"gpt-tokenizer\"\nimport { getBase64FromDataURL, getMediaTypeFromDataURL } from \"@/lib/utils\"\n\nconst buildBasePrompt = (\n  prompt: string,\n  profileContext: string,\n  workspaceInstructions: string,\n  assistant: Tables<\"assistants\"> | null\n) => {\n  let fullPrompt = \"\"\n\n  if (assistant) {\n    fullPrompt += `<INJECT ROLE>\\nYou are not an AI. You are ${assistant.name}.\\n</INJECT ROLE>\\n\\n`\n  }\n\n  fullPrompt += `Hoy es ${new Date().toLocaleDateString('es-ES')}.\\n\\n`\n\n  // Instrucción específica para memoria de conversación\n  fullPrompt += `IMPORTANTE - MEMORIA DE CONVERSACIÓN:\n- SIEMPRE recuerda el contexto completo de esta conversación\n- Si el usuario hace referencia a mensajes anteriores, responde en ese contexto\n- Mantén coherencia con respuestas previas sobre el mismo tema\n- NO repitas información ya proporcionada, pero puedes ampliarla si es necesario\n- Si el usuario pregunta \"al respecto\" o \"sobre esto\", refiérete al tema de la conversación actual\n\n`\n\n  if (profileContext) {\n    fullPrompt += `User Info:\\n${profileContext}\\n\\n`\n  }\n\n  if (workspaceInstructions) {\n    fullPrompt += `System Instructions:\\n${workspaceInstructions}\\n\\n`\n  }\n\n  fullPrompt += `User Instructions:\\n${prompt}`\n\n  return fullPrompt\n}\n\nexport async function buildFinalMessages(\n  payload: ChatPayload,\n  profile: Tables<\"profiles\">,\n  chatImages: MessageImage[]\n) {\n  const {\n    chatSettings,\n    workspaceInstructions,\n    chatMessages,\n    assistant,\n    messageFileItems,\n    chatFileItems\n  } = payload\n\n  const BUILT_PROMPT = buildBasePrompt(\n    chatSettings.prompt,\n    chatSettings.includeProfileContext ? profile.profile_context || \"\" : \"\",\n    chatSettings.includeWorkspaceInstructions ? workspaceInstructions : \"\",\n    assistant\n  )\n\n  const CHUNK_SIZE = chatSettings.contextLength\n  const PROMPT_TOKENS = encode(chatSettings.prompt).length\n\n  let remainingTokens = CHUNK_SIZE - PROMPT_TOKENS\n\n  let usedTokens = 0\n  usedTokens += PROMPT_TOKENS\n\n  const processedChatMessages = chatMessages.map((chatMessage, index) => {\n    const nextChatMessage = chatMessages[index + 1]\n\n    if (nextChatMessage === undefined) {\n      return chatMessage\n    }\n\n    const nextChatMessageFileItems = nextChatMessage.fileItems\n\n    if (nextChatMessageFileItems.length > 0) {\n      const findFileItems = nextChatMessageFileItems\n        .map(fileItemId =>\n          chatFileItems.find(chatFileItem => chatFileItem.id === fileItemId)\n        )\n        .filter(item => item !== undefined) as Tables<\"file_items\">[]\n\n      const retrievalText = buildRetrievalText(findFileItems)\n\n      return {\n        message: {\n          ...chatMessage.message,\n          content:\n            `${chatMessage.message.content}\\n\\n${retrievalText}` as string\n        },\n        fileItems: []\n      }\n    }\n\n    return chatMessage\n  })\n\n  let finalMessages = []\n\n  for (let i = processedChatMessages.length - 1; i >= 0; i--) {\n    const message = processedChatMessages[i].message\n    const messageTokens = encode(message.content).length\n\n    if (messageTokens <= remainingTokens) {\n      remainingTokens -= messageTokens\n      usedTokens += messageTokens\n      finalMessages.unshift(message)\n    } else {\n      break\n    }\n  }\n\n  let tempSystemMessage: Tables<\"messages\"> = {\n    chat_id: \"\",\n    assistant_id: null,\n    content: BUILT_PROMPT,\n    created_at: \"\",\n    id: processedChatMessages.length + \"\",\n    image_paths: [],\n    model: payload.chatSettings.model,\n    role: \"system\",\n    sequence_number: processedChatMessages.length,\n    updated_at: \"\",\n    user_id: \"\"\n  }\n\n  finalMessages.unshift(tempSystemMessage)\n\n  finalMessages = finalMessages.map(message => {\n    let content\n\n    if (message.image_paths.length > 0) {\n      content = [\n        {\n          type: \"text\",\n          text: message.content\n        },\n        ...message.image_paths.map(path => {\n          let formedUrl = \"\"\n\n          if (path.startsWith(\"data\")) {\n            formedUrl = path\n          } else {\n            const chatImage = chatImages.find(image => image.path === path)\n\n            if (chatImage) {\n              formedUrl = chatImage.base64\n            }\n          }\n\n          return {\n            type: \"image_url\",\n            image_url: {\n              url: formedUrl\n            }\n          }\n        })\n      ]\n    } else {\n      content = message.content\n    }\n\n    return {\n      role: message.role,\n      content\n    }\n  })\n\n  if (messageFileItems.length > 0) {\n    const retrievalText = buildRetrievalText(messageFileItems)\n\n    finalMessages[finalMessages.length - 1] = {\n      ...finalMessages[finalMessages.length - 1],\n      content: `${\n        finalMessages[finalMessages.length - 1].content\n      }\\n\\n${retrievalText}`\n    }\n  }\n\n  return finalMessages\n}\n\nfunction buildRetrievalText(fileItems: Tables<\"file_items\">[]) {\n  const retrievalText = fileItems\n    .map(item => `<BEGIN SOURCE>\\n${item.content}\\n</END SOURCE>`)\n    .join(\"\\n\\n\")\n\n  return `You may use the following sources if needed to answer the user's question. If you don't know the answer, say \"I don't know.\"\\n\\n${retrievalText}`\n}\n\nfunction adaptSingleMessageForGoogleGemini(message: any) {\n\n  let adaptedParts = []\n\n  let rawParts = []\n  if(!Array.isArray(message.content)) {\n    rawParts.push({type: 'text', text: message.content})\n  } else {\n    rawParts = message.content\n  }\n\n  for(let i = 0; i < rawParts.length; i++) {\n    let rawPart = rawParts[i]\n\n    if(rawPart.type == 'text') {\n      adaptedParts.push({text: rawPart.text})\n    } else if(rawPart.type === 'image_url') {\n      adaptedParts.push({\n        inlineData: {\n          data: getBase64FromDataURL(rawPart.image_url.url),\n          mimeType: getMediaTypeFromDataURL(rawPart.image_url.url),\n        }\n      })\n    }\n  }\n\n  let role = 'user'\n  if([\"user\", \"system\"].includes(message.role)) {\n    role = 'user'\n  } else if(message.role === 'assistant') {\n    role = 'model'\n  }\n\n  return {\n    role: role,\n    parts: adaptedParts\n  }\n}\n\nfunction adaptMessagesForGeminiVision(\n  messages: any[]\n) {\n  // Gemini Pro Vision cannot process multiple messages\n  // Reformat, using all texts and last visual only\n\n  const basePrompt = messages[0].parts[0].text\n  const baseRole = messages[0].role\n  const lastMessage = messages[messages.length-1]\n  const visualMessageParts = lastMessage.parts;\n  let visualQueryMessages = [{\n    role: \"user\",\n    parts: [\n      `${baseRole}:\\n${basePrompt}\\n\\nuser:\\n${visualMessageParts[0].text}\\n\\n`,\n      visualMessageParts.slice(1)\n    ]\n  }]\n  return visualQueryMessages\n}\n\nexport async function adaptMessagesForGoogleGemini(\n  payload: ChatPayload,\n  messages:  any[]\n) {\n  let geminiMessages = []\n  for (let i = 0; i < messages.length; i++) {\n    let adaptedMessage = adaptSingleMessageForGoogleGemini(messages[i])\n    geminiMessages.push(adaptedMessage)\n  }\n\n  if(payload.chatSettings.model === \"gemini-pro-vision\") {\n    geminiMessages = adaptMessagesForGeminiVision(geminiMessages)\n  }\n  return geminiMessages\n}\n\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}