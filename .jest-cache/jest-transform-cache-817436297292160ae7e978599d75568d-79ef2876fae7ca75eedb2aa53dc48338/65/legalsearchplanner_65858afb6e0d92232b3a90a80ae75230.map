{"version":3,"names":["cov_2lcp2894sf","actualCoverage","s","exports","planLegalSearchStrategy","client","model","userQuery","maxQueries","b","f","systemPrompt","join","userPrompt","completion","chat","completions","create","messages","role","content","temperature","max_tokens","stream","rawContent","choices","message","trim","plan","parsePlan","error","console","queries","jsonText","extractJson","parsed","JSON","parse","Array","isArray","slice","map","item","query","filter","length","rationale","notes","undefined","warn","start","indexOf","end","lastIndexOf","Error"],"sources":["C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\lib\\tools\\legal-search-planner.ts"],"sourcesContent":["import OpenAI from \"openai\"\n\nexport interface LegalSearchPlan {\n  queries: string[]\n  rationale?: string\n}\n\ninterface PlannerOptions {\n  client: OpenAI\n  model: string\n  userQuery: string\n  maxQueries?: number\n}\n\nexport async function planLegalSearchStrategy({\n  client,\n  model,\n  userQuery,\n  maxQueries = 5,\n}: PlannerOptions): Promise<LegalSearchPlan> {\n  const systemPrompt = [\n    \"Eres un planificador de busquedas juridicas para derecho colombiano.\",\n    \"Tu objetivo es decidir cuantas busquedas web ejecutar y con que terminos especificos.\",\n    \"Responde UNICAMENTE en JSON con el formato:\",\n    `{\"queries\":[{\"query\":\"...\", \"reason\":\"...\"}], \"notes\":\"...\"} `,\n    `- \"queries\" debe tener entre 0 y ${maxQueries} elementos.`,\n    \"- Ajusta cada consulta para priorizar fuentes oficiales colombianas.\",\n    \"- Incluye site: si es claro que debe buscarse en un dominio oficial.\",\n    \"- Si no es necesaria busqueda, retorna una lista vacia y explica por que en notes.\",\n    \"- No incluyas texto adicional fuera del JSON.\",\n  ].join(\" \")\n\n  const userPrompt = [\n    `Consulta del usuario: \"${userQuery}\"`,\n    \"Analiza si la informacion puede requerir datos actualizados, jurisprudencia especifica o confirmacion normativa.\",\n    \"Devuelve un plan de busqueda con cada consulta enfocada.\",\n  ].join(\"\\n\")\n\n  try {\n    const completion = await client.chat.completions.create({\n      model,\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      temperature: 0.2,\n      max_tokens: 300,\n      stream: false,\n    })\n\n    const rawContent =\n      completion.choices?.[0]?.message?.content?.trim() ?? '{\"queries\":[]}'\n\n    const plan = parsePlan(rawContent, maxQueries)\n    return plan\n  } catch (error) {\n    console.error(\"[legal-search-planner] Error obteniendo plan:\", error)\n    return { queries: [] }\n  }\n}\n\nfunction parsePlan(content: string, maxQueries: number): LegalSearchPlan {\n  try {\n    const jsonText = extractJson(content)\n    const parsed = JSON.parse(jsonText)\n\n    if (!Array.isArray(parsed?.queries)) {\n      return { queries: [] }\n    }\n\n    const queries = parsed.queries\n      .slice(0, maxQueries)\n      .map((item: any) =>\n        typeof item?.query === \"string\" ? item.query.trim() : \"\"\n      )\n      .filter((query: string) => query.length > 0)\n\n    const rationale =\n      typeof parsed?.notes === \"string\" ? parsed.notes.trim() : undefined\n\n    return {\n      queries,\n      rationale,\n    }\n  } catch (error) {\n    console.warn(\n      \"[legal-search-planner] No se pudo parsear el JSON del plan de busqueda:\",\n      error\n    )\n    return { queries: [] }\n  }\n}\n\nfunction extractJson(content: string): string {\n  const start = content.indexOf(\"{\")\n  const end = content.lastIndexOf(\"}\")\n\n  if (start === -1 || end === -1 || end <= start) {\n    throw new Error(\"Respuesta sin objeto JSON valido\")\n  }\n\n  return content.slice(start, end + 1)\n}\n"],"mappings":"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","ignoreList":[]}