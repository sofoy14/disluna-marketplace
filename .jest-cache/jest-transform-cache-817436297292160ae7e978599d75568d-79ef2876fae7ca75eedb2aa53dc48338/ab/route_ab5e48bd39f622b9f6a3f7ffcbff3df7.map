{"version":3,"names":["cov_1dangmj74h","actualCoverage","exports","POST","server_1","s","require","openai_1","__importDefault","dynamic_search_orchestrator_1","openai","default","apiKey","process","env","OPENAI_API_KEY","request","f","query","model","b","options","json","NextResponse","error","status","console","log","searchResult","runDynamicSearchWorkflow","client","maxSearchRounds","maxSearchesPerRound","searchTimeoutMs","enableModelDecision","finalResponse","chat","completions","create","messages","role","content","finalContext","temperature","max_tokens","stream","response","choices","message","success","metadata","searchRounds","totalRounds","totalSearches","totalResults","finalQuality","modelDecisions","searchStrategy","durationMs","totalDurationMs","sources","allResults","map","result","title","url","type","quality","authority","details","Error"],"sources":["C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\app\\api\\tongyi\\dynamic-search\\route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\r\nimport OpenAI from \"openai\"\r\nimport { runDynamicSearchWorkflow } from \"@/lib/tools/dynamic-search-orchestrator\"\r\n\r\nconst openai = new OpenAI({\r\n  apiKey: process.env.OPENAI_API_KEY,\r\n})\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const { query, model = \"gpt-4o\", options = {} } = await request.json()\r\n\r\n    if (!query) {\r\n      return NextResponse.json(\r\n        { error: \"Query es requerida\" },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    console.log(`\\n游 INICIANDO B칔SQUEDA DIN츼MICA INTELIGENTE`)\r\n    console.log(`游닇 Query: \"${query}\"`)\r\n    console.log(`游뱄 Modelo: ${model}`)\r\n\r\n    // Ejecutar b칰squeda din치mica\r\n    const searchResult = await runDynamicSearchWorkflow(query, {\r\n      client: openai,\r\n      model,\r\n      maxSearchRounds: options.maxSearchRounds || 10,\r\n      maxSearchesPerRound: options.maxSearchesPerRound || 8,\r\n      searchTimeoutMs: options.searchTimeoutMs || 45000,\r\n      enableModelDecision: options.enableModelDecision !== false\r\n    })\r\n\r\n    // Generar respuesta final usando el contexto enriquecido\r\n    const finalResponse = await openai.chat.completions.create({\r\n      model,\r\n      messages: [\r\n        {\r\n          role: \"system\",\r\n          content: `Eres un asistente legal experto en derecho colombiano. Utiliza EXCLUSIVAMENTE la informaci칩n proporcionada en el contexto para responder la consulta del usuario. \r\n\r\nINSTRUCCIONES CR칈TICAS:\r\n- Usa SOLO la informaci칩n de las fuentes verificadas proporcionadas\r\n- Cita exactamente las fuentes con enlaces\r\n- Verifica la vigencia de las normas mencionadas\r\n- Si hay contradicciones, expl칤calas claramente\r\n- Admite cuando la informaci칩n sea insuficiente\r\n- Proporciona una respuesta completa y bien estructurada\r\n\r\nFORMATO DE RESPUESTA:\r\n1. Respuesta directa a la consulta\r\n2. Marco normativo aplicable\r\n3. Jurisprudencia relevante\r\n4. An치lisis integrado\r\n5. Conclusiones\r\n6. Fuentes verificadas con enlaces`\r\n        },\r\n        {\r\n          role: \"user\",\r\n          content: `${searchResult.finalContext}\\n\\nConsulta del usuario: \"${query}\"`\r\n        }\r\n      ],\r\n      temperature: 0.1,\r\n      max_tokens: 2000,\r\n      stream: false\r\n    })\r\n\r\n    const response = finalResponse.choices?.[0]?.message?.content || \"Error generando respuesta\"\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      query,\r\n      response,\r\n      metadata: {\r\n        searchRounds: searchResult.metadata.totalRounds,\r\n        totalSearches: searchResult.metadata.totalSearches,\r\n        totalResults: searchResult.metadata.totalResults,\r\n        finalQuality: searchResult.metadata.finalQuality,\r\n        modelDecisions: searchResult.metadata.modelDecisions,\r\n        searchStrategy: searchResult.metadata.searchStrategy,\r\n        durationMs: searchResult.metadata.totalDurationMs\r\n      },\r\n      sources: searchResult.allResults.map(result => ({\r\n        title: result.title,\r\n        url: result.url,\r\n        type: result.type,\r\n        quality: result.quality,\r\n        authority: result.authority\r\n      }))\r\n    })\r\n\r\n  } catch (error) {\r\n    console.error(\"Error en b칰squeda din치mica:\", error)\r\n    \r\n    return NextResponse.json(\r\n      { \r\n        error: \"Error interno del servidor\",\r\n        details: error instanceof Error ? error.message : \"Error desconocido\"\r\n      },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"mappings":"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","ignoreList":[]}