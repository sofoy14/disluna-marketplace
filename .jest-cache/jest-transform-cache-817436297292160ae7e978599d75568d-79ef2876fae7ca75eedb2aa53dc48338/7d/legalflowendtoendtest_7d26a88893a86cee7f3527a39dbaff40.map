{"file":"C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\__tests__\\integration\\legal-flow-end-to-end.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\__tests__\\integration\\legal-flow-end-to-end.test.ts"],"sourcesContent":["/**\r\n * Test End-to-End - Flujo Legal Completo\r\n * \r\n * Test de integración que verifica el flujo completo del asistente legal,\r\n * desde la consulta del usuario hasta la respuesta verificada.\r\n */\r\n\r\nimport { TongyiUnifiedLegalAgent } from '../../lib/agents/tongyi-unified-legal-agent'\r\nimport { ChatMemoryManager } from '../../lib/memory/chat-memory-manager'\r\nimport { AntiHallucinationSystem } from '../../lib/anti-hallucination/anti-hallucination-system'\r\nimport { ContinuousVerificationSystem } from '../../lib/verification/continuous-verification-system'\r\nimport OpenAI from 'openai'\r\n\r\n// Mocks globales\r\nconst mockOpenAIClient = {\r\n  chat: {\r\n    completions: {\r\n      create: jest.fn()\r\n    }\r\n  }\r\n}\r\n\r\nconst mockSupabaseClient = {\r\n  from: jest.fn(() => ({\r\n    select: jest.fn(() => ({\r\n      eq: jest.fn(() => ({\r\n        order: jest.fn(() => ({\r\n          limit: jest.fn(() => Promise.resolve({ data: [], error: null }))\r\n        }))\r\n      }))\r\n    })),\r\n    insert: jest.fn(() => Promise.resolve({ data: [], error: null })),\r\n    update: jest.fn(() => ({\r\n      eq: jest.fn(() => Promise.resolve({ data: [], error: null }))\r\n    })),\r\n    upsert: jest.fn(() => Promise.resolve({ data: [], error: null }))\r\n  }))\r\n}\r\n\r\njest.mock('openai', () => {\r\n  return jest.fn().mockImplementation(() => mockOpenAIClient)\r\n})\r\n\r\njest.mock('@supabase/supabase-js', () => ({\r\n  createClient: jest.fn(() => mockSupabaseClient)\r\n}))\r\n\r\ndescribe('Flujo Legal Completo - Test End-to-End', () => {\r\n  let legalAgent: TongyiUnifiedLegalAgent\r\n  let memoryManager: ChatMemoryManager\r\n  let antiHallucinationSystem: AntiHallucinationSystem\r\n  let verificationSystem: ContinuousVerificationSystem\r\n  const mockClient = new OpenAI({ apiKey: 'test-key' })\r\n\r\n  beforeEach(() => {\r\n    legalAgent = new TongyiUnifiedLegalAgent()\r\n    memoryManager = new ChatMemoryManager()\r\n    antiHallucinationSystem = new AntiHallucinationSystem(mockClient, 'gpt-4')\r\n    verificationSystem = new ContinuousVerificationSystem(mockClient, 'gpt-4')\r\n    jest.clearAllMocks()\r\n  })\r\n\r\n  describe('Flujo Completo - Consulta Simple', () => {\r\n    test('debe procesar consulta legal simple end-to-end', async () => {\r\n      const userQuery = '¿Cuáles son los requisitos para constituir una SAS en Colombia?'\r\n      const userId = 'test-user-123'\r\n      const chatId = 'test-chat-456'\r\n\r\n      // Mock de verificación pre-búsqueda\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isValid: true,\r\n              confidence: 0.95,\r\n              legalRelevance: 0.9,\r\n              complexity: 'medium',\r\n              recommendedSearchStrategy: 'iter_research',\r\n              potentialIssues: [],\r\n              suggestions: [\r\n                'Buscar información sobre Código de Comercio',\r\n                'Consultar normativa de DIAN',\r\n                'Verificar requisitos de capital mínimo'\r\n              ]\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      // Mock de búsqueda legal (simulado)\r\n      const mockSearchResults = [\r\n        {\r\n          title: 'Código de Comercio - Artículo 110',\r\n          url: 'https://www.suin-juriscol.gov.co/viewDocument.asp?ruta=Leyes/1689347',\r\n          snippet: 'Para constituir una sociedad por acciones simplificada se requiere un capital mínimo de $1,000,000...',\r\n          type: 'official' as const,\r\n          quality: 9,\r\n          authority: 'maxima' as const\r\n        },\r\n        {\r\n          title: 'DIAN - Requisitos Tributarios SAS',\r\n          url: 'https://www.dian.gov.co/requisitos-sas',\r\n          snippet: 'Requisitos tributarios para constitución de SAS...',\r\n          type: 'official' as const,\r\n          quality: 8,\r\n          authority: 'maxima' as const\r\n        }\r\n      ]\r\n\r\n      // Mock de verificación durante búsqueda\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isValid: true,\r\n              confidence: 0.9,\r\n              qualityScore: 0.85,\r\n              sourceEvaluation: {\r\n                official: {\r\n                  count: 2,\r\n                  averageQuality: 8.5,\r\n                  relevance: 0.9\r\n                }\r\n              },\r\n              recommendations: [\r\n                'Fuentes oficiales de alta calidad encontradas',\r\n                'Información suficiente para responder'\r\n              ],\r\n              issues: []\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      // Mock de verificación post-búsqueda\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isSufficient: true,\r\n              confidence: 0.9,\r\n              completenessScore: 0.85,\r\n              qualityScore: 0.9,\r\n              coverage: {\r\n                legal: 0.9,\r\n                procedural: 0.8,\r\n                practical: 0.7\r\n              },\r\n              missingInfo: [],\r\n              recommendations: [\r\n                'Información suficiente para responder',\r\n                'Fuentes oficiales de alta calidad'\r\n              ]\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      // Mock de generación de respuesta\r\n      const mockResponse = 'Para constituir una SAS en Colombia se requiere: 1) Capital mínimo de $1,000,000 según el Artículo 110 del Código de Comercio, 2) Mínimo 1 socio, 3) Documentos constitutivos, 4) Registro en Cámara de Comercio, 5) Inscripción en DIAN para efectos tributarios.'\r\n\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: mockResponse\r\n          }\r\n        }]\r\n      })\r\n\r\n      // Mock de verificación pre-síntesis\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isValid: true,\r\n              confidence: 0.95,\r\n              accuracyScore: 0.9,\r\n              completenessScore: 0.85,\r\n              sourceAlignment: 0.95,\r\n              issues: [],\r\n              recommendations: [\r\n                'Respuesta bien fundamentada',\r\n                'Información precisa y completa'\r\n              ]\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      // Mock de verificación post-síntesis\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isValid: true,\r\n              confidence: 0.95,\r\n              finalScore: 0.9,\r\n              qualityMetrics: {\r\n                accuracy: 0.95,\r\n                completeness: 0.9,\r\n                clarity: 0.85,\r\n                legalCompliance: 0.95\r\n              },\r\n              verificationChecks: {\r\n                sourceAlignment: true,\r\n                legalAccuracy: true,\r\n                completeness: true,\r\n                clarity: true\r\n              },\r\n              recommendations: [\r\n                'Respuesta de alta calidad',\r\n                'Bien fundamentada en fuentes oficiales'\r\n              ],\r\n              warnings: []\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      // Mock de verificación anti-alucinación\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isAccurate: true,\r\n              confidence: 0.95,\r\n              supportedClaims: [\r\n                'Capital mínimo de $1,000,000 está respaldado por Artículo 110',\r\n                'Requisitos de documentos están en Código de Comercio',\r\n                'Registro en Cámara de Comercio es obligatorio'\r\n              ],\r\n              unsupportedClaims: [],\r\n              sourceValidation: {\r\n                articulo110: {\r\n                  found: true,\r\n                  relevance: 0.95,\r\n                  accuracy: 0.95\r\n                }\r\n              },\r\n              recommendations: ['La información está bien respaldada por fuentes oficiales']\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      // Ejecutar flujo completo\r\n      const result = await legalAgent.processLegalQuery({\r\n        query: userQuery,\r\n        userId,\r\n        chatId,\r\n        context: {\r\n          conversationHistory: [],\r\n          userPreferences: {\r\n            preferredSearchStrategy: 'AGENTE_UNIFICADO_TONGYI',\r\n            maxSearchRounds: 5,\r\n            enableModelDecision: true\r\n          }\r\n        }\r\n      })\r\n\r\n      // Verificaciones del resultado\r\n      expect(result.success).toBe(true)\r\n      expect(result.response).toContain('Capital mínimo de $1,000,000')\r\n      expect(result.response).toContain('Artículo 110 del Código de Comercio')\r\n      expect(result.sources).toHaveLength(2)\r\n      expect(result.sources[0].type).toBe('official')\r\n      expect(result.sources[0].authority).toBe('maxima')\r\n      expect(result.quality).toBeGreaterThan(0.8)\r\n      expect(result.verification.passed).toBe(true)\r\n      expect(result.verification.confidence).toBeGreaterThan(0.9)\r\n\r\n      // Verificar que se registró en memoria\r\n      expect(mockSupabaseClient.from).toHaveBeenCalledWith('messages')\r\n      expect(mockSupabaseClient.from).toHaveBeenCalledWith('chat_contexts')\r\n    })\r\n  })\r\n\r\n  describe('Flujo Completo - Consulta Compleja', () => {\r\n    test('debe procesar consulta legal compleja con múltiples rondas de investigación', async () => {\r\n      const userQuery = '¿Cómo estructurar una fusión entre una SAS colombiana y una LLC estadounidense considerando tratados de doble tributación?'\r\n      const userId = 'test-user-complex'\r\n      const chatId = 'test-chat-complex'\r\n\r\n      // Mock de verificación pre-búsqueda (consulta compleja)\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isValid: true,\r\n              confidence: 0.9,\r\n              legalRelevance: 0.95,\r\n              complexity: 'high',\r\n              recommendedSearchStrategy: 'iter_research',\r\n              potentialIssues: [\r\n                'Consulta muy compleja',\r\n                'Requiere múltiples áreas de derecho',\r\n                'Necesita fuentes especializadas'\r\n              ],\r\n              suggestions: [\r\n                'Buscar normativa de fusiones internacionales',\r\n                'Consultar tratados de doble tributación',\r\n                'Verificar regulaciones de inversión extranjera',\r\n                'Considerar consulta legal profesional'\r\n              ]\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      // Mock de primera ronda de búsqueda\r\n      const mockSearchResults1 = [\r\n        {\r\n          title: 'Ley 1607 de 2012 - Reforma Tributaria',\r\n          url: 'https://www.suin-juriscol.gov.co',\r\n          snippet: 'Normativa sobre fusiones internacionales...',\r\n          type: 'official' as const,\r\n          quality: 8,\r\n          authority: 'maxima' as const\r\n        }\r\n      ]\r\n\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isValid: true,\r\n              confidence: 0.7,\r\n              qualityScore: 0.6,\r\n              sourceEvaluation: {\r\n                official: {\r\n                  count: 1,\r\n                  averageQuality: 8,\r\n                  relevance: 0.7\r\n                }\r\n              },\r\n              recommendations: [\r\n                'Buscar más información sobre tratados de doble tributación',\r\n                'Consultar normativa específica de LLC'\r\n              ],\r\n              issues: [\r\n                'Información parcial sobre fusión internacional'\r\n              ]\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      // Mock de segunda ronda de búsqueda\r\n      const mockSearchResults2 = [\r\n        {\r\n          title: 'Tratado de Doble Tributación Colombia-EE.UU.',\r\n          url: 'https://www.dian.gov.co/tratados',\r\n          snippet: 'Convenio para evitar doble tributación...',\r\n          type: 'official' as const,\r\n          quality: 9,\r\n          authority: 'maxima' as const\r\n        },\r\n        {\r\n          title: 'Regulaciones de Inversión Extranjera',\r\n          url: 'https://www.mincomercio.gov.co',\r\n          snippet: 'Normativa sobre inversión extranjera...',\r\n          type: 'official' as const,\r\n          quality: 8,\r\n          authority: 'maxima' as const\r\n        }\r\n      ]\r\n\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isValid: true,\r\n              confidence: 0.9,\r\n              qualityScore: 0.85,\r\n              sourceEvaluation: {\r\n                official: {\r\n                  count: 3,\r\n                  averageQuality: 8.3,\r\n                  relevance: 0.9\r\n                }\r\n              },\r\n              recommendations: [\r\n                'Información suficiente encontrada',\r\n                'Fuentes oficiales de alta calidad'\r\n              ],\r\n              issues: []\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      // Mock de verificación post-búsqueda\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isSufficient: true,\r\n              confidence: 0.85,\r\n              completenessScore: 0.8,\r\n              qualityScore: 0.85,\r\n              coverage: {\r\n                legal: 0.85,\r\n                procedural: 0.7,\r\n                practical: 0.6\r\n              },\r\n              missingInfo: [\r\n                'Procedimientos específicos de registro'\r\n              ],\r\n              recommendations: [\r\n                'Información suficiente para respuesta general',\r\n                'Se recomienda consulta legal profesional para detalles específicos'\r\n              ]\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      // Mock de generación de respuesta compleja\r\n      const mockComplexResponse = 'Para estructurar una fusión entre una SAS colombiana y una LLC estadounidense: 1) Cumplir con Ley 1607 de 2012 sobre fusiones internacionales, 2) Aplicar Tratado de Doble Tributación Colombia-EE.UU., 3) Cumplir regulaciones de inversión extranjera, 4) Procedimientos de registro en ambas jurisdicciones. NOTA: Este es un proceso complejo que requiere asesoría legal especializada.'\r\n\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: mockComplexResponse\r\n          }\r\n        }]\r\n      })\r\n\r\n      // Mock de verificación pre-síntesis\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isValid: true,\r\n              confidence: 0.9,\r\n              accuracyScore: 0.85,\r\n              completenessScore: 0.8,\r\n              sourceAlignment: 0.9,\r\n              issues: [],\r\n              recommendations: [\r\n                'Respuesta apropiada para consulta compleja',\r\n                'Incluye advertencia sobre consulta profesional'\r\n              ]\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      // Mock de verificación post-síntesis\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isValid: true,\r\n              confidence: 0.9,\r\n              finalScore: 0.85,\r\n              qualityMetrics: {\r\n                accuracy: 0.9,\r\n                completeness: 0.8,\r\n                clarity: 0.85,\r\n                legalCompliance: 0.9\r\n              },\r\n              verificationChecks: {\r\n                sourceAlignment: true,\r\n                legalAccuracy: true,\r\n                completeness: true,\r\n                clarity: true\r\n              },\r\n              recommendations: [\r\n                'Respuesta apropiada para consulta compleja',\r\n                'Bien fundamentada en fuentes oficiales'\r\n              ],\r\n              warnings: [\r\n                'Consulta compleja - se recomienda asesoría profesional'\r\n              ]\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      // Mock de verificación anti-alucinación\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isAccurate: true,\r\n              confidence: 0.9,\r\n              supportedClaims: [\r\n                'Ley 1607 de 2012 regula fusiones internacionales',\r\n                'Tratado de Doble Tributación existe',\r\n                'Regulaciones de inversión extranjera aplican'\r\n              ],\r\n              unsupportedClaims: [],\r\n              sourceValidation: {\r\n                ley1607: {\r\n                  found: true,\r\n                  relevance: 0.9,\r\n                  accuracy: 0.9\r\n                },\r\n                tratadoDobleTributacion: {\r\n                  found: true,\r\n                  relevance: 0.95,\r\n                  accuracy: 0.95\r\n                }\r\n              },\r\n              recommendations: [\r\n                'Información respaldada por fuentes oficiales',\r\n                'Advertencia sobre consulta profesional es apropiada'\r\n              ]\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      // Ejecutar flujo completo\r\n      const result = await legalAgent.processLegalQuery({\r\n        query: userQuery,\r\n        userId,\r\n        chatId,\r\n        context: {\r\n          conversationHistory: [],\r\n          userPreferences: {\r\n            preferredSearchStrategy: 'AGENTE_UNIFICADO_TONGYI',\r\n            maxSearchRounds: 8,\r\n            enableModelDecision: true\r\n          }\r\n        }\r\n      })\r\n\r\n      // Verificaciones del resultado\r\n      expect(result.success).toBe(true)\r\n      expect(result.response).toContain('Ley 1607 de 2012')\r\n      expect(result.response).toContain('Tratado de Doble Tributación')\r\n      expect(result.response).toContain('asesoría legal especializada')\r\n      expect(result.sources).toHaveLength(3)\r\n      expect(result.quality).toBeGreaterThan(0.8)\r\n      expect(result.verification.passed).toBe(true)\r\n      expect(result.warnings).toContain('Consulta compleja - se recomienda asesoría profesional')\r\n    })\r\n  })\r\n\r\n  describe('Flujo Completo - Manejo de Errores', () => {\r\n    test('debe manejar errores en el flujo completo gracefully', async () => {\r\n      const userQuery = '¿Cuáles son los requisitos para constituir una SAS?'\r\n      const userId = 'test-user-error'\r\n      const chatId = 'test-chat-error'\r\n\r\n      // Mock de error en verificación pre-búsqueda\r\n      mockOpenAIClient.chat.completions.create.mockRejectedValueOnce(\r\n        new Error('API timeout')\r\n      )\r\n\r\n      // Ejecutar flujo con error\r\n      const result = await legalAgent.processLegalQuery({\r\n        query: userQuery,\r\n        userId,\r\n        chatId,\r\n        context: {\r\n          conversationHistory: [],\r\n          userPreferences: {\r\n            preferredSearchStrategy: 'AGENTE_UNIFICADO_TONGYI',\r\n            maxSearchRounds: 5,\r\n            enableModelDecision: true\r\n          }\r\n        }\r\n      })\r\n\r\n      // Verificar manejo graceful del error\r\n      expect(result.success).toBe(false)\r\n      expect(result.error).toContain('Error en el procesamiento')\r\n      expect(result.response).toContain('Lo siento, hubo un error')\r\n    })\r\n  })\r\n\r\n  describe('Cumplimiento Legal - Trazabilidad Completa', () => {\r\n    test('debe mantener trazabilidad completa para auditoría', async () => {\r\n      const userQuery = '¿Cuáles son los requisitos para constituir una SAS?'\r\n      const userId = 'audit-user'\r\n      const chatId = 'audit-chat'\r\n\r\n      // Mock completo del flujo\r\n      mockOpenAIClient.chat.completions.create\r\n        .mockResolvedValueOnce({ choices: [{ message: { content: JSON.stringify({ isValid: true, confidence: 0.9 }) } }] })\r\n        .mockResolvedValueOnce({ choices: [{ message: { content: JSON.stringify({ isValid: true, qualityScore: 0.8 }) } }] })\r\n        .mockResolvedValueOnce({ choices: [{ message: { content: JSON.stringify({ isSufficient: true, confidence: 0.9 }) } }] })\r\n        .mockResolvedValueOnce({ choices: [{ message: { content: 'Respuesta legal completa' } }] })\r\n        .mockResolvedValueOnce({ choices: [{ message: { content: JSON.stringify({ isValid: true, confidence: 0.9 }) } }] })\r\n        .mockResolvedValueOnce({ choices: [{ message: { content: JSON.stringify({ isValid: true, finalScore: 0.9 }) } }] })\r\n        .mockResolvedValueOnce({ choices: [{ message: { content: JSON.stringify({ isAccurate: true, confidence: 0.9 }) } }] })\r\n\r\n      const result = await legalAgent.processLegalQuery({\r\n        query: userQuery,\r\n        userId,\r\n        chatId,\r\n        context: {\r\n          conversationHistory: [],\r\n          userPreferences: {\r\n            preferredSearchStrategy: 'AGENTE_UNIFICADO_TONGYI',\r\n            maxSearchRounds: 5,\r\n            enableModelDecision: true\r\n          }\r\n        }\r\n      })\r\n\r\n      // Verificar que se registró toda la información para auditoría\r\n      expect(mockSupabaseClient.from).toHaveBeenCalledWith('messages')\r\n      expect(mockSupabaseClient.from).toHaveBeenCalledWith('chat_contexts')\r\n      \r\n      // Verificar que el resultado incluye información de auditoría\r\n      expect(result.timestamp).toBeInstanceOf(Date)\r\n      expect(result.queryHash).toBeDefined()\r\n      expect(result.responseHash).toBeDefined()\r\n      expect(result.verification).toBeDefined()\r\n      expect(result.sources).toBeDefined()\r\n    })\r\n  })\r\n})\r\n"],"version":3}