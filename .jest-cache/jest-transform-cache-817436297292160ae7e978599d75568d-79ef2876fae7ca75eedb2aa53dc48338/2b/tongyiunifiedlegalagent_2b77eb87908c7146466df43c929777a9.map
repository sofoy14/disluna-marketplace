{"file":"C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\lib\\agents\\tongyi-unified-legal-agent.ts","mappings":"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","names":[],"sources":["C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\lib\\agents\\tongyi-unified-legal-agent.ts"],"sourcesContent":["/**\r\n * Agente Unificado Tongyi para Asistente Legal\r\n * Versi√≥n simplificada que integra todos los sistemas existentes\r\n */\r\n\r\nimport OpenAI from \"openai\"\r\nimport { ChatMemoryManager } from \"@/lib/memory/chat-memory-manager\"\r\nimport { AntiHallucinationSystem } from \"@/lib/anti-hallucination/anti-hallucination-system\"\r\nimport { UnifiedDeepResearchOrchestrator, UnifiedResearchConfig, UnifiedResearchResult } from \"@/lib/tongyi/unified-deep-research-orchestrator\"\r\n\r\nexport interface UnifiedLegalAgentConfig extends Partial<UnifiedResearchConfig> {\r\n  enableMemory?: boolean\r\n  enableAntiHallucination?: boolean\r\n  preferredSources?: string[]\r\n}\r\n\r\nexport class TongyiUnifiedLegalAgent {\r\n  private client: OpenAI\r\n  private memoryManager: ChatMemoryManager\r\n  private antiHallucinationSystem: AntiHallucinationSystem\r\n  private unifiedOrchestrator: UnifiedDeepResearchOrchestrator\r\n  private config: UnifiedLegalAgentConfig\r\n  private modelName: string = 'alibaba/tongyi-deepresearch-30b-a3b'\r\n\r\n  constructor(apiKey: string, config: UnifiedLegalAgentConfig = {}) {\r\n    this.config = {\r\n      enableMemory: true,\r\n      enableAntiHallucination: true,\r\n      enableContinuousVerification: true,\r\n      legalDomain: 'colombia',\r\n      qualityThreshold: 0.85,\r\n      modelName: this.modelName,\r\n      apiKey: apiKey,\r\n      ...config\r\n    }\r\n\r\n    this.client = new OpenAI({\r\n      apiKey,\r\n      baseURL: \"https://openrouter.ai/api/v1\"\r\n    })\r\n    this.memoryManager = ChatMemoryManager.getInstance()\r\n    this.antiHallucinationSystem = new AntiHallucinationSystem(apiKey)\r\n    this.unifiedOrchestrator = new UnifiedDeepResearchOrchestrator(this.config as UnifiedResearchConfig)\r\n  }\r\n\r\n  public async processLegalQuery(\r\n    userQuery: string,\r\n    chatId: string,\r\n    userId: string,\r\n  ): Promise<UnifiedResearchResult> {\r\n    console.log(`üöÄ TongyiUnifiedLegalAgent: Procesando consulta legal para Chat ID: ${chatId}, User ID: ${userId}`)\r\n    \r\n    try {\r\n      // 1. Build Context (from memory)\r\n      const chatContext = this.config.enableMemory\r\n        ? await this.memoryManager.getChatContext(chatId, userId)\r\n        : { currentContext: \"\", relevantHistory: [] }\r\n\r\n      console.log(`üèóÔ∏è [Agent Context] Construyendo contexto para chat ${chatId}`)\r\n      console.log(`üìä [Agent Context] Contexto construido:`)\r\n      console.log(`   üí¨ Mensajes: ${chatContext.conversationHistory?.length || 0}`)\r\n      console.log(`   üìÑ Fuentes cacheadas: ${chatContext.cachedSources?.length || 0}`)\r\n      console.log(`   üìà Calidad promedio: ${chatContext.qualityMetrics?.averageQuality?.toFixed(2) || '0.80'}`)\r\n      console.log(`   üîç Consultas anteriores: ${chatContext.searchHistory?.length || 0}`)\r\n\r\n      // 2. Orchestrate Deep Research\r\n      const researchResult = await this.unifiedOrchestrator.orchestrate(\r\n        userQuery,\r\n        chatId,\r\n        userId,\r\n        {\r\n          mode: this.config.mode,\r\n          maxRounds: this.config.maxRounds,\r\n          maxSearchesPerRound: this.config.maxSearchesPerRound,\r\n          enableContinuousVerification: this.config.enableContinuousVerification,\r\n          enableIterativeRefinement: this.config.enableIterativeRefinement,\r\n          legalDomain: this.config.legalDomain,\r\n          qualityThreshold: this.config.qualityThreshold,\r\n          modelName: this.modelName,\r\n          apiKey: this.config.apiKey,\r\n        }\r\n      )\r\n\r\n      console.log(`‚úÖ TongyiUnifiedLegalAgent: Investigaci√≥n completada.`)\r\n      return researchResult\r\n\r\n    } catch (error) {\r\n      console.error(`‚ùå Error en TongyiUnifiedLegalAgent:`, error)\r\n      \r\n      // Return error result\r\n      return {\r\n        finalAnswer: `Disculpe, hubo un error procesando su consulta: ${error.message}`,\r\n        sources: [],\r\n        analysis: {\r\n          researchMode: 'react',\r\n          complexity: 'simple',\r\n          qualityScore: 0.1,\r\n          confidence: 0.1,\r\n          verificationPassed: false,\r\n          processingTime: 0,\r\n        },\r\n        recommendations: [],\r\n        warnings: [`Error cr√≠tico: ${error.message}`],\r\n        metadata: {\r\n          totalRounds: 0,\r\n          totalSearches: 0,\r\n          totalSources: 0,\r\n          toolsUsed: [],\r\n          memoryUsed: false,\r\n          contextRetrieved: false,\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport function createTongyiUnifiedLegalAgent(apiKey: string, config?: UnifiedLegalAgentConfig): TongyiUnifiedLegalAgent {\r\n  return new TongyiUnifiedLegalAgent(apiKey, config)\r\n}"],"version":3}