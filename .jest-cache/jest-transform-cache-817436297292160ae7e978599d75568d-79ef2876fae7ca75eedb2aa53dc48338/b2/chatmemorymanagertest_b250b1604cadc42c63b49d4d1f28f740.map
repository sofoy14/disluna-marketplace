{"file":"C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\__tests__\\lib\\memory\\chat-memory-manager.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\__tests__\\lib\\memory\\chat-memory-manager.test.ts"],"sourcesContent":["/**\r\n * Tests de Regresión - ChatMemoryManager\r\n * \r\n * Tests críticos para asegurar que el sistema de memoria funciona correctamente\r\n * después de la refactorización, cumpliendo con requisitos de auditoría legal.\r\n */\r\n\r\nimport { ChatMemoryManager } from '../../lib/memory/chat-memory-manager'\r\nimport { createClient } from '@supabase/supabase-js'\r\n\r\n// Mock de Supabase para tests\r\nconst mockSupabaseClient = {\r\n  from: jest.fn(() => ({\r\n    select: jest.fn(() => ({\r\n      eq: jest.fn(() => ({\r\n        order: jest.fn(() => ({\r\n          limit: jest.fn(() => Promise.resolve({ data: [], error: null }))\r\n        }))\r\n      }))\r\n    })),\r\n    insert: jest.fn(() => Promise.resolve({ data: [], error: null })),\r\n    update: jest.fn(() => ({\r\n      eq: jest.fn(() => Promise.resolve({ data: [], error: null }))\r\n    })),\r\n    upsert: jest.fn(() => Promise.resolve({ data: [], error: null }))\r\n  }))\r\n}\r\n\r\n// Mock del cliente Supabase\r\njest.mock('@supabase/supabase-js', () => ({\r\n  createClient: jest.fn(() => mockSupabaseClient)\r\n}))\r\n\r\ndescribe('ChatMemoryManager - Tests de Regresión', () => {\r\n  let memoryManager: ChatMemoryManager\r\n  const testUserId = 'test-user-123'\r\n  const testChatId = 'test-chat-456'\r\n\r\n  beforeEach(() => {\r\n    memoryManager = new ChatMemoryManager()\r\n    jest.clearAllMocks()\r\n  })\r\n\r\n  describe('Trazabilidad Completa', () => {\r\n    test('debe registrar consulta del usuario correctamente', async () => {\r\n      const userQuery = '¿Cuáles son los requisitos para constituir una empresa en Colombia?'\r\n      \r\n      await memoryManager.addMessage(testChatId, testUserId, {\r\n        role: 'user',\r\n        content: userQuery,\r\n        timestamp: new Date()\r\n      })\r\n\r\n      // Verificar que se llamó insert con los datos correctos\r\n      expect(mockSupabaseClient.from).toHaveBeenCalledWith('messages')\r\n      expect(mockSupabaseClient.from().insert).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          chat_id: testChatId,\r\n          user_id: testUserId,\r\n          role: 'user',\r\n          content: userQuery\r\n        })\r\n      )\r\n    })\r\n\r\n    test('debe registrar respuesta del asistente con fuentes', async () => {\r\n      const assistantResponse = 'Para constituir una empresa en Colombia se requiere...'\r\n      const sources = [\r\n        {\r\n          title: 'Código de Comercio - Artículo 110',\r\n          url: 'https://www.suin-juriscol.gov.co/viewDocument.asp?ruta=Leyes/1689347',\r\n          type: 'official',\r\n          quality: 9\r\n        }\r\n      ]\r\n\r\n      await memoryManager.addMessage(testChatId, testUserId, {\r\n        role: 'assistant',\r\n        content: assistantResponse,\r\n        timestamp: new Date(),\r\n        metadata: {\r\n          sources,\r\n          quality: 8.5,\r\n          verification: { passed: true, confidence: 0.9 },\r\n          mode: 'iter_research'\r\n        }\r\n      })\r\n\r\n      // Verificar que se registraron las fuentes\r\n      expect(mockSupabaseClient.from().insert).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          metadata: expect.objectContaining({\r\n            sources,\r\n            quality: 8.5,\r\n            verification: { passed: true, confidence: 0.9 },\r\n            mode: 'iter_research'\r\n          })\r\n        })\r\n      )\r\n    })\r\n\r\n    test('debe registrar búsquedas realizadas', async () => {\r\n      const searchQuery = 'constitución empresa Colombia requisitos'\r\n      const searchResults = [\r\n        {\r\n          title: 'Constitución de Empresas - DIAN',\r\n          url: 'https://www.dian.gov.co',\r\n          type: 'official',\r\n          quality: 8\r\n        }\r\n      ]\r\n\r\n      await memoryManager.addSearchHistory(testChatId, testUserId, {\r\n        query: searchQuery,\r\n        results: searchResults,\r\n        mode: 'legal_search',\r\n        quality: 8,\r\n        duration: 1500\r\n      })\r\n\r\n      // Verificar que se registró la búsqueda\r\n      expect(mockSupabaseClient.from).toHaveBeenCalledWith('chat_contexts')\r\n      expect(mockSupabaseClient.from().upsert).toHaveBeenCalled()\r\n    })\r\n  })\r\n\r\n  describe('Cache de Fuentes', () => {\r\n    test('debe cachear fuentes verificadas con TTL correcto', async () => {\r\n      const source = {\r\n        url: 'https://www.corteconstitucional.gov.co/relatoria/2024/',\r\n        title: 'Sentencia T-123 de 2024',\r\n        content: 'Contenido de la sentencia...',\r\n        type: 'official' as const,\r\n        quality: 9,\r\n        authority: 'maxima' as const\r\n      }\r\n\r\n      await memoryManager.cacheSource(testChatId, testUserId, source)\r\n\r\n      // Verificar que se cacheó con TTL de 24 horas\r\n      const expectedExpiry = new Date(Date.now() + 24 * 60 * 60 * 1000)\r\n      expect(mockSupabaseClient.from().upsert).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          cached_sources: expect.arrayContaining([\r\n            expect.objectContaining({\r\n              ...source,\r\n              cachedAt: expect.any(Date),\r\n              expiresAt: expect.any(Date)\r\n            })\r\n          ])\r\n        })\r\n      )\r\n    })\r\n\r\n    test('debe recuperar fuentes cacheadas válidas', async () => {\r\n      const cachedSource = {\r\n        url: 'https://www.suin-juriscol.gov.co',\r\n        title: 'Código de Comercio',\r\n        content: 'Contenido del código...',\r\n        type: 'official' as const,\r\n        quality: 9,\r\n        authority: 'maxima' as const,\r\n        cachedAt: new Date(Date.now() - 1000), // 1 segundo atrás\r\n        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24 horas en el futuro\r\n      }\r\n\r\n      // Mock de respuesta con fuente cacheada\r\n      mockSupabaseClient.from().select().eq().order().limit.mockResolvedValueOnce({\r\n        data: [{\r\n          cached_sources: [cachedSource]\r\n        }],\r\n        error: null\r\n      })\r\n\r\n      const sources = await memoryManager.getCachedSources(testChatId, testUserId)\r\n\r\n      expect(sources).toHaveLength(1)\r\n      expect(sources[0]).toEqual(cachedSource)\r\n    })\r\n\r\n    test('debe excluir fuentes cacheadas expiradas', async () => {\r\n      const expiredSource = {\r\n        url: 'https://www.example.com',\r\n        title: 'Fuente Expirada',\r\n        content: 'Contenido...',\r\n        type: 'general' as const,\r\n        quality: 5,\r\n        authority: 'baja' as const,\r\n        cachedAt: new Date(Date.now() - 25 * 60 * 60 * 1000), // 25 horas atrás\r\n        expiresAt: new Date(Date.now() - 60 * 60 * 1000) // 1 hora atrás (expirada)\r\n      }\r\n\r\n      // Mock de respuesta con fuente expirada\r\n      mockSupabaseClient.from().select().eq().order().limit.mockResolvedValueOnce({\r\n        data: [{\r\n          cached_sources: [expiredSource]\r\n        }],\r\n        error: null\r\n      })\r\n\r\n      const sources = await memoryManager.getCachedSources(testChatId, testUserId)\r\n\r\n      expect(sources).toHaveLength(0)\r\n    })\r\n  })\r\n\r\n  describe('Métricas de Calidad', () => {\r\n    test('debe calcular métricas de calidad correctamente', async () => {\r\n      const mockContexts = [\r\n        {\r\n          quality_metrics: {\r\n            totalQueries: 10,\r\n            averageQuality: 8.5,\r\n            modePerformance: {\r\n              react: { count: 3, avgQuality: 8.0, avgTime: 2000 },\r\n              iter_research: { count: 5, avgQuality: 9.0, avgTime: 5000 },\r\n              hybrid: { count: 2, avgQuality: 8.5, avgTime: 3500 }\r\n            },\r\n            verificationStats: {\r\n              totalVerifications: 10,\r\n              passedVerifications: 9,\r\n              averageConfidence: 0.9,\r\n              successRate: 0.9\r\n            }\r\n          },\r\n          search_history: [],\r\n          created_at: new Date().toISOString()\r\n        }\r\n      ]\r\n\r\n      mockSupabaseClient.from().select().eq.mockResolvedValueOnce({\r\n        data: mockContexts,\r\n        error: null\r\n      })\r\n\r\n      const metrics = await memoryManager.getQualityMetrics(testUserId)\r\n\r\n      expect(metrics.totalQueries).toBe(10)\r\n      expect(metrics.averageQuality).toBe(8.5)\r\n      expect(metrics.modePerformance.iter_research.count).toBe(5)\r\n      expect(metrics.verificationStats.successRate).toBe(0.9)\r\n      expect(metrics.topPerformingMode).toBe('iter_research')\r\n    })\r\n\r\n    test('debe generar recomendaciones basadas en métricas', async () => {\r\n      const mockContexts = [\r\n        {\r\n          quality_metrics: {\r\n            totalQueries: 5,\r\n            averageQuality: 6.0, // Calidad baja\r\n            modePerformance: {\r\n              react: { count: 2, avgQuality: 5.0, avgTime: 1500 },\r\n              iter_research: { count: 2, avgQuality: 7.0, avgTime: 4000 },\r\n              hybrid: { count: 1, avgQuality: 6.0, avgTime: 3000 }\r\n            },\r\n            verificationStats: {\r\n              totalVerifications: 5,\r\n              passedVerifications: 3, // Tasa baja\r\n              averageConfidence: 0.6,\r\n              successRate: 0.6\r\n            }\r\n          },\r\n          search_history: [],\r\n          created_at: new Date().toISOString()\r\n        }\r\n      ]\r\n\r\n      mockSupabaseClient.from().select().eq.mockResolvedValueOnce({\r\n        data: mockContexts,\r\n        error: null\r\n      })\r\n\r\n      const metrics = await memoryManager.getQualityMetrics(testUserId)\r\n\r\n      expect(metrics.recommendations).toContain(\r\n        expect.stringContaining('mejorar calidad')\r\n      )\r\n      expect(metrics.recommendations).toContain(\r\n        expect.stringContaining('verificación')\r\n      )\r\n    })\r\n  })\r\n\r\n  describe('Construcción de Contexto', () => {\r\n    test('debe construir contexto actual correctamente', async () => {\r\n      const mockMessages = [\r\n        {\r\n          role: 'user',\r\n          content: 'Consulta sobre constitución de empresa',\r\n          timestamp: new Date().toISOString()\r\n        },\r\n        {\r\n          role: 'assistant',\r\n          content: 'Respuesta sobre constitución...',\r\n          timestamp: new Date().toISOString(),\r\n          metadata: {\r\n            sources: [{ title: 'Fuente 1', url: 'https://example.com' }],\r\n            quality: 8\r\n          }\r\n        }\r\n      ]\r\n\r\n      const mockContext = {\r\n        chatId: testChatId,\r\n        userId: testUserId,\r\n        conversationHistory: mockMessages,\r\n        searchHistory: [],\r\n        cachedSources: [],\r\n        userPreferences: {\r\n          preferredSearchStrategy: 'AGENTE_UNIFICADO_TONGYI',\r\n          maxSearchRounds: 8,\r\n          enableModelDecision: true\r\n        },\r\n        qualityMetrics: {\r\n          totalQueries: 1,\r\n          averageQuality: 8,\r\n          modePerformance: {\r\n            react: { count: 0, avgQuality: 0, avgTime: 0 },\r\n            iter_research: { count: 1, avgQuality: 8, avgTime: 3000 },\r\n            hybrid: { count: 0, avgQuality: 0, avgTime: 0 }\r\n          },\r\n          verificationStats: {\r\n            totalVerifications: 1,\r\n            passedVerifications: 1,\r\n            averageConfidence: 0.9,\r\n            successRate: 1.0\r\n          }\r\n        }\r\n      }\r\n\r\n      mockSupabaseClient.from().select().eq().order().limit.mockResolvedValueOnce({\r\n        data: mockMessages,\r\n        error: null\r\n      })\r\n\r\n      mockSupabaseClient.from().select().eq.mockResolvedValueOnce({\r\n        data: [mockContext],\r\n        error: null\r\n      })\r\n\r\n      const context = await memoryManager.getChatContext(testChatId, testUserId)\r\n\r\n      expect(context.conversationHistory).toHaveLength(2)\r\n      expect(context.currentContext).toContain('Consulta sobre constitución')\r\n      expect(context.currentContext).toContain('Respuesta sobre constitución')\r\n    })\r\n  })\r\n\r\n  describe('Manejo de Errores', () => {\r\n    test('debe manejar errores de base de datos gracefully', async () => {\r\n      mockSupabaseClient.from().insert.mockResolvedValueOnce({\r\n        data: null,\r\n        error: { message: 'Database connection failed' }\r\n      })\r\n\r\n      // No debe lanzar excepción\r\n      await expect(\r\n        memoryManager.addMessage(testChatId, testUserId, {\r\n          role: 'user',\r\n          content: 'Test message',\r\n          timestamp: new Date()\r\n        })\r\n      ).resolves.not.toThrow()\r\n    })\r\n\r\n    test('debe retornar métricas por defecto en caso de error', async () => {\r\n      mockSupabaseClient.from().select().eq.mockResolvedValueOnce({\r\n        data: null,\r\n        error: { message: 'Query failed' }\r\n      })\r\n\r\n      const metrics = await memoryManager.getQualityMetrics(testUserId)\r\n\r\n      expect(metrics.totalQueries).toBe(0)\r\n      expect(metrics.averageQuality).toBe(0)\r\n      expect(metrics.topPerformingMode).toBe('react')\r\n    })\r\n  })\r\n\r\n  describe('Cumplimiento Legal', () => {\r\n    test('debe registrar información suficiente para auditoría', async () => {\r\n      const auditData = {\r\n        query: 'Consulta legal específica',\r\n        response: 'Respuesta legal detallada',\r\n        sources: [\r\n          {\r\n            title: 'Ley 123 de 2024',\r\n            url: 'https://www.imprenta.gov.co',\r\n            type: 'official',\r\n            quality: 9,\r\n            authority: 'maxima'\r\n          }\r\n        ],\r\n        verification: {\r\n          passed: true,\r\n          confidence: 0.95,\r\n          checks: ['source_validation', 'fact_checking', 'legal_reference']\r\n        },\r\n        timestamp: new Date(),\r\n        userId: testUserId,\r\n        chatId: testChatId\r\n      }\r\n\r\n      await memoryManager.addMessage(testChatId, testUserId, {\r\n        role: 'assistant',\r\n        content: auditData.response,\r\n        timestamp: auditData.timestamp,\r\n        metadata: {\r\n          sources: auditData.sources,\r\n          verification: auditData.verification,\r\n          quality: 9\r\n        }\r\n      })\r\n\r\n      // Verificar que se registró toda la información necesaria para auditoría\r\n      expect(mockSupabaseClient.from().insert).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          chat_id: auditData.chatId,\r\n          user_id: auditData.userId,\r\n          content: auditData.response,\r\n          metadata: expect.objectContaining({\r\n            sources: auditData.sources,\r\n            verification: auditData.verification,\r\n            quality: 9\r\n          })\r\n        })\r\n      )\r\n    })\r\n\r\n    test('debe permitir eliminación de datos para GDPR', async () => {\r\n      await memoryManager.clearChatMemory(testUserId, testChatId)\r\n\r\n      // Verificar que se llamaron las operaciones de eliminación\r\n      expect(mockSupabaseClient.from).toHaveBeenCalledWith('messages')\r\n      expect(mockSupabaseClient.from).toHaveBeenCalledWith('chat_contexts')\r\n    })\r\n  })\r\n})\r\n\r\ndescribe('ChatMemoryManager - Tests de Integración', () => {\r\n  let memoryManager: ChatMemoryManager\r\n  const testUserId = 'integration-test-user'\r\n  const testChatId = 'integration-test-chat'\r\n\r\n  beforeEach(() => {\r\n    memoryManager = new ChatMemoryManager()\r\n  })\r\n\r\n  test('debe mantener consistencia de datos en operaciones complejas', async () => {\r\n    // Simular flujo completo de consulta legal\r\n    const userQuery = '¿Cuáles son los pasos para constituir una SAS?'\r\n    \r\n    // 1. Registrar consulta del usuario\r\n    await memoryManager.addMessage(testChatId, testUserId, {\r\n      role: 'user',\r\n      content: userQuery,\r\n      timestamp: new Date()\r\n    })\r\n\r\n    // 2. Registrar búsquedas realizadas\r\n    await memoryManager.addSearchHistory(testChatId, testUserId, {\r\n      query: 'constitución SAS Colombia requisitos',\r\n      results: [\r\n        {\r\n          title: 'Código de Comercio - Artículo 110',\r\n          url: 'https://www.suin-juriscol.gov.co',\r\n          type: 'official',\r\n          quality: 9\r\n        }\r\n      ],\r\n      mode: 'legal_search',\r\n      quality: 9,\r\n      duration: 2000\r\n    })\r\n\r\n    // 3. Cachear fuente encontrada\r\n    await memoryManager.cacheSource(testChatId, testUserId, {\r\n      url: 'https://www.suin-juriscol.gov.co',\r\n      title: 'Código de Comercio - Artículo 110',\r\n      content: 'Contenido del artículo...',\r\n      type: 'official',\r\n      quality: 9,\r\n      authority: 'maxima'\r\n    })\r\n\r\n    // 4. Registrar respuesta del asistente\r\n    await memoryManager.addMessage(testChatId, testUserId, {\r\n      role: 'assistant',\r\n      content: 'Para constituir una SAS en Colombia...',\r\n      timestamp: new Date(),\r\n      metadata: {\r\n        sources: [\r\n          {\r\n            title: 'Código de Comercio - Artículo 110',\r\n            url: 'https://www.suin-juriscol.gov.co',\r\n            type: 'official',\r\n            quality: 9,\r\n            authority: 'maxima'\r\n          }\r\n        ],\r\n        quality: 9,\r\n        verification: { passed: true, confidence: 0.95 },\r\n        mode: 'iter_research'\r\n      }\r\n    })\r\n\r\n    // 5. Verificar que todas las operaciones se registraron\r\n    expect(mockSupabaseClient.from).toHaveBeenCalledTimes(6) // 2 mensajes + 1 búsqueda + 1 cache + 2 contextos\r\n  })\r\n})\r\n"],"version":3}