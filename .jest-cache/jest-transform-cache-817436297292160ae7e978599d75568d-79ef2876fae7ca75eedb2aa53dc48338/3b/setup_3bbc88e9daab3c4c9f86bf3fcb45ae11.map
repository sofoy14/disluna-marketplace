{"file":"C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\__tests__\\setup.ts","mappings":"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","names":[],"sources":["C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\__tests__\\setup.ts"],"sourcesContent":["/**\r\n * Setup Global para Tests de Regresión\r\n * \r\n * Configuración global para todos los tests del sistema legal.\r\n */\r\n\r\n// Configuración de variables de entorno para testing\r\nprocess.env.NODE_ENV = 'test'\r\nprocess.env.SUPABASE_URL = 'http://localhost:54321'\r\nprocess.env.SUPABASE_ANON_KEY = 'test-anon-key'\r\nprocess.env.OPENAI_API_KEY = 'test-openai-key'\r\nprocess.env.SERPER_API_KEY = 'test-serper-key'\r\nprocess.env.FIRECRAWL_API_KEY = 'test-firecrawl-key'\r\n\r\n// Configuración de console para tests\r\nconst originalConsole = console\r\n\r\nbeforeAll(() => {\r\n  // Suprimir logs durante tests para mantener output limpio\r\n  global.console = {\r\n    ...originalConsole,\r\n    log: jest.fn(),\r\n    debug: jest.fn(),\r\n    info: jest.fn(),\r\n    warn: jest.fn(),\r\n    error: jest.fn()\r\n  }\r\n})\r\n\r\nafterAll(() => {\r\n  // Restaurar console original\r\n  global.console = originalConsole\r\n})\r\n\r\n// Configuración de mocks globales\r\njest.mock('@supabase/supabase-js', () => ({\r\n  createClient: jest.fn(() => ({\r\n    from: jest.fn(() => ({\r\n      select: jest.fn(() => ({\r\n        eq: jest.fn(() => ({\r\n          order: jest.fn(() => ({\r\n            limit: jest.fn(() => Promise.resolve({ data: [], error: null }))\r\n          }))\r\n        }))\r\n      })),\r\n      insert: jest.fn(() => Promise.resolve({ data: [], error: null })),\r\n      update: jest.fn(() => ({\r\n        eq: jest.fn(() => Promise.resolve({ data: [], error: null }))\r\n      })),\r\n      upsert: jest.fn(() => Promise.resolve({ data: [], error: null })),\r\n      delete: jest.fn(() => ({\r\n        eq: jest.fn(() => Promise.resolve({ data: [], error: null }))\r\n      }))\r\n    }))\r\n  }))\r\n}))\r\n\r\njest.mock('openai', () => {\r\n  return jest.fn().mockImplementation(() => ({\r\n    chat: {\r\n      completions: {\r\n        create: jest.fn()\r\n      }\r\n    }\r\n  }))\r\n})\r\n\r\n// Mock de fetch para requests HTTP\r\nglobal.fetch = jest.fn()\r\n\r\n// Configuración de timers para tests\r\njest.useFakeTimers()\r\n\r\n// Configuración de crypto para tests\r\nObject.defineProperty(global, 'crypto', {\r\n  value: {\r\n    randomUUID: jest.fn(() => 'test-uuid-123')\r\n  }\r\n})\r\n\r\n// Configuración de Date para tests consistentes\r\nconst mockDate = new Date('2024-01-15T10:00:00Z')\r\njest.spyOn(global, 'Date').mockImplementation(() => mockDate)\r\n\r\n// Configuración de Math.random para tests determinísticos\r\njest.spyOn(Math, 'random').mockReturnValue(0.5)\r\n\r\n// Configuración de setTimeout y setInterval para tests\r\njest.spyOn(global, 'setTimeout').mockImplementation((fn) => {\r\n  fn()\r\n  return 1\r\n})\r\n\r\njest.spyOn(global, 'setInterval').mockImplementation((fn) => {\r\n  fn()\r\n  return 1\r\n})\r\n\r\n// Configuración de clearTimeout y clearInterval\r\njest.spyOn(global, 'clearTimeout').mockImplementation(() => {})\r\njest.spyOn(global, 'clearInterval').mockImplementation(() => {})\r\n\r\n// Configuración de process.env para tests\r\nprocess.env.TEST_MODE = 'true'\r\nprocess.env.DISABLE_LOGGING = 'true'\r\n\r\n// Configuración de errores no manejados\r\nprocess.on('unhandledRejection', (reason, promise) => {\r\n  console.error('Unhandled Rejection at:', promise, 'reason:', reason)\r\n})\r\n\r\nprocess.on('uncaughtException', (error) => {\r\n  console.error('Uncaught Exception:', error)\r\n})\r\n\r\n// Configuración de cleanup después de cada test\r\nafterEach(() => {\r\n  // Limpiar todos los mocks\r\n  jest.clearAllMocks()\r\n  \r\n  // Limpiar timers\r\n  jest.clearAllTimers()\r\n  \r\n  // Resetear fetch mock\r\n  if (global.fetch) {\r\n    (global.fetch as jest.Mock).mockClear()\r\n  }\r\n})\r\n\r\n// Configuración de cleanup global\r\nafterAll(() => {\r\n  // Restaurar timers reales\r\n  jest.useRealTimers()\r\n  \r\n  // Restaurar Date real\r\n  jest.restoreAllMocks()\r\n  \r\n  // Limpiar variables de entorno de test\r\n  delete process.env.TEST_MODE\r\n  delete process.env.DISABLE_LOGGING\r\n})\r\n\r\n// Configuración de helpers globales para tests\r\nglobal.testHelpers = {\r\n  // Helper para crear mock de respuesta de OpenAI\r\n  createMockOpenAIResponse: (content: any) => ({\r\n    choices: [{\r\n      message: {\r\n        content: typeof content === 'string' ? content : JSON.stringify(content)\r\n      }\r\n    }]\r\n  }),\r\n  \r\n  // Helper para crear mock de fuente legal\r\n  createMockLegalSource: (overrides = {}) => ({\r\n    title: 'Fuente Legal Test',\r\n    url: 'https://www.test.gov.co',\r\n    content: 'Contenido de prueba',\r\n    snippet: 'Snippet de prueba',\r\n    type: 'official',\r\n    quality: 8,\r\n    authority: 'maxima',\r\n    currency: 'actualizada',\r\n    recommendedUse: 'cita_principal',\r\n    verificationNotes: 'Verificada en tests',\r\n    ...overrides\r\n  }),\r\n  \r\n  // Helper para crear mock de contexto de chat\r\n  createMockChatContext: (overrides = {}) => ({\r\n    chatId: 'test-chat-123',\r\n    userId: 'test-user-456',\r\n    conversationHistory: [],\r\n    currentContext: '',\r\n    searchHistory: [],\r\n    userPreferences: {\r\n      preferredSearchStrategy: 'AGENTE_UNIFICADO_TONGYI',\r\n      maxSearchRounds: 5,\r\n      enableModelDecision: true,\r\n      preferredResearchMode: undefined,\r\n      qualityThreshold: 0.85\r\n    },\r\n    cachedSources: [],\r\n    qualityMetrics: {\r\n      totalQueries: 0,\r\n      averageQuality: 0,\r\n      modePerformance: {\r\n        react: { count: 0, avgQuality: 0, avgTime: 0 },\r\n        iter_research: { count: 0, avgQuality: 0, avgTime: 0 },\r\n        hybrid: { count: 0, avgQuality: 0, avgTime: 0 }\r\n      },\r\n      verificationStats: {\r\n        totalVerifications: 0,\r\n        passedVerifications: 0,\r\n        averageConfidence: 0,\r\n        successRate: 0\r\n      }\r\n    },\r\n    ...overrides\r\n  }),\r\n  \r\n  // Helper para crear mock de consulta legal\r\n  createMockLegalQuery: (overrides = {}) => ({\r\n    query: '¿Cuáles son los requisitos para constituir una SAS?',\r\n    userId: 'test-user-123',\r\n    chatId: 'test-chat-456',\r\n    context: global.testHelpers.createMockChatContext(),\r\n    ...overrides\r\n  }),\r\n  \r\n  // Helper para esperar con timeout\r\n  waitFor: (ms: number) => new Promise(resolve => setTimeout(resolve, ms)),\r\n  \r\n  // Helper para crear mock de error\r\n  createMockError: (message: string, code?: string) => {\r\n    const error = new Error(message)\r\n    if (code) {\r\n      (error as any).code = code\r\n    }\r\n    return error\r\n  }\r\n}\r\n\r\n// Configuración de tipos globales para TypeScript\r\ndeclare global {\r\n  var testHelpers: {\r\n    createMockOpenAIResponse: (content: any) => any\r\n    createMockLegalSource: (overrides?: any) => any\r\n    createMockChatContext: (overrides?: any) => any\r\n    createMockLegalQuery: (overrides?: any) => any\r\n    waitFor: (ms: number) => Promise<void>\r\n    createMockError: (message: string, code?: string) => Error\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"version":3}