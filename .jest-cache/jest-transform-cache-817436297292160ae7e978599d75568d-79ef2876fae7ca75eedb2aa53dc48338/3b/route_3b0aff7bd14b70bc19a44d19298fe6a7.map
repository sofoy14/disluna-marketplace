{"version":3,"names":["cov_2olwri3gsv","actualCoverage","exports","POST","ai_1","s","require","openai_1","__importDefault","conditional_web_search_1","request","f","json","chatSettings","messages","openrouterApiKey","b","process","env","OPENROUTER_API_KEY","Error","openai","default","apiKey","baseURL","lastUserMessage","filter","m","role","pop","userQuery","content","console","log","repeat","substring","searchResult","executeConditionalWebSearch","logDetection","shouldSearch","detectionResult","confidence","toFixed","reason","systemMessage","generateSystemMessage","length","unshift","response","chat","completions","create","model","temperature","max_tokens","undefined","stream","OpenAIStream","StreamingTextResponse","error","errorMessage","message","errorCode","status","Response","JSON","stringify"],"sources":["C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\app\\api\\chat\\simple\\route.ts"],"sourcesContent":["import { ChatSettings } from \"@/types\"\r\nimport { OpenAIStream, StreamingTextResponse } from \"ai\"\r\nimport OpenAI from \"openai\"\r\nimport { ChatCompletionCreateParamsBase } from \"openai/resources/chat/completions.mjs\"\r\nimport { executeConditionalWebSearch, generateSystemMessage } from \"@/lib/tools/conditional-web-search\"\r\n\r\nexport async function POST(request: Request) {\r\n  const json = await request.json()\r\n  const { chatSettings, messages } = json as {\r\n    chatSettings: ChatSettings\r\n    messages: any[]\r\n  }\r\n\r\n  try {\r\n    // Usar API key de OpenRouter desde variables de entorno\r\n    const openrouterApiKey = process.env.OPENROUTER_API_KEY || \"\"\r\n\r\n    if (!openrouterApiKey) {\r\n      throw new Error(\"OpenRouter API Key no configurada. Por favor configura OPENROUTER_API_KEY en las variables de entorno.\")\r\n    }\r\n\r\n    const openai = new OpenAI({\r\n      apiKey: openrouterApiKey,\r\n      baseURL: \"https://openrouter.ai/api/v1\"\r\n    })\r\n\r\n    // üß† B√öSQUEDA WEB INTELIGENTE - SOLO CUANDO ES NECESARIO\r\n    const lastUserMessage = messages.filter(m => m.role === 'user').pop()\r\n    const userQuery = lastUserMessage?.content || ''\r\n    \r\n    console.log(`\\n${\"üß†\".repeat(60)}`)\r\n    console.log(`üîç CHAT SIMPLE - B√öSQUEDA WEB INTELIGENTE`)\r\n    console.log(`   Query: \"${userQuery.substring(0, 50)}...\"`)\r\n    console.log(`   Usuario: usuario-anonimo`)\r\n    console.log(`${\"üß†\".repeat(60)}\\n`)\r\n    \r\n    // Ejecutar b√∫squeda condicional inteligente\r\n    const searchResult = await executeConditionalWebSearch(userQuery, {\r\n      logDetection: true\r\n    })\r\n    \r\n    console.log(`\\n${\"üß†\".repeat(60)}`)\r\n    console.log(`‚úÖ AN√ÅLISIS INTELIGENTE COMPLETADO`)\r\n    console.log(`   üîç B√∫squeda requerida: ${searchResult.shouldSearch ? 'S√ç' : 'NO'}`)\r\n    console.log(`   üéØ Confianza: ${(searchResult.detectionResult.confidence * 100).toFixed(1)}%`)\r\n    console.log(`   üìã Raz√≥n: ${searchResult.detectionResult.reason}`)\r\n    console.log(`${\"üß†\".repeat(60)}\\n`)\r\n\r\n    // Generar mensaje de sistema apropiado\r\n    const systemMessage = {\r\n      role: \"system\",\r\n      content: generateSystemMessage(userQuery, searchResult)\r\n    }\r\n\r\n    // Insertar el mensaje de sistema al inicio\r\n    if (messages.length === 0 || messages[0].role !== \"system\") {\r\n      messages.unshift(systemMessage)\r\n    } else {\r\n      // Si ya hay un mensaje de sistema, agregar las instrucciones\r\n      messages[0].content = `${messages[0].content}\\n\\n${systemMessage.content}`\r\n    }\r\n\r\n    const response = await openai.chat.completions.create({\r\n      model: chatSettings.model as ChatCompletionCreateParamsBase[\"model\"],\r\n      messages,\r\n      temperature: chatSettings.temperature,\r\n      max_tokens: undefined,\r\n      stream: true\r\n    })\r\n\r\n    const stream = OpenAIStream(response)\r\n\r\n    return new StreamingTextResponse(stream)\r\n  } catch (error: any) {\r\n    console.error('Error en chat simple:', error)\r\n    const errorMessage = error.message || \"An unexpected error occurred\"\r\n    const errorCode = error.status || 500\r\n\r\n    return new Response(JSON.stringify({ message: errorMessage }), {\r\n      status: errorCode\r\n    })\r\n  }\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAiBQ;IAAAA,cAAA,YAAAA,CAAA;MAAA,OAAAC,cAAA;IAAA;EAAA;EAAA,OAAAA,cAAA;AAAA;AAAAD,cAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAXRE,OAAA,CAAAC,IAAA,GAAAA,IAAA;AALA,MAAAC,IAAA;AAAA;AAAA,CAAAJ,cAAA,GAAAK,CAAA,OAAAC,OAAA;AACA,MAAAC,QAAA;AAAA;AAAA,CAAAP,cAAA,GAAAK,CAAA,OAAAG,eAAA,CAAAF,OAAA;AAEA,MAAAG,wBAAA;AAAA;AAAA,CAAAT,cAAA,GAAAK,CAAA,OAAAC,OAAA;AAEO,eAAeH,IAAIA,CAACO,OAAgB;EAAA;EAAAV,cAAA,GAAAW,CAAA;EACzC,MAAMC,IAAI;EAAA;EAAA,CAAAZ,cAAA,GAAAK,CAAA,OAAG,MAAMK,OAAO,CAACE,IAAI,EAAE;EACjC,MAAM;IAAEC,YAAY;IAAEC;EAAQ,CAAE;EAAA;EAAA,CAAAd,cAAA,GAAAK,CAAA,OAAGO,IAGlC;EAAA;EAAAZ,cAAA,GAAAK,CAAA;EAED,IAAI;IACF;IACA,MAAMU,gBAAgB;IAAA;IAAA,CAAAf,cAAA,GAAAK,CAAA;IAAG;IAAA,CAAAL,cAAA,GAAAgB,CAAA,UAAAC,OAAO,CAACC,GAAG,CAACC,kBAAkB;IAAA;IAAA,CAAAnB,cAAA,GAAAgB,CAAA,UAAI,EAAE;IAAA;IAAAhB,cAAA,GAAAK,CAAA;IAE7D,IAAI,CAACU,gBAAgB,EAAE;MAAA;MAAAf,cAAA,GAAAgB,CAAA;MAAAhB,cAAA,GAAAK,CAAA;MACrB,MAAM,IAAIe,KAAK,CAAC,wGAAwG,CAAC;IAC3H,CAAC;IAAA;IAAA;MAAApB,cAAA,GAAAgB,CAAA;IAAA;IAED,MAAMK,MAAM;IAAA;IAAA,CAAArB,cAAA,GAAAK,CAAA,QAAG,IAAIE,QAAA,CAAAe,OAAM,CAAC;MACxBC,MAAM,EAAER,gBAAgB;MACxBS,OAAO,EAAE;KACV,CAAC;IAEF;IACA,MAAMC,eAAe;IAAA;IAAA,CAAAzB,cAAA,GAAAK,CAAA,QAAGS,QAAQ,CAACY,MAAM,CAACC,CAAC,IAAI;MAAA;MAAA3B,cAAA,GAAAW,CAAA;MAAAX,cAAA,GAAAK,CAAA;MAAA,OAAAsB,CAAC,CAACC,IAAI,KAAK,MAAM;IAAN,CAAM,CAAC,CAACC,GAAG,EAAE;IACrE,MAAMC,SAAS;IAAA;IAAA,CAAA9B,cAAA,GAAAK,CAAA;IAAG;IAAA,CAAAL,cAAA,GAAAgB,CAAA,UAAAS,eAAe,EAAEM,OAAO;IAAA;IAAA,CAAA/B,cAAA,GAAAgB,CAAA,UAAI,EAAE;IAAA;IAAAhB,cAAA,GAAAK,CAAA;IAEhD2B,OAAO,CAACC,GAAG,CAAC,KAAK,IAAI,CAACC,MAAM,CAAC,EAAE,CAAC,EAAE,CAAC;IAAA;IAAAlC,cAAA,GAAAK,CAAA;IACnC2B,OAAO,CAACC,GAAG,CAAC,2CAA2C,CAAC;IAAA;IAAAjC,cAAA,GAAAK,CAAA;IACxD2B,OAAO,CAACC,GAAG,CAAC,cAAcH,SAAS,CAACK,SAAS,CAAC,CAAC,EAAE,EAAE,CAAC,MAAM,CAAC;IAAA;IAAAnC,cAAA,GAAAK,CAAA;IAC3D2B,OAAO,CAACC,GAAG,CAAC,6BAA6B,CAAC;IAAA;IAAAjC,cAAA,GAAAK,CAAA;IAC1C2B,OAAO,CAACC,GAAG,CAAC,GAAG,IAAI,CAACC,MAAM,CAAC,EAAE,CAAC,IAAI,CAAC;IAEnC;IACA,MAAME,YAAY;IAAA;IAAA,CAAApC,cAAA,GAAAK,CAAA,QAAG,MAAM,IAAAI,wBAAA,CAAA4B,2BAA2B,EAACP,SAAS,EAAE;MAChEQ,YAAY,EAAE;KACf,CAAC;IAAA;IAAAtC,cAAA,GAAAK,CAAA;IAEF2B,OAAO,CAACC,GAAG,CAAC,KAAK,IAAI,CAACC,MAAM,CAAC,EAAE,CAAC,EAAE,CAAC;IAAA;IAAAlC,cAAA,GAAAK,CAAA;IACnC2B,OAAO,CAACC,GAAG,CAAC,mCAAmC,CAAC;IAAA;IAAAjC,cAAA,GAAAK,CAAA;IAChD2B,OAAO,CAACC,GAAG,CAAC,6BAA6BG,YAAY,CAACG,YAAY;IAAA;IAAA,CAAAvC,cAAA,GAAAgB,CAAA,UAAG,IAAI;IAAA;IAAA,CAAAhB,cAAA,GAAAgB,CAAA,UAAG,IAAI,GAAE,CAAC;IAAA;IAAAhB,cAAA,GAAAK,CAAA;IACnF2B,OAAO,CAACC,GAAG,CAAC,oBAAoB,CAACG,YAAY,CAACI,eAAe,CAACC,UAAU,GAAG,GAAG,EAAEC,OAAO,CAAC,CAAC,CAAC,GAAG,CAAC;IAAA;IAAA1C,cAAA,GAAAK,CAAA;IAC9F2B,OAAO,CAACC,GAAG,CAAC,gBAAgBG,YAAY,CAACI,eAAe,CAACG,MAAM,EAAE,CAAC;IAAA;IAAA3C,cAAA,GAAAK,CAAA;IAClE2B,OAAO,CAACC,GAAG,CAAC,GAAG,IAAI,CAACC,MAAM,CAAC,EAAE,CAAC,IAAI,CAAC;IAEnC;IACA,MAAMU,aAAa;IAAA;IAAA,CAAA5C,cAAA,GAAAK,CAAA,QAAG;MACpBuB,IAAI,EAAE,QAAQ;MACdG,OAAO,EAAE,IAAAtB,wBAAA,CAAAoC,qBAAqB,EAACf,SAAS,EAAEM,YAAY;KACvD;IAED;IAAA;IAAApC,cAAA,GAAAK,CAAA;IACA;IAAI;IAAA,CAAAL,cAAA,GAAAgB,CAAA,UAAAF,QAAQ,CAACgC,MAAM,KAAK,CAAC;IAAA;IAAA,CAAA9C,cAAA,GAAAgB,CAAA,UAAIF,QAAQ,CAAC,CAAC,CAAC,CAACc,IAAI,KAAK,QAAQ,GAAE;MAAA;MAAA5B,cAAA,GAAAgB,CAAA;MAAAhB,cAAA,GAAAK,CAAA;MAC1DS,QAAQ,CAACiC,OAAO,CAACH,aAAa,CAAC;IACjC,CAAC,MAAM;MAAA;MAAA5C,cAAA,GAAAgB,CAAA;MAAAhB,cAAA,GAAAK,CAAA;MACL;MACAS,QAAQ,CAAC,CAAC,CAAC,CAACiB,OAAO,GAAG,GAAGjB,QAAQ,CAAC,CAAC,CAAC,CAACiB,OAAO,OAAOa,aAAa,CAACb,OAAO,EAAE;IAC5E;IAEA,MAAMiB,QAAQ;IAAA;IAAA,CAAAhD,cAAA,GAAAK,CAAA,QAAG,MAAMgB,MAAM,CAAC4B,IAAI,CAACC,WAAW,CAACC,MAAM,CAAC;MACpDC,KAAK,EAAEvC,YAAY,CAACuC,KAAgD;MACpEtC,QAAQ;MACRuC,WAAW,EAAExC,YAAY,CAACwC,WAAW;MACrCC,UAAU,EAAEC,SAAS;MACrBC,MAAM,EAAE;KACT,CAAC;IAEF,MAAMA,MAAM;IAAA;IAAA,CAAAxD,cAAA,GAAAK,CAAA,QAAG,IAAAD,IAAA,CAAAqD,YAAY,EAACT,QAAQ,CAAC;IAAA;IAAAhD,cAAA,GAAAK,CAAA;IAErC,OAAO,IAAID,IAAA,CAAAsD,qBAAqB,CAACF,MAAM,CAAC;EAC1C,CAAC,CAAC,OAAOG,KAAU,EAAE;IAAA;IAAA3D,cAAA,GAAAK,CAAA;IACnB2B,OAAO,CAAC2B,KAAK,CAAC,uBAAuB,EAAEA,KAAK,CAAC;IAC7C,MAAMC,YAAY;IAAA;IAAA,CAAA5D,cAAA,GAAAK,CAAA;IAAG;IAAA,CAAAL,cAAA,GAAAgB,CAAA,UAAA2C,KAAK,CAACE,OAAO;IAAA;IAAA,CAAA7D,cAAA,GAAAgB,CAAA,UAAI,8BAA8B;IACpE,MAAM8C,SAAS;IAAA;IAAA,CAAA9D,cAAA,GAAAK,CAAA;IAAG;IAAA,CAAAL,cAAA,GAAAgB,CAAA,WAAA2C,KAAK,CAACI,MAAM;IAAA;IAAA,CAAA/D,cAAA,GAAAgB,CAAA,WAAI,GAAG;IAAA;IAAAhB,cAAA,GAAAK,CAAA;IAErC,OAAO,IAAI2D,QAAQ,CAACC,IAAI,CAACC,SAAS,CAAC;MAAEL,OAAO,EAAED;IAAY,CAAE,CAAC,EAAE;MAC7DG,MAAM,EAAED;KACT,CAAC;EACJ;AACF","ignoreList":[]}