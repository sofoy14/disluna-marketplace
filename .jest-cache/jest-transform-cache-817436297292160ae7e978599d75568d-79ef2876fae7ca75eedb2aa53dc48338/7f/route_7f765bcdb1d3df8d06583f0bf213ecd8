d16610ef606fba7f3ab7977778678ccf
"use strict";

/* istanbul ignore next */
function cov_2djqih17wz() {
  var path = "C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\app\\api\\cron\\billing\\route.ts";
  var hash = "e233a9de0217e940e47416c15d65dd351c28d9c9";
  var global = new Function("return this")();
  var gcv = "__coverage__";
  var coverageData = {
    path: "C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\app\\api\\cron\\billing\\route.ts",
    statementMap: {
      "0": {
        start: {
          line: 2,
          column: 0
        },
        end: {
          line: 2,
          column: 62
        }
      },
      "1": {
        start: {
          line: 3,
          column: 0
        },
        end: {
          line: 3,
          column: 25
        }
      },
      "2": {
        start: {
          line: 4,
          column: 0
        },
        end: {
          line: 4,
          column: 18
        }
      },
      "3": {
        start: {
          line: 6,
          column: 17
        },
        end: {
          line: 6,
          column: 39
        }
      },
      "4": {
        start: {
          line: 18,
          column: 0
        },
        end: {
          line: 18,
          column: 34
        }
      },
      "5": {
        start: {
          line: 21,
          column: 4
        },
        end: {
          line: 24,
          column: 24
        }
      }
    },
    fnMap: {
      "0": {
        name: "GET",
        decl: {
          start: {
            line: 19,
            column: 15
          },
          end: {
            line: 19,
            column: 18
          }
        },
        loc: {
          start: {
            line: 19,
            column: 24
          },
          end: {
            line: 165,
            column: 1
          }
        },
        line: 19
      }
    },
    branchMap: {},
    s: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0
    },
    f: {
      "0": 0
    },
    b: {},
    inputSourceMap: {
      file: "C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\app\\api\\cron\\billing\\route.ts",
      mappings: ";;;AAgBA,kBAsJC;AAtKD,gCAAgC;AAChC,wCAAwD;AACxD,0CAA0C;AAC1C,oDAAoD;AACpD,oDAAoD;AACpD,YAAY;AACZ,+BAA+B;AAC/B,oBAAoB;AACpB,wBAAwB;AACxB,mBAAmB;AACnB,wBAAwB;AACxB,yBAAyB;AACzB,8FAA8F;AAEjF,QAAA,OAAO,GAAG,eAAe,CAAC;AAEhC,KAAK,UAAU,GAAG,CAAC,GAAgB;IACxC,0CAA0C;IAC1C,OAAO,qBAAY,CAAC,IAAI,CACtB;QACE,OAAO,EAAE,oDAAoD;QAC7D,MAAM,EAAE,UAAU;KACnB,EACD,EAAE,MAAM,EAAE,GAAG,EAAE,CAChB,CAAC;IAEF;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;MA2IE;AACJ,CAAC",
      names: [],
      sources: ["C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\app\\api\\cron\\billing\\route.ts"],
      sourcesContent: ["// app/api/cron/billing/route.ts\nimport { NextRequest, NextResponse } from 'next/server';\n// ELIMINADO - Sistema de billing removido\n// import { wompiClient } from '@/lib/wompi/client';\n// import { wompiConfig } from '@/lib/wompi/config';\n// import { \n//   getSubscriptionsDueToday, \n//   createInvoice, \n//   createTransaction, \n//   updateInvoice,\n//   updateSubscription \n// } from '@/db/billing';\n// import { generateTransactionReference, isPaymentSourceAvailable } from '@/lib/wompi/utils';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function GET(req: NextRequest) {\n  // ELIMINADO - Sistema de billing removido\n  return NextResponse.json(\n    { \n      message: 'Sistema de facturaci\xF3n temporalmente deshabilitado',\n      status: 'disabled'\n    }, \n    { status: 200 }\n  );\n  \n  /*\n  try {\n    // Validate cron secret\n    const authHeader = req.headers.get('Authorization');\n    if (!authHeader || authHeader !== `Bearer ${wompiConfig.cronSecret}`) {\n      return NextResponse.json(\n        { error: 'Unauthorized' }, \n        { status: 401 }\n      );\n    }\n\n    // Check if billing is enabled\n    if (!wompiConfig.isEnabled) {\n      return NextResponse.json(\n        { error: 'Billing is not enabled' }, \n        { status: 403 }\n      );\n    }\n\n    console.log('Starting billing cron job...');\n\n    // Get subscriptions due today\n    const subscriptions = await getSubscriptionsDueToday();\n    console.log(`Found ${subscriptions.length} subscriptions due today`);\n\n    let processedCount = 0;\n    let errorCount = 0;\n\n    for (const subscription of subscriptions) {\n      try {\n        // Skip if subscription is set to cancel at period end\n        if (subscription.cancel_at_period_end) {\n          console.log(`Skipping subscription ${subscription.id} - set to cancel`);\n          continue;\n        }\n\n        // Validate payment source is available\n        if (!subscription.payment_sources || !isPaymentSourceAvailable(subscription.payment_sources.status)) {\n          console.log(`Skipping subscription ${subscription.id} - payment source not available`);\n          // Mark subscription as requiring action\n          await updateSubscription(subscription.id, { status: 'past_due' });\n          continue;\n        }\n\n        // Create invoice\n        const invoice = await createInvoice({\n          subscription_id: subscription.id,\n          workspace_id: subscription.workspace_id,\n          period_start: subscription.current_period_start,\n          period_end: subscription.current_period_end,\n          amount_in_cents: subscription.plans.amount_in_cents,\n          status: 'pending'\n        });\n\n        console.log(`Created invoice ${invoice.id} for subscription ${subscription.id}`);\n\n        // Create transaction in Wompi\n        const reference = generateTransactionReference(invoice.id);\n        const transactionData = {\n          amount_in_cents: subscription.plans.amount_in_cents,\n          currency: 'COP',\n          customer_email: subscription.payment_sources.customer_email,\n          payment_method: {\n            type: subscription.payment_sources.type,\n            installments: 1\n          },\n          payment_source_id: subscription.payment_sources.wompi_id,\n          reference,\n          redirect_url: `${process.env.NEXT_PUBLIC_APP_URL}/billing/success`\n        };\n\n        // Add recurrent flag for cards\n        if (subscription.payment_sources.type === 'CARD') {\n          transactionData.recurrent = true;\n        }\n\n        const wompiTransaction = await wompiClient.createTransaction(transactionData);\n        console.log(`Created Wompi transaction ${wompiTransaction.id} for invoice ${invoice.id}`);\n\n        // Save transaction to database\n        await createTransaction({\n          invoice_id: invoice.id,\n          workspace_id: subscription.workspace_id,\n          wompi_id: wompiTransaction.id,\n          amount_in_cents: wompiTransaction.amount_in_cents,\n          status: wompiTransaction.status,\n          payment_method_type: subscription.payment_sources.type,\n          reference: wompiTransaction.reference,\n          status_message: wompiTransaction.status_message,\n          raw_payload: wompiTransaction\n        });\n\n        // Update invoice with transaction ID\n        await updateInvoice(invoice.id, {\n          wompi_transaction_id: wompiTransaction.id\n        });\n\n        // Extend subscription period\n        const newPeriodStart = new Date(subscription.current_period_end);\n        const newPeriodEnd = new Date(newPeriodStart);\n        newPeriodEnd.setMonth(newPeriodEnd.getMonth() + 1);\n\n        await updateSubscription(subscription.id, {\n          current_period_start: newPeriodStart.toISOString(),\n          current_period_end: newPeriodEnd.toISOString()\n        });\n\n        console.log(`Extended subscription ${subscription.id} period`);\n        processedCount++;\n\n      } catch (error) {\n        console.error(`Error processing subscription ${subscription.id}:`, error);\n        errorCount++;\n        \n        // Mark subscription as past due if there's an error\n        try {\n          await updateSubscription(subscription.id, { status: 'past_due' });\n        } catch (updateError) {\n          console.error(`Error updating subscription ${subscription.id} status:`, updateError);\n        }\n      }\n    }\n\n    console.log(`Billing cron completed. Processed: ${processedCount}, Errors: ${errorCount}`);\n\n    return NextResponse.json({\n      success: true,\n      processed: processedCount,\n      errors: errorCount,\n      total_subscriptions: subscriptions.length\n    });\n\n  } catch (error) {\n    console.error('Billing cron error:', error);\n    return NextResponse.json(\n      { error: 'Billing cron failed' }, \n      { status: 500 }\n    );\n  }\n  */\n}\n\n\n\n\n"],
      version: 3
    },
    _coverageSchema: "1a1c01bbd47fc00a2c39e90264f33305004495a9",
    hash: "e233a9de0217e940e47416c15d65dd351c28d9c9"
  };
  var coverage = global[gcv] || (global[gcv] = {});
  if (!coverage[path] || coverage[path].hash !== hash) {
    coverage[path] = coverageData;
  }
  var actualCoverage = coverage[path];
  {
    // @ts-ignore
    cov_2djqih17wz = function () {
      return actualCoverage;
    };
  }
  return actualCoverage;
}
cov_2djqih17wz();
cov_2djqih17wz().s[0]++;
Object.defineProperty(exports, "__esModule", {
  value: true
});
/* istanbul ignore next */
cov_2djqih17wz().s[1]++;
exports.dynamic = void 0;
/* istanbul ignore next */
cov_2djqih17wz().s[2]++;
exports.GET = GET;
// app/api/cron/billing/route.ts
const server_1 =
/* istanbul ignore next */
(cov_2djqih17wz().s[3]++, require("next/server"));
// ELIMINADO - Sistema de billing removido
// import { wompiClient } from '@/lib/wompi/client';
// import { wompiConfig } from '@/lib/wompi/config';
// import { 
//   getSubscriptionsDueToday, 
//   createInvoice, 
//   createTransaction, 
//   updateInvoice,
//   updateSubscription 
// } from '@/db/billing';
// import { generateTransactionReference, isPaymentSourceAvailable } from '@/lib/wompi/utils';
/* istanbul ignore next */
cov_2djqih17wz().s[4]++;
exports.dynamic = 'force-dynamic';
async function GET(req) {
  /* istanbul ignore next */
  cov_2djqih17wz().f[0]++;
  cov_2djqih17wz().s[5]++;
  // ELIMINADO - Sistema de billing removido
  return server_1.NextResponse.json({
    message: 'Sistema de facturaci√≥n temporalmente deshabilitado',
    status: 'disabled'
  }, {
    status: 200
  });
  /*
  try {
    // Validate cron secret
    const authHeader = req.headers.get('Authorization');
    if (!authHeader || authHeader !== `Bearer ${wompiConfig.cronSecret}`) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }
       // Check if billing is enabled
    if (!wompiConfig.isEnabled) {
      return NextResponse.json(
        { error: 'Billing is not enabled' },
        { status: 403 }
      );
    }
       console.log('Starting billing cron job...');
       // Get subscriptions due today
    const subscriptions = await getSubscriptionsDueToday();
    console.log(`Found ${subscriptions.length} subscriptions due today`);
       let processedCount = 0;
    let errorCount = 0;
       for (const subscription of subscriptions) {
      try {
        // Skip if subscription is set to cancel at period end
        if (subscription.cancel_at_period_end) {
          console.log(`Skipping subscription ${subscription.id} - set to cancel`);
          continue;
        }
           // Validate payment source is available
        if (!subscription.payment_sources || !isPaymentSourceAvailable(subscription.payment_sources.status)) {
          console.log(`Skipping subscription ${subscription.id} - payment source not available`);
          // Mark subscription as requiring action
          await updateSubscription(subscription.id, { status: 'past_due' });
          continue;
        }
           // Create invoice
        const invoice = await createInvoice({
          subscription_id: subscription.id,
          workspace_id: subscription.workspace_id,
          period_start: subscription.current_period_start,
          period_end: subscription.current_period_end,
          amount_in_cents: subscription.plans.amount_in_cents,
          status: 'pending'
        });
           console.log(`Created invoice ${invoice.id} for subscription ${subscription.id}`);
           // Create transaction in Wompi
        const reference = generateTransactionReference(invoice.id);
        const transactionData = {
          amount_in_cents: subscription.plans.amount_in_cents,
          currency: 'COP',
          customer_email: subscription.payment_sources.customer_email,
          payment_method: {
            type: subscription.payment_sources.type,
            installments: 1
          },
          payment_source_id: subscription.payment_sources.wompi_id,
          reference,
          redirect_url: `${process.env.NEXT_PUBLIC_APP_URL}/billing/success`
        };
           // Add recurrent flag for cards
        if (subscription.payment_sources.type === 'CARD') {
          transactionData.recurrent = true;
        }
           const wompiTransaction = await wompiClient.createTransaction(transactionData);
        console.log(`Created Wompi transaction ${wompiTransaction.id} for invoice ${invoice.id}`);
           // Save transaction to database
        await createTransaction({
          invoice_id: invoice.id,
          workspace_id: subscription.workspace_id,
          wompi_id: wompiTransaction.id,
          amount_in_cents: wompiTransaction.amount_in_cents,
          status: wompiTransaction.status,
          payment_method_type: subscription.payment_sources.type,
          reference: wompiTransaction.reference,
          status_message: wompiTransaction.status_message,
          raw_payload: wompiTransaction
        });
           // Update invoice with transaction ID
        await updateInvoice(invoice.id, {
          wompi_transaction_id: wompiTransaction.id
        });
           // Extend subscription period
        const newPeriodStart = new Date(subscription.current_period_end);
        const newPeriodEnd = new Date(newPeriodStart);
        newPeriodEnd.setMonth(newPeriodEnd.getMonth() + 1);
           await updateSubscription(subscription.id, {
          current_period_start: newPeriodStart.toISOString(),
          current_period_end: newPeriodEnd.toISOString()
        });
           console.log(`Extended subscription ${subscription.id} period`);
        processedCount++;
         } catch (error) {
        console.error(`Error processing subscription ${subscription.id}:`, error);
        errorCount++;
        
        // Mark subscription as past due if there's an error
        try {
          await updateSubscription(subscription.id, { status: 'past_due' });
        } catch (updateError) {
          console.error(`Error updating subscription ${subscription.id} status:`, updateError);
        }
      }
    }
       console.log(`Billing cron completed. Processed: ${processedCount}, Errors: ${errorCount}`);
       return NextResponse.json({
      success: true,
      processed: processedCount,
      errors: errorCount,
      total_subscriptions: subscriptions.length
    });
     } catch (error) {
    console.error('Billing cron error:', error);
    return NextResponse.json(
      { error: 'Billing cron failed' },
      { status: 500 }
    );
  }
  */
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb3ZfMmRqcWloMTd3eiIsImFjdHVhbENvdmVyYWdlIiwicyIsImV4cG9ydHMiLCJHRVQiLCJzZXJ2ZXJfMSIsInJlcXVpcmUiLCJkeW5hbWljIiwicmVxIiwiZiIsIk5leHRSZXNwb25zZSIsImpzb24iLCJtZXNzYWdlIiwic3RhdHVzIl0sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxwZWRyb1xcRG9jdW1lbnRzXFxHaXRIdWJcXEFzaXN0ZW50ZS1MZWdhbC1JbnRlbGlnZW50ZVxcYXBwXFxhcGlcXGNyb25cXGJpbGxpbmdcXHJvdXRlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIGFwcC9hcGkvY3Jvbi9iaWxsaW5nL3JvdXRlLnRzXG5pbXBvcnQgeyBOZXh0UmVxdWVzdCwgTmV4dFJlc3BvbnNlIH0gZnJvbSAnbmV4dC9zZXJ2ZXInO1xuLy8gRUxJTUlOQURPIC0gU2lzdGVtYSBkZSBiaWxsaW5nIHJlbW92aWRvXG4vLyBpbXBvcnQgeyB3b21waUNsaWVudCB9IGZyb20gJ0AvbGliL3dvbXBpL2NsaWVudCc7XG4vLyBpbXBvcnQgeyB3b21waUNvbmZpZyB9IGZyb20gJ0AvbGliL3dvbXBpL2NvbmZpZyc7XG4vLyBpbXBvcnQgeyBcbi8vICAgZ2V0U3Vic2NyaXB0aW9uc0R1ZVRvZGF5LCBcbi8vICAgY3JlYXRlSW52b2ljZSwgXG4vLyAgIGNyZWF0ZVRyYW5zYWN0aW9uLCBcbi8vICAgdXBkYXRlSW52b2ljZSxcbi8vICAgdXBkYXRlU3Vic2NyaXB0aW9uIFxuLy8gfSBmcm9tICdAL2RiL2JpbGxpbmcnO1xuLy8gaW1wb3J0IHsgZ2VuZXJhdGVUcmFuc2FjdGlvblJlZmVyZW5jZSwgaXNQYXltZW50U291cmNlQXZhaWxhYmxlIH0gZnJvbSAnQC9saWIvd29tcGkvdXRpbHMnO1xuXG5leHBvcnQgY29uc3QgZHluYW1pYyA9ICdmb3JjZS1keW5hbWljJztcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIEdFVChyZXE6IE5leHRSZXF1ZXN0KSB7XG4gIC8vIEVMSU1JTkFETyAtIFNpc3RlbWEgZGUgYmlsbGluZyByZW1vdmlkb1xuICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgeyBcbiAgICAgIG1lc3NhZ2U6ICdTaXN0ZW1hIGRlIGZhY3R1cmFjacOzbiB0ZW1wb3JhbG1lbnRlIGRlc2hhYmlsaXRhZG8nLFxuICAgICAgc3RhdHVzOiAnZGlzYWJsZWQnXG4gICAgfSwgXG4gICAgeyBzdGF0dXM6IDIwMCB9XG4gICk7XG4gIFxuICAvKlxuICB0cnkge1xuICAgIC8vIFZhbGlkYXRlIGNyb24gc2VjcmV0XG4gICAgY29uc3QgYXV0aEhlYWRlciA9IHJlcS5oZWFkZXJzLmdldCgnQXV0aG9yaXphdGlvbicpO1xuICAgIGlmICghYXV0aEhlYWRlciB8fCBhdXRoSGVhZGVyICE9PSBgQmVhcmVyICR7d29tcGlDb25maWcuY3JvblNlY3JldH1gKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0sIFxuICAgICAgICB7IHN0YXR1czogNDAxIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgYmlsbGluZyBpcyBlbmFibGVkXG4gICAgaWYgKCF3b21waUNvbmZpZy5pc0VuYWJsZWQpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgeyBlcnJvcjogJ0JpbGxpbmcgaXMgbm90IGVuYWJsZWQnIH0sIFxuICAgICAgICB7IHN0YXR1czogNDAzIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coJ1N0YXJ0aW5nIGJpbGxpbmcgY3JvbiBqb2IuLi4nKTtcblxuICAgIC8vIEdldCBzdWJzY3JpcHRpb25zIGR1ZSB0b2RheVxuICAgIGNvbnN0IHN1YnNjcmlwdGlvbnMgPSBhd2FpdCBnZXRTdWJzY3JpcHRpb25zRHVlVG9kYXkoKTtcbiAgICBjb25zb2xlLmxvZyhgRm91bmQgJHtzdWJzY3JpcHRpb25zLmxlbmd0aH0gc3Vic2NyaXB0aW9ucyBkdWUgdG9kYXlgKTtcblxuICAgIGxldCBwcm9jZXNzZWRDb3VudCA9IDA7XG4gICAgbGV0IGVycm9yQ291bnQgPSAwO1xuXG4gICAgZm9yIChjb25zdCBzdWJzY3JpcHRpb24gb2Ygc3Vic2NyaXB0aW9ucykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgLy8gU2tpcCBpZiBzdWJzY3JpcHRpb24gaXMgc2V0IHRvIGNhbmNlbCBhdCBwZXJpb2QgZW5kXG4gICAgICAgIGlmIChzdWJzY3JpcHRpb24uY2FuY2VsX2F0X3BlcmlvZF9lbmQpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhgU2tpcHBpbmcgc3Vic2NyaXB0aW9uICR7c3Vic2NyaXB0aW9uLmlkfSAtIHNldCB0byBjYW5jZWxgKTtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFZhbGlkYXRlIHBheW1lbnQgc291cmNlIGlzIGF2YWlsYWJsZVxuICAgICAgICBpZiAoIXN1YnNjcmlwdGlvbi5wYXltZW50X3NvdXJjZXMgfHwgIWlzUGF5bWVudFNvdXJjZUF2YWlsYWJsZShzdWJzY3JpcHRpb24ucGF5bWVudF9zb3VyY2VzLnN0YXR1cykpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhgU2tpcHBpbmcgc3Vic2NyaXB0aW9uICR7c3Vic2NyaXB0aW9uLmlkfSAtIHBheW1lbnQgc291cmNlIG5vdCBhdmFpbGFibGVgKTtcbiAgICAgICAgICAvLyBNYXJrIHN1YnNjcmlwdGlvbiBhcyByZXF1aXJpbmcgYWN0aW9uXG4gICAgICAgICAgYXdhaXQgdXBkYXRlU3Vic2NyaXB0aW9uKHN1YnNjcmlwdGlvbi5pZCwgeyBzdGF0dXM6ICdwYXN0X2R1ZScgfSk7XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDcmVhdGUgaW52b2ljZVxuICAgICAgICBjb25zdCBpbnZvaWNlID0gYXdhaXQgY3JlYXRlSW52b2ljZSh7XG4gICAgICAgICAgc3Vic2NyaXB0aW9uX2lkOiBzdWJzY3JpcHRpb24uaWQsXG4gICAgICAgICAgd29ya3NwYWNlX2lkOiBzdWJzY3JpcHRpb24ud29ya3NwYWNlX2lkLFxuICAgICAgICAgIHBlcmlvZF9zdGFydDogc3Vic2NyaXB0aW9uLmN1cnJlbnRfcGVyaW9kX3N0YXJ0LFxuICAgICAgICAgIHBlcmlvZF9lbmQ6IHN1YnNjcmlwdGlvbi5jdXJyZW50X3BlcmlvZF9lbmQsXG4gICAgICAgICAgYW1vdW50X2luX2NlbnRzOiBzdWJzY3JpcHRpb24ucGxhbnMuYW1vdW50X2luX2NlbnRzLFxuICAgICAgICAgIHN0YXR1czogJ3BlbmRpbmcnXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKGBDcmVhdGVkIGludm9pY2UgJHtpbnZvaWNlLmlkfSBmb3Igc3Vic2NyaXB0aW9uICR7c3Vic2NyaXB0aW9uLmlkfWApO1xuXG4gICAgICAgIC8vIENyZWF0ZSB0cmFuc2FjdGlvbiBpbiBXb21waVxuICAgICAgICBjb25zdCByZWZlcmVuY2UgPSBnZW5lcmF0ZVRyYW5zYWN0aW9uUmVmZXJlbmNlKGludm9pY2UuaWQpO1xuICAgICAgICBjb25zdCB0cmFuc2FjdGlvbkRhdGEgPSB7XG4gICAgICAgICAgYW1vdW50X2luX2NlbnRzOiBzdWJzY3JpcHRpb24ucGxhbnMuYW1vdW50X2luX2NlbnRzLFxuICAgICAgICAgIGN1cnJlbmN5OiAnQ09QJyxcbiAgICAgICAgICBjdXN0b21lcl9lbWFpbDogc3Vic2NyaXB0aW9uLnBheW1lbnRfc291cmNlcy5jdXN0b21lcl9lbWFpbCxcbiAgICAgICAgICBwYXltZW50X21ldGhvZDoge1xuICAgICAgICAgICAgdHlwZTogc3Vic2NyaXB0aW9uLnBheW1lbnRfc291cmNlcy50eXBlLFxuICAgICAgICAgICAgaW5zdGFsbG1lbnRzOiAxXG4gICAgICAgICAgfSxcbiAgICAgICAgICBwYXltZW50X3NvdXJjZV9pZDogc3Vic2NyaXB0aW9uLnBheW1lbnRfc291cmNlcy53b21waV9pZCxcbiAgICAgICAgICByZWZlcmVuY2UsXG4gICAgICAgICAgcmVkaXJlY3RfdXJsOiBgJHtwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19BUFBfVVJMfS9iaWxsaW5nL3N1Y2Nlc3NgXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gQWRkIHJlY3VycmVudCBmbGFnIGZvciBjYXJkc1xuICAgICAgICBpZiAoc3Vic2NyaXB0aW9uLnBheW1lbnRfc291cmNlcy50eXBlID09PSAnQ0FSRCcpIHtcbiAgICAgICAgICB0cmFuc2FjdGlvbkRhdGEucmVjdXJyZW50ID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHdvbXBpVHJhbnNhY3Rpb24gPSBhd2FpdCB3b21waUNsaWVudC5jcmVhdGVUcmFuc2FjdGlvbih0cmFuc2FjdGlvbkRhdGEpO1xuICAgICAgICBjb25zb2xlLmxvZyhgQ3JlYXRlZCBXb21waSB0cmFuc2FjdGlvbiAke3dvbXBpVHJhbnNhY3Rpb24uaWR9IGZvciBpbnZvaWNlICR7aW52b2ljZS5pZH1gKTtcblxuICAgICAgICAvLyBTYXZlIHRyYW5zYWN0aW9uIHRvIGRhdGFiYXNlXG4gICAgICAgIGF3YWl0IGNyZWF0ZVRyYW5zYWN0aW9uKHtcbiAgICAgICAgICBpbnZvaWNlX2lkOiBpbnZvaWNlLmlkLFxuICAgICAgICAgIHdvcmtzcGFjZV9pZDogc3Vic2NyaXB0aW9uLndvcmtzcGFjZV9pZCxcbiAgICAgICAgICB3b21waV9pZDogd29tcGlUcmFuc2FjdGlvbi5pZCxcbiAgICAgICAgICBhbW91bnRfaW5fY2VudHM6IHdvbXBpVHJhbnNhY3Rpb24uYW1vdW50X2luX2NlbnRzLFxuICAgICAgICAgIHN0YXR1czogd29tcGlUcmFuc2FjdGlvbi5zdGF0dXMsXG4gICAgICAgICAgcGF5bWVudF9tZXRob2RfdHlwZTogc3Vic2NyaXB0aW9uLnBheW1lbnRfc291cmNlcy50eXBlLFxuICAgICAgICAgIHJlZmVyZW5jZTogd29tcGlUcmFuc2FjdGlvbi5yZWZlcmVuY2UsXG4gICAgICAgICAgc3RhdHVzX21lc3NhZ2U6IHdvbXBpVHJhbnNhY3Rpb24uc3RhdHVzX21lc3NhZ2UsXG4gICAgICAgICAgcmF3X3BheWxvYWQ6IHdvbXBpVHJhbnNhY3Rpb25cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gVXBkYXRlIGludm9pY2Ugd2l0aCB0cmFuc2FjdGlvbiBJRFxuICAgICAgICBhd2FpdCB1cGRhdGVJbnZvaWNlKGludm9pY2UuaWQsIHtcbiAgICAgICAgICB3b21waV90cmFuc2FjdGlvbl9pZDogd29tcGlUcmFuc2FjdGlvbi5pZFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBFeHRlbmQgc3Vic2NyaXB0aW9uIHBlcmlvZFxuICAgICAgICBjb25zdCBuZXdQZXJpb2RTdGFydCA9IG5ldyBEYXRlKHN1YnNjcmlwdGlvbi5jdXJyZW50X3BlcmlvZF9lbmQpO1xuICAgICAgICBjb25zdCBuZXdQZXJpb2RFbmQgPSBuZXcgRGF0ZShuZXdQZXJpb2RTdGFydCk7XG4gICAgICAgIG5ld1BlcmlvZEVuZC5zZXRNb250aChuZXdQZXJpb2RFbmQuZ2V0TW9udGgoKSArIDEpO1xuXG4gICAgICAgIGF3YWl0IHVwZGF0ZVN1YnNjcmlwdGlvbihzdWJzY3JpcHRpb24uaWQsIHtcbiAgICAgICAgICBjdXJyZW50X3BlcmlvZF9zdGFydDogbmV3UGVyaW9kU3RhcnQudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICBjdXJyZW50X3BlcmlvZF9lbmQ6IG5ld1BlcmlvZEVuZC50b0lTT1N0cmluZygpXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKGBFeHRlbmRlZCBzdWJzY3JpcHRpb24gJHtzdWJzY3JpcHRpb24uaWR9IHBlcmlvZGApO1xuICAgICAgICBwcm9jZXNzZWRDb3VudCsrO1xuXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBwcm9jZXNzaW5nIHN1YnNjcmlwdGlvbiAke3N1YnNjcmlwdGlvbi5pZH06YCwgZXJyb3IpO1xuICAgICAgICBlcnJvckNvdW50Kys7XG4gICAgICAgIFxuICAgICAgICAvLyBNYXJrIHN1YnNjcmlwdGlvbiBhcyBwYXN0IGR1ZSBpZiB0aGVyZSdzIGFuIGVycm9yXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgdXBkYXRlU3Vic2NyaXB0aW9uKHN1YnNjcmlwdGlvbi5pZCwgeyBzdGF0dXM6ICdwYXN0X2R1ZScgfSk7XG4gICAgICAgIH0gY2F0Y2ggKHVwZGF0ZUVycm9yKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgdXBkYXRpbmcgc3Vic2NyaXB0aW9uICR7c3Vic2NyaXB0aW9uLmlkfSBzdGF0dXM6YCwgdXBkYXRlRXJyb3IpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coYEJpbGxpbmcgY3JvbiBjb21wbGV0ZWQuIFByb2Nlc3NlZDogJHtwcm9jZXNzZWRDb3VudH0sIEVycm9yczogJHtlcnJvckNvdW50fWApO1xuXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBwcm9jZXNzZWQ6IHByb2Nlc3NlZENvdW50LFxuICAgICAgZXJyb3JzOiBlcnJvckNvdW50LFxuICAgICAgdG90YWxfc3Vic2NyaXB0aW9uczogc3Vic2NyaXB0aW9ucy5sZW5ndGhcbiAgICB9KTtcblxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0JpbGxpbmcgY3JvbiBlcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgeyBlcnJvcjogJ0JpbGxpbmcgY3JvbiBmYWlsZWQnIH0sIFxuICAgICAgeyBzdGF0dXM6IDUwMCB9XG4gICAgKTtcbiAgfVxuICAqL1xufVxuXG5cblxuXG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBV0E7SUFBQUEsY0FBQSxZQUFBQSxDQUFBO01BQUEsT0FBQUMsY0FBQTtJQUFBO0VBQUE7RUFBQSxPQUFBQSxjQUFBO0FBQUE7QUFBQUQsY0FBQTtBQUFBQSxjQUFBLEdBQUFFLENBQUE7Ozs7Ozs7OztBQUtBQyxPQUFBLENBQUFDLEdBQUEsR0FBQUEsR0FBQTtBQWhCQTtBQUNBLE1BQUFDLFFBQUE7QUFBQTtBQUFBLENBQUFMLGNBQUEsR0FBQUUsQ0FBQSxPQUFBSSxPQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUFBO0FBQUFOLGNBQUEsR0FBQUUsQ0FBQTtBQUVhQyxPQUFBLENBQUFJLE9BQU8sR0FBRyxlQUFlO0FBRS9CLGVBQWVILEdBQUdBLENBQUNJLEdBQWdCO0VBQUE7RUFBQVIsY0FBQSxHQUFBUyxDQUFBO0VBQUFULGNBQUEsR0FBQUUsQ0FBQTtFQUN4QztFQUNBLE9BQU9HLFFBQUEsQ0FBQUssWUFBWSxDQUFDQyxJQUFJLENBQ3RCO0lBQ0VDLE9BQU8sRUFBRSxvREFBb0Q7SUFDN0RDLE1BQU0sRUFBRTtHQUNULEVBQ0Q7SUFBRUEsTUFBTSxFQUFFO0VBQUcsQ0FBRSxDQUNoQjtFQUVEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUE0SUYiLCJpZ25vcmVMaXN0IjpbXX0=