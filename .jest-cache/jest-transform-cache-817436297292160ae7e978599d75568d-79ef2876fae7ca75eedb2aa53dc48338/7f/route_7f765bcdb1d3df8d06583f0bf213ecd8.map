{"version":3,"names":["cov_2djqih17wz","actualCoverage","s","exports","GET","server_1","require","dynamic","req","f","NextResponse","json","message","status"],"sources":["C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\app\\api\\cron\\billing\\route.ts"],"sourcesContent":["// app/api/cron/billing/route.ts\nimport { NextRequest, NextResponse } from 'next/server';\n// ELIMINADO - Sistema de billing removido\n// import { wompiClient } from '@/lib/wompi/client';\n// import { wompiConfig } from '@/lib/wompi/config';\n// import { \n//   getSubscriptionsDueToday, \n//   createInvoice, \n//   createTransaction, \n//   updateInvoice,\n//   updateSubscription \n// } from '@/db/billing';\n// import { generateTransactionReference, isPaymentSourceAvailable } from '@/lib/wompi/utils';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function GET(req: NextRequest) {\n  // ELIMINADO - Sistema de billing removido\n  return NextResponse.json(\n    { \n      message: 'Sistema de facturaci√≥n temporalmente deshabilitado',\n      status: 'disabled'\n    }, \n    { status: 200 }\n  );\n  \n  /*\n  try {\n    // Validate cron secret\n    const authHeader = req.headers.get('Authorization');\n    if (!authHeader || authHeader !== `Bearer ${wompiConfig.cronSecret}`) {\n      return NextResponse.json(\n        { error: 'Unauthorized' }, \n        { status: 401 }\n      );\n    }\n\n    // Check if billing is enabled\n    if (!wompiConfig.isEnabled) {\n      return NextResponse.json(\n        { error: 'Billing is not enabled' }, \n        { status: 403 }\n      );\n    }\n\n    console.log('Starting billing cron job...');\n\n    // Get subscriptions due today\n    const subscriptions = await getSubscriptionsDueToday();\n    console.log(`Found ${subscriptions.length} subscriptions due today`);\n\n    let processedCount = 0;\n    let errorCount = 0;\n\n    for (const subscription of subscriptions) {\n      try {\n        // Skip if subscription is set to cancel at period end\n        if (subscription.cancel_at_period_end) {\n          console.log(`Skipping subscription ${subscription.id} - set to cancel`);\n          continue;\n        }\n\n        // Validate payment source is available\n        if (!subscription.payment_sources || !isPaymentSourceAvailable(subscription.payment_sources.status)) {\n          console.log(`Skipping subscription ${subscription.id} - payment source not available`);\n          // Mark subscription as requiring action\n          await updateSubscription(subscription.id, { status: 'past_due' });\n          continue;\n        }\n\n        // Create invoice\n        const invoice = await createInvoice({\n          subscription_id: subscription.id,\n          workspace_id: subscription.workspace_id,\n          period_start: subscription.current_period_start,\n          period_end: subscription.current_period_end,\n          amount_in_cents: subscription.plans.amount_in_cents,\n          status: 'pending'\n        });\n\n        console.log(`Created invoice ${invoice.id} for subscription ${subscription.id}`);\n\n        // Create transaction in Wompi\n        const reference = generateTransactionReference(invoice.id);\n        const transactionData = {\n          amount_in_cents: subscription.plans.amount_in_cents,\n          currency: 'COP',\n          customer_email: subscription.payment_sources.customer_email,\n          payment_method: {\n            type: subscription.payment_sources.type,\n            installments: 1\n          },\n          payment_source_id: subscription.payment_sources.wompi_id,\n          reference,\n          redirect_url: `${process.env.NEXT_PUBLIC_APP_URL}/billing/success`\n        };\n\n        // Add recurrent flag for cards\n        if (subscription.payment_sources.type === 'CARD') {\n          transactionData.recurrent = true;\n        }\n\n        const wompiTransaction = await wompiClient.createTransaction(transactionData);\n        console.log(`Created Wompi transaction ${wompiTransaction.id} for invoice ${invoice.id}`);\n\n        // Save transaction to database\n        await createTransaction({\n          invoice_id: invoice.id,\n          workspace_id: subscription.workspace_id,\n          wompi_id: wompiTransaction.id,\n          amount_in_cents: wompiTransaction.amount_in_cents,\n          status: wompiTransaction.status,\n          payment_method_type: subscription.payment_sources.type,\n          reference: wompiTransaction.reference,\n          status_message: wompiTransaction.status_message,\n          raw_payload: wompiTransaction\n        });\n\n        // Update invoice with transaction ID\n        await updateInvoice(invoice.id, {\n          wompi_transaction_id: wompiTransaction.id\n        });\n\n        // Extend subscription period\n        const newPeriodStart = new Date(subscription.current_period_end);\n        const newPeriodEnd = new Date(newPeriodStart);\n        newPeriodEnd.setMonth(newPeriodEnd.getMonth() + 1);\n\n        await updateSubscription(subscription.id, {\n          current_period_start: newPeriodStart.toISOString(),\n          current_period_end: newPeriodEnd.toISOString()\n        });\n\n        console.log(`Extended subscription ${subscription.id} period`);\n        processedCount++;\n\n      } catch (error) {\n        console.error(`Error processing subscription ${subscription.id}:`, error);\n        errorCount++;\n        \n        // Mark subscription as past due if there's an error\n        try {\n          await updateSubscription(subscription.id, { status: 'past_due' });\n        } catch (updateError) {\n          console.error(`Error updating subscription ${subscription.id} status:`, updateError);\n        }\n      }\n    }\n\n    console.log(`Billing cron completed. Processed: ${processedCount}, Errors: ${errorCount}`);\n\n    return NextResponse.json({\n      success: true,\n      processed: processedCount,\n      errors: errorCount,\n      total_subscriptions: subscriptions.length\n    });\n\n  } catch (error) {\n    console.error('Billing cron error:', error);\n    return NextResponse.json(\n      { error: 'Billing cron failed' }, \n      { status: 500 }\n    );\n  }\n  */\n}\n\n\n\n\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAWA;IAAAA,cAAA,YAAAA,CAAA;MAAA,OAAAC,cAAA;IAAA;EAAA;EAAA,OAAAA,cAAA;AAAA;AAAAD,cAAA;AAAAA,cAAA,GAAAE,CAAA;;;;;;;;;AAKAC,OAAA,CAAAC,GAAA,GAAAA,GAAA;AAhBA;AACA,MAAAC,QAAA;AAAA;AAAA,CAAAL,cAAA,GAAAE,CAAA,OAAAI,OAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAAN,cAAA,GAAAE,CAAA;AAEaC,OAAA,CAAAI,OAAO,GAAG,eAAe;AAE/B,eAAeH,GAAGA,CAACI,GAAgB;EAAA;EAAAR,cAAA,GAAAS,CAAA;EAAAT,cAAA,GAAAE,CAAA;EACxC;EACA,OAAOG,QAAA,CAAAK,YAAY,CAACC,IAAI,CACtB;IACEC,OAAO,EAAE,oDAAoD;IAC7DC,MAAM,EAAE;GACT,EACD;IAAEA,MAAM,EAAE;EAAG,CAAE,CAChB;EAED;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA4IF","ignoreList":[]}