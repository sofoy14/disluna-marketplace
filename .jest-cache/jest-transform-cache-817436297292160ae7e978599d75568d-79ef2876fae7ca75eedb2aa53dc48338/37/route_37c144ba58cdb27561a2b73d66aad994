1230793fbf827774dfab4fd42f2bbd60
"use strict";

/* istanbul ignore next */
function cov_2x56teek7() {
  var path = "C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\app\\api\\cron\\dunning\\route.ts";
  var hash = "753ba7d8dc40d1672b7066c410cc2eefcb5e5506";
  var global = new Function("return this")();
  var gcv = "__coverage__";
  var coverageData = {
    path: "C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\app\\api\\cron\\dunning\\route.ts",
    statementMap: {
      "0": {
        start: {
          line: 2,
          column: 0
        },
        end: {
          line: 2,
          column: 62
        }
      },
      "1": {
        start: {
          line: 3,
          column: 0
        },
        end: {
          line: 3,
          column: 25
        }
      },
      "2": {
        start: {
          line: 4,
          column: 0
        },
        end: {
          line: 4,
          column: 18
        }
      },
      "3": {
        start: {
          line: 6,
          column: 17
        },
        end: {
          line: 6,
          column: 39
        }
      },
      "4": {
        start: {
          line: 18,
          column: 0
        },
        end: {
          line: 18,
          column: 34
        }
      },
      "5": {
        start: {
          line: 21,
          column: 4
        },
        end: {
          line: 24,
          column: 24
        }
      }
    },
    fnMap: {
      "0": {
        name: "GET",
        decl: {
          start: {
            line: 19,
            column: 15
          },
          end: {
            line: 19,
            column: 18
          }
        },
        loc: {
          start: {
            line: 19,
            column: 24
          },
          end: {
            line: 158,
            column: 1
          }
        },
        line: 19
      }
    },
    branchMap: {},
    s: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0
    },
    f: {
      "0": 0
    },
    b: {},
    inputSourceMap: {
      file: "C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\app\\api\\cron\\dunning\\route.ts",
      mappings: ";;;AAgBA,kBA+IC;AA/JD,gCAAgC;AAChC,wCAAwD;AACxD,0CAA0C;AAC1C,oDAAoD;AACpD,oDAAoD;AACpD,YAAY;AACZ,gCAAgC;AAChC,0BAA0B;AAC1B,mBAAmB;AACnB,wBAAwB;AACxB,uBAAuB;AACvB,yBAAyB;AACzB,8DAA8D;AAEjD,QAAA,OAAO,GAAG,eAAe,CAAC;AAEhC,KAAK,UAAU,GAAG,CAAC,GAAgB;IACxC,0CAA0C;IAC1C,OAAO,qBAAY,CAAC,IAAI,CACtB;QACE,OAAO,EAAE,gDAAgD;QACzD,MAAM,EAAE,UAAU;KACnB,EACD,EAAE,MAAM,EAAE,GAAG,EAAE,CAChB,CAAC;IAEF;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;MAoIE;AACJ,CAAC",
      names: [],
      sources: ["C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\app\\api\\cron\\dunning\\route.ts"],
      sourcesContent: ["// app/api/cron/dunning/route.ts\nimport { NextRequest, NextResponse } from 'next/server';\n// ELIMINADO - Sistema de billing removido\n// import { wompiClient } from '@/lib/wompi/client';\n// import { wompiConfig } from '@/lib/wompi/config';\n// import { \n//   getFailedInvoicesForRetry, \n//   getSuspendedInvoices,\n//   updateInvoice,\n//   updateSubscription,\n//   createTransaction \n// } from '@/db/billing';\n// import { generateRetryReference } from '@/lib/wompi/utils';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function GET(req: NextRequest) {\n  // ELIMINADO - Sistema de billing removido\n  return NextResponse.json(\n    { \n      message: 'Sistema de dunning temporalmente deshabilitado',\n      status: 'disabled'\n    }, \n    { status: 200 }\n  );\n  \n  /*\n  try {\n    // Validate cron secret\n    const authHeader = req.headers.get('Authorization');\n    if (!authHeader || authHeader !== `Bearer ${wompiConfig.cronSecret}`) {\n      return NextResponse.json(\n        { error: 'Unauthorized' }, \n        { status: 401 }\n      );\n    }\n\n    // Check if billing is enabled\n    if (!wompiConfig.isEnabled) {\n      return NextResponse.json(\n        { error: 'Billing is not enabled' }, \n        { status: 403 }\n      );\n    }\n\n    console.log('Starting dunning cron job...');\n\n    // Process failed invoices for retry\n    const failedInvoices = await getFailedInvoicesForRetry();\n    console.log(`Found ${failedInvoices.length} failed invoices for retry`);\n\n    let retriedCount = 0;\n    let retryErrorCount = 0;\n\n    for (const invoice of failedInvoices) {\n      try {\n        console.log(`Retrying invoice ${invoice.id} (attempt ${invoice.attempt_count + 1})`);\n\n        // Create retry transaction in Wompi\n        const reference = generateRetryReference(invoice.id, invoice.attempt_count + 1);\n        const transactionData = {\n          amount_in_cents: invoice.amount_in_cents,\n          currency: 'COP',\n          customer_email: invoice.subscriptions.payment_sources.customer_email,\n          payment_method: {\n            type: invoice.subscriptions.payment_sources.type,\n            installments: 1\n          },\n          payment_source_id: invoice.subscriptions.payment_sources.wompi_id,\n          reference,\n          redirect_url: `${process.env.NEXT_PUBLIC_APP_URL}/billing/success`\n        };\n\n        // Add recurrent flag for cards\n        if (invoice.subscriptions.payment_sources.type === 'CARD') {\n          transactionData.recurrent = true;\n        }\n\n        const wompiTransaction = await wompiClient.createTransaction(transactionData);\n        console.log(`Created retry transaction ${wompiTransaction.id} for invoice ${invoice.id}`);\n\n        // Save transaction to database\n        await createTransaction({\n          invoice_id: invoice.id,\n          workspace_id: invoice.workspace_id,\n          wompi_id: wompiTransaction.id,\n          amount_in_cents: wompiTransaction.amount_in_cents,\n          status: wompiTransaction.status,\n          payment_method_type: invoice.subscriptions.payment_sources.type,\n          reference: wompiTransaction.reference,\n          status_message: wompiTransaction.status_message,\n          raw_payload: wompiTransaction\n        });\n\n        // Update invoice with new transaction ID\n        await updateInvoice(invoice.id, {\n          wompi_transaction_id: wompiTransaction.id,\n          attempt_count: invoice.attempt_count + 1\n        });\n\n        // TODO: Send retry notification email\n        console.log(`Retry transaction created for invoice ${invoice.id}`);\n        retriedCount++;\n\n      } catch (error) {\n        console.error(`Error retrying invoice ${invoice.id}:`, error);\n        retryErrorCount++;\n        \n        // Update attempt count even if retry failed\n        try {\n          await updateInvoice(invoice.id, {\n            attempt_count: invoice.attempt_count + 1\n          });\n        } catch (updateError) {\n          console.error(`Error updating invoice ${invoice.id} attempt count:`, updateError);\n        }\n      }\n    }\n\n    // Suspend subscriptions with too many failed attempts\n    const suspendedInvoices = await getSuspendedInvoices();\n    console.log(`Found ${suspendedInvoices.length} invoices to suspend subscriptions`);\n\n    let suspendedCount = 0;\n\n    for (const invoice of suspendedInvoices) {\n      try {\n        await updateSubscription(invoice.subscription_id, {\n          status: 'past_due'\n        });\n\n        // TODO: Send suspension notification email\n        console.log(`Suspended subscription ${invoice.subscription_id}`);\n        suspendedCount++;\n\n      } catch (error) {\n        console.error(`Error suspending subscription ${invoice.subscription_id}:`, error);\n      }\n    }\n\n    console.log(`Dunning cron completed. Retried: ${retriedCount}, Retry errors: ${retryErrorCount}, Suspended: ${suspendedCount}`);\n\n    return NextResponse.json({\n      success: true,\n      retried: retriedCount,\n      retry_errors: retryErrorCount,\n      suspended: suspendedCount,\n      total_failed_invoices: failedInvoices.length,\n      total_suspended_invoices: suspendedInvoices.length\n    });\n\n  } catch (error) {\n    console.error('Dunning cron error:', error);\n    return NextResponse.json(\n      { error: 'Dunning cron failed' }, \n      { status: 500 }\n    );\n  }\n  */\n}\n\n\n\n\n"],
      version: 3
    },
    _coverageSchema: "1a1c01bbd47fc00a2c39e90264f33305004495a9",
    hash: "753ba7d8dc40d1672b7066c410cc2eefcb5e5506"
  };
  var coverage = global[gcv] || (global[gcv] = {});
  if (!coverage[path] || coverage[path].hash !== hash) {
    coverage[path] = coverageData;
  }
  var actualCoverage = coverage[path];
  {
    // @ts-ignore
    cov_2x56teek7 = function () {
      return actualCoverage;
    };
  }
  return actualCoverage;
}
cov_2x56teek7();
cov_2x56teek7().s[0]++;
Object.defineProperty(exports, "__esModule", {
  value: true
});
/* istanbul ignore next */
cov_2x56teek7().s[1]++;
exports.dynamic = void 0;
/* istanbul ignore next */
cov_2x56teek7().s[2]++;
exports.GET = GET;
// app/api/cron/dunning/route.ts
const server_1 =
/* istanbul ignore next */
(cov_2x56teek7().s[3]++, require("next/server"));
// ELIMINADO - Sistema de billing removido
// import { wompiClient } from '@/lib/wompi/client';
// import { wompiConfig } from '@/lib/wompi/config';
// import { 
//   getFailedInvoicesForRetry, 
//   getSuspendedInvoices,
//   updateInvoice,
//   updateSubscription,
//   createTransaction 
// } from '@/db/billing';
// import { generateRetryReference } from '@/lib/wompi/utils';
/* istanbul ignore next */
cov_2x56teek7().s[4]++;
exports.dynamic = 'force-dynamic';
async function GET(req) {
  /* istanbul ignore next */
  cov_2x56teek7().f[0]++;
  cov_2x56teek7().s[5]++;
  // ELIMINADO - Sistema de billing removido
  return server_1.NextResponse.json({
    message: 'Sistema de dunning temporalmente deshabilitado',
    status: 'disabled'
  }, {
    status: 200
  });
  /*
  try {
    // Validate cron secret
    const authHeader = req.headers.get('Authorization');
    if (!authHeader || authHeader !== `Bearer ${wompiConfig.cronSecret}`) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }
       // Check if billing is enabled
    if (!wompiConfig.isEnabled) {
      return NextResponse.json(
        { error: 'Billing is not enabled' },
        { status: 403 }
      );
    }
       console.log('Starting dunning cron job...');
       // Process failed invoices for retry
    const failedInvoices = await getFailedInvoicesForRetry();
    console.log(`Found ${failedInvoices.length} failed invoices for retry`);
       let retriedCount = 0;
    let retryErrorCount = 0;
       for (const invoice of failedInvoices) {
      try {
        console.log(`Retrying invoice ${invoice.id} (attempt ${invoice.attempt_count + 1})`);
           // Create retry transaction in Wompi
        const reference = generateRetryReference(invoice.id, invoice.attempt_count + 1);
        const transactionData = {
          amount_in_cents: invoice.amount_in_cents,
          currency: 'COP',
          customer_email: invoice.subscriptions.payment_sources.customer_email,
          payment_method: {
            type: invoice.subscriptions.payment_sources.type,
            installments: 1
          },
          payment_source_id: invoice.subscriptions.payment_sources.wompi_id,
          reference,
          redirect_url: `${process.env.NEXT_PUBLIC_APP_URL}/billing/success`
        };
           // Add recurrent flag for cards
        if (invoice.subscriptions.payment_sources.type === 'CARD') {
          transactionData.recurrent = true;
        }
           const wompiTransaction = await wompiClient.createTransaction(transactionData);
        console.log(`Created retry transaction ${wompiTransaction.id} for invoice ${invoice.id}`);
           // Save transaction to database
        await createTransaction({
          invoice_id: invoice.id,
          workspace_id: invoice.workspace_id,
          wompi_id: wompiTransaction.id,
          amount_in_cents: wompiTransaction.amount_in_cents,
          status: wompiTransaction.status,
          payment_method_type: invoice.subscriptions.payment_sources.type,
          reference: wompiTransaction.reference,
          status_message: wompiTransaction.status_message,
          raw_payload: wompiTransaction
        });
           // Update invoice with new transaction ID
        await updateInvoice(invoice.id, {
          wompi_transaction_id: wompiTransaction.id,
          attempt_count: invoice.attempt_count + 1
        });
           // TODO: Send retry notification email
        console.log(`Retry transaction created for invoice ${invoice.id}`);
        retriedCount++;
         } catch (error) {
        console.error(`Error retrying invoice ${invoice.id}:`, error);
        retryErrorCount++;
        
        // Update attempt count even if retry failed
        try {
          await updateInvoice(invoice.id, {
            attempt_count: invoice.attempt_count + 1
          });
        } catch (updateError) {
          console.error(`Error updating invoice ${invoice.id} attempt count:`, updateError);
        }
      }
    }
       // Suspend subscriptions with too many failed attempts
    const suspendedInvoices = await getSuspendedInvoices();
    console.log(`Found ${suspendedInvoices.length} invoices to suspend subscriptions`);
       let suspendedCount = 0;
       for (const invoice of suspendedInvoices) {
      try {
        await updateSubscription(invoice.subscription_id, {
          status: 'past_due'
        });
           // TODO: Send suspension notification email
        console.log(`Suspended subscription ${invoice.subscription_id}`);
        suspendedCount++;
         } catch (error) {
        console.error(`Error suspending subscription ${invoice.subscription_id}:`, error);
      }
    }
       console.log(`Dunning cron completed. Retried: ${retriedCount}, Retry errors: ${retryErrorCount}, Suspended: ${suspendedCount}`);
       return NextResponse.json({
      success: true,
      retried: retriedCount,
      retry_errors: retryErrorCount,
      suspended: suspendedCount,
      total_failed_invoices: failedInvoices.length,
      total_suspended_invoices: suspendedInvoices.length
    });
     } catch (error) {
    console.error('Dunning cron error:', error);
    return NextResponse.json(
      { error: 'Dunning cron failed' },
      { status: 500 }
    );
  }
  */
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb3ZfMng1NnRlZWs3IiwiYWN0dWFsQ292ZXJhZ2UiLCJzIiwiZXhwb3J0cyIsIkdFVCIsInNlcnZlcl8xIiwicmVxdWlyZSIsImR5bmFtaWMiLCJyZXEiLCJmIiwiTmV4dFJlc3BvbnNlIiwianNvbiIsIm1lc3NhZ2UiLCJzdGF0dXMiXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHBlZHJvXFxEb2N1bWVudHNcXEdpdEh1YlxcQXNpc3RlbnRlLUxlZ2FsLUludGVsaWdlbnRlXFxhcHBcXGFwaVxcY3JvblxcZHVubmluZ1xccm91dGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gYXBwL2FwaS9jcm9uL2R1bm5pbmcvcm91dGUudHNcbmltcG9ydCB7IE5leHRSZXF1ZXN0LCBOZXh0UmVzcG9uc2UgfSBmcm9tICduZXh0L3NlcnZlcic7XG4vLyBFTElNSU5BRE8gLSBTaXN0ZW1hIGRlIGJpbGxpbmcgcmVtb3ZpZG9cbi8vIGltcG9ydCB7IHdvbXBpQ2xpZW50IH0gZnJvbSAnQC9saWIvd29tcGkvY2xpZW50Jztcbi8vIGltcG9ydCB7IHdvbXBpQ29uZmlnIH0gZnJvbSAnQC9saWIvd29tcGkvY29uZmlnJztcbi8vIGltcG9ydCB7IFxuLy8gICBnZXRGYWlsZWRJbnZvaWNlc0ZvclJldHJ5LCBcbi8vICAgZ2V0U3VzcGVuZGVkSW52b2ljZXMsXG4vLyAgIHVwZGF0ZUludm9pY2UsXG4vLyAgIHVwZGF0ZVN1YnNjcmlwdGlvbixcbi8vICAgY3JlYXRlVHJhbnNhY3Rpb24gXG4vLyB9IGZyb20gJ0AvZGIvYmlsbGluZyc7XG4vLyBpbXBvcnQgeyBnZW5lcmF0ZVJldHJ5UmVmZXJlbmNlIH0gZnJvbSAnQC9saWIvd29tcGkvdXRpbHMnO1xuXG5leHBvcnQgY29uc3QgZHluYW1pYyA9ICdmb3JjZS1keW5hbWljJztcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIEdFVChyZXE6IE5leHRSZXF1ZXN0KSB7XG4gIC8vIEVMSU1JTkFETyAtIFNpc3RlbWEgZGUgYmlsbGluZyByZW1vdmlkb1xuICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgeyBcbiAgICAgIG1lc3NhZ2U6ICdTaXN0ZW1hIGRlIGR1bm5pbmcgdGVtcG9yYWxtZW50ZSBkZXNoYWJpbGl0YWRvJyxcbiAgICAgIHN0YXR1czogJ2Rpc2FibGVkJ1xuICAgIH0sIFxuICAgIHsgc3RhdHVzOiAyMDAgfVxuICApO1xuICBcbiAgLypcbiAgdHJ5IHtcbiAgICAvLyBWYWxpZGF0ZSBjcm9uIHNlY3JldFxuICAgIGNvbnN0IGF1dGhIZWFkZXIgPSByZXEuaGVhZGVycy5nZXQoJ0F1dGhvcml6YXRpb24nKTtcbiAgICBpZiAoIWF1dGhIZWFkZXIgfHwgYXV0aEhlYWRlciAhPT0gYEJlYXJlciAke3dvbXBpQ29uZmlnLmNyb25TZWNyZXR9YCkge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9LCBcbiAgICAgICAgeyBzdGF0dXM6IDQwMSB9XG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIGJpbGxpbmcgaXMgZW5hYmxlZFxuICAgIGlmICghd29tcGlDb25maWcuaXNFbmFibGVkKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgZXJyb3I6ICdCaWxsaW5nIGlzIG5vdCBlbmFibGVkJyB9LCBcbiAgICAgICAgeyBzdGF0dXM6IDQwMyB9XG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKCdTdGFydGluZyBkdW5uaW5nIGNyb24gam9iLi4uJyk7XG5cbiAgICAvLyBQcm9jZXNzIGZhaWxlZCBpbnZvaWNlcyBmb3IgcmV0cnlcbiAgICBjb25zdCBmYWlsZWRJbnZvaWNlcyA9IGF3YWl0IGdldEZhaWxlZEludm9pY2VzRm9yUmV0cnkoKTtcbiAgICBjb25zb2xlLmxvZyhgRm91bmQgJHtmYWlsZWRJbnZvaWNlcy5sZW5ndGh9IGZhaWxlZCBpbnZvaWNlcyBmb3IgcmV0cnlgKTtcblxuICAgIGxldCByZXRyaWVkQ291bnQgPSAwO1xuICAgIGxldCByZXRyeUVycm9yQ291bnQgPSAwO1xuXG4gICAgZm9yIChjb25zdCBpbnZvaWNlIG9mIGZhaWxlZEludm9pY2VzKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zb2xlLmxvZyhgUmV0cnlpbmcgaW52b2ljZSAke2ludm9pY2UuaWR9IChhdHRlbXB0ICR7aW52b2ljZS5hdHRlbXB0X2NvdW50ICsgMX0pYCk7XG5cbiAgICAgICAgLy8gQ3JlYXRlIHJldHJ5IHRyYW5zYWN0aW9uIGluIFdvbXBpXG4gICAgICAgIGNvbnN0IHJlZmVyZW5jZSA9IGdlbmVyYXRlUmV0cnlSZWZlcmVuY2UoaW52b2ljZS5pZCwgaW52b2ljZS5hdHRlbXB0X2NvdW50ICsgMSk7XG4gICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uRGF0YSA9IHtcbiAgICAgICAgICBhbW91bnRfaW5fY2VudHM6IGludm9pY2UuYW1vdW50X2luX2NlbnRzLFxuICAgICAgICAgIGN1cnJlbmN5OiAnQ09QJyxcbiAgICAgICAgICBjdXN0b21lcl9lbWFpbDogaW52b2ljZS5zdWJzY3JpcHRpb25zLnBheW1lbnRfc291cmNlcy5jdXN0b21lcl9lbWFpbCxcbiAgICAgICAgICBwYXltZW50X21ldGhvZDoge1xuICAgICAgICAgICAgdHlwZTogaW52b2ljZS5zdWJzY3JpcHRpb25zLnBheW1lbnRfc291cmNlcy50eXBlLFxuICAgICAgICAgICAgaW5zdGFsbG1lbnRzOiAxXG4gICAgICAgICAgfSxcbiAgICAgICAgICBwYXltZW50X3NvdXJjZV9pZDogaW52b2ljZS5zdWJzY3JpcHRpb25zLnBheW1lbnRfc291cmNlcy53b21waV9pZCxcbiAgICAgICAgICByZWZlcmVuY2UsXG4gICAgICAgICAgcmVkaXJlY3RfdXJsOiBgJHtwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19BUFBfVVJMfS9iaWxsaW5nL3N1Y2Nlc3NgXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gQWRkIHJlY3VycmVudCBmbGFnIGZvciBjYXJkc1xuICAgICAgICBpZiAoaW52b2ljZS5zdWJzY3JpcHRpb25zLnBheW1lbnRfc291cmNlcy50eXBlID09PSAnQ0FSRCcpIHtcbiAgICAgICAgICB0cmFuc2FjdGlvbkRhdGEucmVjdXJyZW50ID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHdvbXBpVHJhbnNhY3Rpb24gPSBhd2FpdCB3b21waUNsaWVudC5jcmVhdGVUcmFuc2FjdGlvbih0cmFuc2FjdGlvbkRhdGEpO1xuICAgICAgICBjb25zb2xlLmxvZyhgQ3JlYXRlZCByZXRyeSB0cmFuc2FjdGlvbiAke3dvbXBpVHJhbnNhY3Rpb24uaWR9IGZvciBpbnZvaWNlICR7aW52b2ljZS5pZH1gKTtcblxuICAgICAgICAvLyBTYXZlIHRyYW5zYWN0aW9uIHRvIGRhdGFiYXNlXG4gICAgICAgIGF3YWl0IGNyZWF0ZVRyYW5zYWN0aW9uKHtcbiAgICAgICAgICBpbnZvaWNlX2lkOiBpbnZvaWNlLmlkLFxuICAgICAgICAgIHdvcmtzcGFjZV9pZDogaW52b2ljZS53b3Jrc3BhY2VfaWQsXG4gICAgICAgICAgd29tcGlfaWQ6IHdvbXBpVHJhbnNhY3Rpb24uaWQsXG4gICAgICAgICAgYW1vdW50X2luX2NlbnRzOiB3b21waVRyYW5zYWN0aW9uLmFtb3VudF9pbl9jZW50cyxcbiAgICAgICAgICBzdGF0dXM6IHdvbXBpVHJhbnNhY3Rpb24uc3RhdHVzLFxuICAgICAgICAgIHBheW1lbnRfbWV0aG9kX3R5cGU6IGludm9pY2Uuc3Vic2NyaXB0aW9ucy5wYXltZW50X3NvdXJjZXMudHlwZSxcbiAgICAgICAgICByZWZlcmVuY2U6IHdvbXBpVHJhbnNhY3Rpb24ucmVmZXJlbmNlLFxuICAgICAgICAgIHN0YXR1c19tZXNzYWdlOiB3b21waVRyYW5zYWN0aW9uLnN0YXR1c19tZXNzYWdlLFxuICAgICAgICAgIHJhd19wYXlsb2FkOiB3b21waVRyYW5zYWN0aW9uXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFVwZGF0ZSBpbnZvaWNlIHdpdGggbmV3IHRyYW5zYWN0aW9uIElEXG4gICAgICAgIGF3YWl0IHVwZGF0ZUludm9pY2UoaW52b2ljZS5pZCwge1xuICAgICAgICAgIHdvbXBpX3RyYW5zYWN0aW9uX2lkOiB3b21waVRyYW5zYWN0aW9uLmlkLFxuICAgICAgICAgIGF0dGVtcHRfY291bnQ6IGludm9pY2UuYXR0ZW1wdF9jb3VudCArIDFcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gVE9ETzogU2VuZCByZXRyeSBub3RpZmljYXRpb24gZW1haWxcbiAgICAgICAgY29uc29sZS5sb2coYFJldHJ5IHRyYW5zYWN0aW9uIGNyZWF0ZWQgZm9yIGludm9pY2UgJHtpbnZvaWNlLmlkfWApO1xuICAgICAgICByZXRyaWVkQ291bnQrKztcblxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgcmV0cnlpbmcgaW52b2ljZSAke2ludm9pY2UuaWR9OmAsIGVycm9yKTtcbiAgICAgICAgcmV0cnlFcnJvckNvdW50Kys7XG4gICAgICAgIFxuICAgICAgICAvLyBVcGRhdGUgYXR0ZW1wdCBjb3VudCBldmVuIGlmIHJldHJ5IGZhaWxlZFxuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHVwZGF0ZUludm9pY2UoaW52b2ljZS5pZCwge1xuICAgICAgICAgICAgYXR0ZW1wdF9jb3VudDogaW52b2ljZS5hdHRlbXB0X2NvdW50ICsgMVxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoICh1cGRhdGVFcnJvcikge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIHVwZGF0aW5nIGludm9pY2UgJHtpbnZvaWNlLmlkfSBhdHRlbXB0IGNvdW50OmAsIHVwZGF0ZUVycm9yKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFN1c3BlbmQgc3Vic2NyaXB0aW9ucyB3aXRoIHRvbyBtYW55IGZhaWxlZCBhdHRlbXB0c1xuICAgIGNvbnN0IHN1c3BlbmRlZEludm9pY2VzID0gYXdhaXQgZ2V0U3VzcGVuZGVkSW52b2ljZXMoKTtcbiAgICBjb25zb2xlLmxvZyhgRm91bmQgJHtzdXNwZW5kZWRJbnZvaWNlcy5sZW5ndGh9IGludm9pY2VzIHRvIHN1c3BlbmQgc3Vic2NyaXB0aW9uc2ApO1xuXG4gICAgbGV0IHN1c3BlbmRlZENvdW50ID0gMDtcblxuICAgIGZvciAoY29uc3QgaW52b2ljZSBvZiBzdXNwZW5kZWRJbnZvaWNlcykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdXBkYXRlU3Vic2NyaXB0aW9uKGludm9pY2Uuc3Vic2NyaXB0aW9uX2lkLCB7XG4gICAgICAgICAgc3RhdHVzOiAncGFzdF9kdWUnXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFRPRE86IFNlbmQgc3VzcGVuc2lvbiBub3RpZmljYXRpb24gZW1haWxcbiAgICAgICAgY29uc29sZS5sb2coYFN1c3BlbmRlZCBzdWJzY3JpcHRpb24gJHtpbnZvaWNlLnN1YnNjcmlwdGlvbl9pZH1gKTtcbiAgICAgICAgc3VzcGVuZGVkQ291bnQrKztcblxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3Igc3VzcGVuZGluZyBzdWJzY3JpcHRpb24gJHtpbnZvaWNlLnN1YnNjcmlwdGlvbl9pZH06YCwgZXJyb3IpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKGBEdW5uaW5nIGNyb24gY29tcGxldGVkLiBSZXRyaWVkOiAke3JldHJpZWRDb3VudH0sIFJldHJ5IGVycm9yczogJHtyZXRyeUVycm9yQ291bnR9LCBTdXNwZW5kZWQ6ICR7c3VzcGVuZGVkQ291bnR9YCk7XG5cbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIHJldHJpZWQ6IHJldHJpZWRDb3VudCxcbiAgICAgIHJldHJ5X2Vycm9yczogcmV0cnlFcnJvckNvdW50LFxuICAgICAgc3VzcGVuZGVkOiBzdXNwZW5kZWRDb3VudCxcbiAgICAgIHRvdGFsX2ZhaWxlZF9pbnZvaWNlczogZmFpbGVkSW52b2ljZXMubGVuZ3RoLFxuICAgICAgdG90YWxfc3VzcGVuZGVkX2ludm9pY2VzOiBzdXNwZW5kZWRJbnZvaWNlcy5sZW5ndGhcbiAgICB9KTtcblxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0R1bm5pbmcgY3JvbiBlcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgeyBlcnJvcjogJ0R1bm5pbmcgY3JvbiBmYWlsZWQnIH0sIFxuICAgICAgeyBzdGF0dXM6IDUwMCB9XG4gICAgKTtcbiAgfVxuICAqL1xufVxuXG5cblxuXG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBV0E7SUFBQUEsYUFBQSxZQUFBQSxDQUFBO01BQUEsT0FBQUMsY0FBQTtJQUFBO0VBQUE7RUFBQSxPQUFBQSxjQUFBO0FBQUE7QUFBQUQsYUFBQTtBQUFBQSxhQUFBLEdBQUFFLENBQUE7Ozs7Ozs7OztBQUtBQyxPQUFBLENBQUFDLEdBQUEsR0FBQUEsR0FBQTtBQWhCQTtBQUNBLE1BQUFDLFFBQUE7QUFBQTtBQUFBLENBQUFMLGFBQUEsR0FBQUUsQ0FBQSxPQUFBSSxPQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUFBO0FBQUFOLGFBQUEsR0FBQUUsQ0FBQTtBQUVhQyxPQUFBLENBQUFJLE9BQU8sR0FBRyxlQUFlO0FBRS9CLGVBQWVILEdBQUdBLENBQUNJLEdBQWdCO0VBQUE7RUFBQVIsYUFBQSxHQUFBUyxDQUFBO0VBQUFULGFBQUEsR0FBQUUsQ0FBQTtFQUN4QztFQUNBLE9BQU9HLFFBQUEsQ0FBQUssWUFBWSxDQUFDQyxJQUFJLENBQ3RCO0lBQ0VDLE9BQU8sRUFBRSxnREFBZ0Q7SUFDekRDLE1BQU0sRUFBRTtHQUNULEVBQ0Q7SUFBRUEsTUFBTSxFQUFFO0VBQUcsQ0FBRSxDQUNoQjtFQUVEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXFJRiIsImlnbm9yZUxpc3QiOltdfQ==