{"version":3,"names":["cov_2x56teek7","actualCoverage","s","exports","GET","server_1","require","dynamic","req","f","NextResponse","json","message","status"],"sources":["C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\app\\api\\cron\\dunning\\route.ts"],"sourcesContent":["// app/api/cron/dunning/route.ts\nimport { NextRequest, NextResponse } from 'next/server';\n// ELIMINADO - Sistema de billing removido\n// import { wompiClient } from '@/lib/wompi/client';\n// import { wompiConfig } from '@/lib/wompi/config';\n// import { \n//   getFailedInvoicesForRetry, \n//   getSuspendedInvoices,\n//   updateInvoice,\n//   updateSubscription,\n//   createTransaction \n// } from '@/db/billing';\n// import { generateRetryReference } from '@/lib/wompi/utils';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function GET(req: NextRequest) {\n  // ELIMINADO - Sistema de billing removido\n  return NextResponse.json(\n    { \n      message: 'Sistema de dunning temporalmente deshabilitado',\n      status: 'disabled'\n    }, \n    { status: 200 }\n  );\n  \n  /*\n  try {\n    // Validate cron secret\n    const authHeader = req.headers.get('Authorization');\n    if (!authHeader || authHeader !== `Bearer ${wompiConfig.cronSecret}`) {\n      return NextResponse.json(\n        { error: 'Unauthorized' }, \n        { status: 401 }\n      );\n    }\n\n    // Check if billing is enabled\n    if (!wompiConfig.isEnabled) {\n      return NextResponse.json(\n        { error: 'Billing is not enabled' }, \n        { status: 403 }\n      );\n    }\n\n    console.log('Starting dunning cron job...');\n\n    // Process failed invoices for retry\n    const failedInvoices = await getFailedInvoicesForRetry();\n    console.log(`Found ${failedInvoices.length} failed invoices for retry`);\n\n    let retriedCount = 0;\n    let retryErrorCount = 0;\n\n    for (const invoice of failedInvoices) {\n      try {\n        console.log(`Retrying invoice ${invoice.id} (attempt ${invoice.attempt_count + 1})`);\n\n        // Create retry transaction in Wompi\n        const reference = generateRetryReference(invoice.id, invoice.attempt_count + 1);\n        const transactionData = {\n          amount_in_cents: invoice.amount_in_cents,\n          currency: 'COP',\n          customer_email: invoice.subscriptions.payment_sources.customer_email,\n          payment_method: {\n            type: invoice.subscriptions.payment_sources.type,\n            installments: 1\n          },\n          payment_source_id: invoice.subscriptions.payment_sources.wompi_id,\n          reference,\n          redirect_url: `${process.env.NEXT_PUBLIC_APP_URL}/billing/success`\n        };\n\n        // Add recurrent flag for cards\n        if (invoice.subscriptions.payment_sources.type === 'CARD') {\n          transactionData.recurrent = true;\n        }\n\n        const wompiTransaction = await wompiClient.createTransaction(transactionData);\n        console.log(`Created retry transaction ${wompiTransaction.id} for invoice ${invoice.id}`);\n\n        // Save transaction to database\n        await createTransaction({\n          invoice_id: invoice.id,\n          workspace_id: invoice.workspace_id,\n          wompi_id: wompiTransaction.id,\n          amount_in_cents: wompiTransaction.amount_in_cents,\n          status: wompiTransaction.status,\n          payment_method_type: invoice.subscriptions.payment_sources.type,\n          reference: wompiTransaction.reference,\n          status_message: wompiTransaction.status_message,\n          raw_payload: wompiTransaction\n        });\n\n        // Update invoice with new transaction ID\n        await updateInvoice(invoice.id, {\n          wompi_transaction_id: wompiTransaction.id,\n          attempt_count: invoice.attempt_count + 1\n        });\n\n        // TODO: Send retry notification email\n        console.log(`Retry transaction created for invoice ${invoice.id}`);\n        retriedCount++;\n\n      } catch (error) {\n        console.error(`Error retrying invoice ${invoice.id}:`, error);\n        retryErrorCount++;\n        \n        // Update attempt count even if retry failed\n        try {\n          await updateInvoice(invoice.id, {\n            attempt_count: invoice.attempt_count + 1\n          });\n        } catch (updateError) {\n          console.error(`Error updating invoice ${invoice.id} attempt count:`, updateError);\n        }\n      }\n    }\n\n    // Suspend subscriptions with too many failed attempts\n    const suspendedInvoices = await getSuspendedInvoices();\n    console.log(`Found ${suspendedInvoices.length} invoices to suspend subscriptions`);\n\n    let suspendedCount = 0;\n\n    for (const invoice of suspendedInvoices) {\n      try {\n        await updateSubscription(invoice.subscription_id, {\n          status: 'past_due'\n        });\n\n        // TODO: Send suspension notification email\n        console.log(`Suspended subscription ${invoice.subscription_id}`);\n        suspendedCount++;\n\n      } catch (error) {\n        console.error(`Error suspending subscription ${invoice.subscription_id}:`, error);\n      }\n    }\n\n    console.log(`Dunning cron completed. Retried: ${retriedCount}, Retry errors: ${retryErrorCount}, Suspended: ${suspendedCount}`);\n\n    return NextResponse.json({\n      success: true,\n      retried: retriedCount,\n      retry_errors: retryErrorCount,\n      suspended: suspendedCount,\n      total_failed_invoices: failedInvoices.length,\n      total_suspended_invoices: suspendedInvoices.length\n    });\n\n  } catch (error) {\n    console.error('Dunning cron error:', error);\n    return NextResponse.json(\n      { error: 'Dunning cron failed' }, \n      { status: 500 }\n    );\n  }\n  */\n}\n\n\n\n\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAWA;IAAAA,aAAA,YAAAA,CAAA;MAAA,OAAAC,cAAA;IAAA;EAAA;EAAA,OAAAA,cAAA;AAAA;AAAAD,aAAA;AAAAA,aAAA,GAAAE,CAAA;;;;;;;;;AAKAC,OAAA,CAAAC,GAAA,GAAAA,GAAA;AAhBA;AACA,MAAAC,QAAA;AAAA;AAAA,CAAAL,aAAA,GAAAE,CAAA,OAAAI,OAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAAN,aAAA,GAAAE,CAAA;AAEaC,OAAA,CAAAI,OAAO,GAAG,eAAe;AAE/B,eAAeH,GAAGA,CAACI,GAAgB;EAAA;EAAAR,aAAA,GAAAS,CAAA;EAAAT,aAAA,GAAAE,CAAA;EACxC;EACA,OAAOG,QAAA,CAAAK,YAAY,CAACC,IAAI,CACtB;IACEC,OAAO,EAAE,gDAAgD;IACzDC,MAAM,EAAE;GACT,EACD;IAAEA,MAAM,EAAE;EAAG,CAAE,CAChB;EAED;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAqIF","ignoreList":[]}