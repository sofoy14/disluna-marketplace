{"file":"C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\__tests__\\lib\\anti-hallucination\\anti-hallucination-system.test.ts","mappings":"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","names":[],"sources":["C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\__tests__\\lib\\anti-hallucination\\anti-hallucination-system.test.ts"],"sourcesContent":["/**\r\n * Tests de Regresión - AntiHallucinationSystem\r\n * \r\n * Tests críticos para asegurar que el sistema anti-alucinación funciona correctamente\r\n * después de la refactorización, cumpliendo con requisitos de precisión legal.\r\n */\r\n\r\nimport { AntiHallucinationSystem } from '../../lib/anti-hallucination/anti-hallucination-system'\r\nimport OpenAI from 'openai'\r\n\r\n// Mock del cliente OpenAI\r\nconst mockOpenAIClient = {\r\n  chat: {\r\n    completions: {\r\n      create: jest.fn()\r\n    }\r\n  }\r\n}\r\n\r\njest.mock('openai', () => {\r\n  return jest.fn().mockImplementation(() => mockOpenAIClient)\r\n})\r\n\r\ndescribe('AntiHallucinationSystem - Tests de Regresión', () => {\r\n  let antiHallucinationSystem: AntiHallucinationSystem\r\n  const mockClient = new OpenAI({ apiKey: 'test-key' })\r\n\r\n  beforeEach(() => {\r\n    antiHallucinationSystem = new AntiHallucinationSystem(mockClient, 'gpt-4')\r\n    jest.clearAllMocks()\r\n  })\r\n\r\n  describe('Verificación de Precisión', () => {\r\n    test('debe detectar información respaldada por fuentes', async () => {\r\n      const response = 'Según el Artículo 110 del Código de Comercio, para constituir una SAS se requiere...'\r\n      const sources = [\r\n        {\r\n          title: 'Código de Comercio - Artículo 110',\r\n          url: 'https://www.suin-juriscol.gov.co/viewDocument.asp?ruta=Leyes/1689347',\r\n          content: 'Para constituir una sociedad por acciones simplificada se requiere...',\r\n          type: 'official' as const,\r\n          quality: 9\r\n        }\r\n      ]\r\n\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isAccurate: true,\r\n              confidence: 0.95,\r\n              supportedClaims: [\r\n                'Artículo 110 del Código de Comercio menciona constitución de SAS'\r\n              ],\r\n              unsupportedClaims: [],\r\n              sourceValidation: {\r\n                article110: {\r\n                  found: true,\r\n                  relevance: 0.9,\r\n                  accuracy: 0.95\r\n                }\r\n              },\r\n              recommendations: ['La información está bien respaldada por fuentes oficiales']\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      const result = await antiHallucinationSystem.verifyResponse(response, sources)\r\n\r\n      expect(result.passed).toBe(true)\r\n      expect(result.confidence).toBeGreaterThan(0.9)\r\n      expect(result.supportedClaims).toHaveLength(1)\r\n      expect(result.unsupportedClaims).toHaveLength(0)\r\n    })\r\n\r\n    test('debe detectar información no respaldada por fuentes', async () => {\r\n      const response = 'Según el Artículo 999 del Código de Comercio, las SAS pueden tener hasta 1000 socios...'\r\n      const sources = [\r\n        {\r\n          title: 'Código de Comercio - Artículo 110',\r\n          url: 'https://www.suin-juriscol.gov.co',\r\n          content: 'Para constituir una sociedad por acciones simplificada se requiere...',\r\n          type: 'official' as const,\r\n          quality: 9\r\n        }\r\n      ]\r\n\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isAccurate: false,\r\n              confidence: 0.2,\r\n              supportedClaims: [],\r\n              unsupportedClaims: [\r\n                'Artículo 999 no existe en el Código de Comercio',\r\n                'Límite de 1000 socios no está respaldado por las fuentes'\r\n              ],\r\n              sourceValidation: {\r\n                article999: {\r\n                  found: false,\r\n                  relevance: 0,\r\n                  accuracy: 0\r\n                }\r\n              },\r\n              recommendations: ['Verificar existencia del artículo mencionado', 'Buscar fuentes oficiales sobre límites de socios']\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      const result = await antiHallucinationSystem.verifyResponse(response, sources)\r\n\r\n      expect(result.passed).toBe(false)\r\n      expect(result.confidence).toBeLessThan(0.5)\r\n      expect(result.unsupportedClaims).toHaveLength(2)\r\n      expect(result.recommendations).toContain('Verificar existencia del artículo mencionado')\r\n    })\r\n\r\n    test('debe detectar información parcialmente respaldada', async () => {\r\n      const response = 'Las SAS requieren un capital mínimo de $1,000,000 y pueden tener hasta 50 socios según el Código de Comercio.'\r\n      const sources = [\r\n        {\r\n          title: 'Código de Comercio - Artículo 110',\r\n          url: 'https://www.suin-juriscol.gov.co',\r\n          content: 'Para constituir una sociedad por acciones simplificada se requiere un capital mínimo de $1,000,000...',\r\n          type: 'official' as const,\r\n          quality: 9\r\n        }\r\n      ]\r\n\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isAccurate: false,\r\n              confidence: 0.6,\r\n              supportedClaims: [\r\n                'Capital mínimo de $1,000,000 está respaldado por Artículo 110'\r\n              ],\r\n              unsupportedClaims: [\r\n                'Límite de 50 socios no está especificado en las fuentes'\r\n              ],\r\n              sourceValidation: {\r\n                capitalMinimo: {\r\n                  found: true,\r\n                  relevance: 0.9,\r\n                  accuracy: 0.95\r\n                },\r\n                limiteSocios: {\r\n                  found: false,\r\n                  relevance: 0,\r\n                  accuracy: 0\r\n                }\r\n              },\r\n              recommendations: ['Buscar información específica sobre límites de socios en SAS']\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      const result = await antiHallucinationSystem.verifyResponse(response, sources)\r\n\r\n      expect(result.passed).toBe(false)\r\n      expect(result.confidence).toBe(0.6)\r\n      expect(result.supportedClaims).toHaveLength(1)\r\n      expect(result.unsupportedClaims).toHaveLength(1)\r\n    })\r\n  })\r\n\r\n  describe('Validación de Referencias Legales', () => {\r\n    test('debe validar artículos de ley correctamente', async () => {\r\n      const response = 'Según el Artículo 110 del Código de Comercio...'\r\n      const sources = [\r\n        {\r\n          title: 'Código de Comercio - Artículo 110',\r\n          url: 'https://www.suin-juriscol.gov.co/viewDocument.asp?ruta=Leyes/1689347',\r\n          content: 'Artículo 110. Sociedad por Acciones Simplificada...',\r\n          type: 'official' as const,\r\n          quality: 9\r\n        }\r\n      ]\r\n\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isAccurate: true,\r\n              confidence: 0.95,\r\n              supportedClaims: ['Artículo 110 existe y es relevante'],\r\n              unsupportedClaims: [],\r\n              sourceValidation: {\r\n                article110: {\r\n                  found: true,\r\n                  relevance: 0.95,\r\n                  accuracy: 0.95\r\n                }\r\n              },\r\n              recommendations: []\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      const result = await antiHallucinationSystem.verifyResponse(response, sources)\r\n\r\n      expect(result.sourceValidation?.article110?.found).toBe(true)\r\n      expect(result.sourceValidation?.article110?.relevance).toBeGreaterThan(0.9)\r\n    })\r\n\r\n    test('debe detectar referencias a artículos inexistentes', async () => {\r\n      const response = 'Según el Artículo 9999 del Código de Comercio...'\r\n      const sources = [\r\n        {\r\n          title: 'Código de Comercio',\r\n          url: 'https://www.suin-juriscol.gov.co',\r\n          content: 'Contenido del Código de Comercio sin Artículo 9999...',\r\n          type: 'official' as const,\r\n          quality: 9\r\n        }\r\n      ]\r\n\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isAccurate: false,\r\n              confidence: 0.1,\r\n              supportedClaims: [],\r\n              unsupportedClaims: ['Artículo 9999 no existe en el Código de Comercio'],\r\n              sourceValidation: {\r\n                article9999: {\r\n                  found: false,\r\n                  relevance: 0,\r\n                  accuracy: 0\r\n                }\r\n              },\r\n              recommendations: ['Verificar número de artículo correcto']\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      const result = await antiHallucinationSystem.verifyResponse(response, sources)\r\n\r\n      expect(result.sourceValidation?.article9999?.found).toBe(false)\r\n      expect(result.unsupportedClaims).toContain('Artículo 9999 no existe en el Código de Comercio')\r\n    })\r\n\r\n    test('debe validar sentencias de la Corte Constitucional', async () => {\r\n      const response = 'La Corte Constitucional en la Sentencia T-123 de 2024 estableció que...'\r\n      const sources = [\r\n        {\r\n          title: 'Sentencia T-123 de 2024 - Corte Constitucional',\r\n          url: 'https://www.corteconstitucional.gov.co/relatoria/2024/t-123-24.htm',\r\n          content: 'En la Sentencia T-123 de 2024, la Corte Constitucional estableció...',\r\n          type: 'official' as const,\r\n          quality: 10\r\n        }\r\n      ]\r\n\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isAccurate: true,\r\n              confidence: 0.98,\r\n              supportedClaims: ['Sentencia T-123 de 2024 existe y es relevante'],\r\n              unsupportedClaims: [],\r\n              sourceValidation: {\r\n                sentenciaT123: {\r\n                  found: true,\r\n                  relevance: 0.98,\r\n                  accuracy: 0.98\r\n                }\r\n              },\r\n              recommendations: []\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      const result = await antiHallucinationSystem.verifyResponse(response, sources)\r\n\r\n      expect(result.sourceValidation?.sentenciaT123?.found).toBe(true)\r\n      expect(result.confidence).toBeGreaterThan(0.95)\r\n    })\r\n  })\r\n\r\n  describe('Detección de Información Inventada', () => {\r\n    test('debe detectar información completamente inventada', async () => {\r\n      const response = 'Según la Ley 9999 de 2024, todas las empresas deben tener un robot legal obligatorio...'\r\n      const sources = [\r\n        {\r\n          title: 'Código de Comercio',\r\n          url: 'https://www.suin-juriscol.gov.co',\r\n          content: 'Contenido del Código de Comercio sin mencionar robots legales...',\r\n          type: 'official' as const,\r\n          quality: 9\r\n        }\r\n      ]\r\n\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isAccurate: false,\r\n              confidence: 0.05,\r\n              supportedClaims: [],\r\n              unsupportedClaims: [\r\n                'Ley 9999 de 2024 no existe',\r\n                'No hay normativa sobre robots legales obligatorios',\r\n                'La información parece completamente inventada'\r\n              ],\r\n              sourceValidation: {\r\n                ley9999: {\r\n                  found: false,\r\n                  relevance: 0,\r\n                  accuracy: 0\r\n                },\r\n                robotsLegales: {\r\n                  found: false,\r\n                  relevance: 0,\r\n                  accuracy: 0\r\n                }\r\n              },\r\n              recommendations: [\r\n                'Esta información no está respaldada por fuentes oficiales',\r\n                'Se recomienda buscar normativa real sobre obligaciones empresariales'\r\n              ]\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      const result = await antiHallucinationSystem.verifyResponse(response, sources)\r\n\r\n      expect(result.passed).toBe(false)\r\n      expect(result.confidence).toBeLessThan(0.1)\r\n      expect(result.unsupportedClaims).toHaveLength(3)\r\n      expect(result.recommendations).toContain('Esta información no está respaldada por fuentes oficiales')\r\n    })\r\n\r\n    test('debe detectar mezcla de información real e inventada', async () => {\r\n      const response = 'Las SAS requieren un capital mínimo de $1,000,000 y deben tener un unicornio como mascota corporativa.'\r\n      const sources = [\r\n        {\r\n          title: 'Código de Comercio - Artículo 110',\r\n          url: 'https://www.suin-juriscol.gov.co',\r\n          content: 'Para constituir una sociedad por acciones simplificada se requiere un capital mínimo de $1,000,000...',\r\n          type: 'official' as const,\r\n          quality: 9\r\n        }\r\n      ]\r\n\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isAccurate: false,\r\n              confidence: 0.4,\r\n              supportedClaims: [\r\n                'Capital mínimo de $1,000,000 está respaldado por Artículo 110'\r\n              ],\r\n              unsupportedClaims: [\r\n                'No hay normativa sobre mascotas corporativas obligatorias',\r\n                'La mención de unicornio parece inventada'\r\n              ],\r\n              sourceValidation: {\r\n                capitalMinimo: {\r\n                  found: true,\r\n                  relevance: 0.9,\r\n                  accuracy: 0.95\r\n                },\r\n                mascotaCorporativa: {\r\n                  found: false,\r\n                  relevance: 0,\r\n                  accuracy: 0\r\n                }\r\n              },\r\n              recommendations: [\r\n                'Separar información verificada de información no respaldada',\r\n                'Eliminar referencias a mascotas corporativas'\r\n              ]\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      const result = await antiHallucinationSystem.verifyResponse(response, sources)\r\n\r\n      expect(result.passed).toBe(false)\r\n      expect(result.supportedClaims).toHaveLength(1)\r\n      expect(result.unsupportedClaims).toHaveLength(2)\r\n    })\r\n  })\r\n\r\n  describe('Generación de Respuestas Conservadoras', () => {\r\n    test('debe generar respuesta conservadora cuando hay dudas', async () => {\r\n      const response = 'Según algunas fuentes, las SAS pueden tener hasta 100 socios, pero esto no está completamente claro...'\r\n      const sources = [\r\n        {\r\n          title: 'Guía de Constitución de Empresas',\r\n          url: 'https://www.example.com',\r\n          content: 'Información general sobre SAS...',\r\n          type: 'general' as const,\r\n          quality: 5\r\n        }\r\n      ]\r\n\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isAccurate: false,\r\n              confidence: 0.3,\r\n              supportedClaims: [],\r\n              unsupportedClaims: [\r\n                'Límite de 100 socios no está claramente establecido',\r\n                'Fuente no oficial y de baja calidad'\r\n              ],\r\n              sourceValidation: {\r\n                limiteSocios: {\r\n                  found: false,\r\n                  relevance: 0.3,\r\n                  accuracy: 0.3\r\n                }\r\n              },\r\n              recommendations: [\r\n                'Buscar fuentes oficiales sobre límites de socios en SAS',\r\n                'Consultar directamente con autoridades competentes',\r\n                'La información actual es insuficiente para dar una respuesta definitiva'\r\n              ]\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      const result = await antiHallucinationSystem.verifyResponse(response, sources)\r\n\r\n      expect(result.passed).toBe(false)\r\n      expect(result.confidence).toBeLessThan(0.5)\r\n      expect(result.recommendations).toContain('La información actual es insuficiente para dar una respuesta definitiva')\r\n    })\r\n\r\n    test('debe recomendar consulta profesional cuando sea necesario', async () => {\r\n      const response = 'Para casos complejos de constitución de SAS con múltiples socios extranjeros...'\r\n      const sources = [\r\n        {\r\n          title: 'Información General sobre SAS',\r\n          url: 'https://www.example.com',\r\n          content: 'Información básica sobre SAS...',\r\n          type: 'general' as const,\r\n          quality: 4\r\n        }\r\n      ]\r\n\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isAccurate: false,\r\n              confidence: 0.2,\r\n              supportedClaims: [],\r\n              unsupportedClaims: [\r\n                'Casos complejos requieren análisis específico',\r\n                'Información sobre socios extranjeros no está disponible'\r\n              ],\r\n              sourceValidation: {\r\n                casosComplejos: {\r\n                  found: false,\r\n                  relevance: 0.2,\r\n                  accuracy: 0.2\r\n                }\r\n              },\r\n              recommendations: [\r\n                'Para casos complejos se recomienda consulta legal profesional',\r\n                'Buscar asesoría especializada en derecho societario',\r\n                'La información disponible es insuficiente para este caso específico'\r\n              ]\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      const result = await antiHallucinationSystem.verifyResponse(response, sources)\r\n\r\n      expect(result.recommendations).toContain('Para casos complejos se recomienda consulta legal profesional')\r\n      expect(result.recommendations).toContain('Buscar asesoría especializada en derecho societario')\r\n    })\r\n  })\r\n\r\n  describe('Manejo de Errores', () => {\r\n    test('debe manejar errores de API gracefully', async () => {\r\n      mockOpenAIClient.chat.completions.create.mockRejectedValueOnce(\r\n        new Error('API rate limit exceeded')\r\n      )\r\n\r\n      const result = await antiHallucinationSystem.verifyResponse(\r\n        'Test response',\r\n        []\r\n      )\r\n\r\n      expect(result.passed).toBe(false)\r\n      expect(result.confidence).toBe(0)\r\n      expect(result.error).toContain('API rate limit exceeded')\r\n    })\r\n\r\n    test('debe manejar respuestas malformadas del modelo', async () => {\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: 'Respuesta no válida en JSON'\r\n          }\r\n        }]\r\n      })\r\n\r\n      const result = await antiHallucinationSystem.verifyResponse(\r\n        'Test response',\r\n        []\r\n      )\r\n\r\n      expect(result.passed).toBe(false)\r\n      expect(result.error).toContain('Error parsing verification response')\r\n    })\r\n  })\r\n\r\n  describe('Cumplimiento Legal', () => {\r\n    test('debe registrar verificaciones para auditoría', async () => {\r\n      const response = 'Información legal verificada'\r\n      const sources = [\r\n        {\r\n          title: 'Fuente Oficial',\r\n          url: 'https://www.gov.co',\r\n          content: 'Contenido oficial',\r\n          type: 'official' as const,\r\n          quality: 9\r\n        }\r\n      ]\r\n\r\n      mockOpenAIClient.chat.completions.create.mockResolvedValueOnce({\r\n        choices: [{\r\n          message: {\r\n            content: JSON.stringify({\r\n              isAccurate: true,\r\n              confidence: 0.95,\r\n              supportedClaims: ['Información respaldada'],\r\n              unsupportedClaims: [],\r\n              sourceValidation: {},\r\n              recommendations: []\r\n            })\r\n          }\r\n        }]\r\n      })\r\n\r\n      const result = await antiHallucinationSystem.verifyResponse(response, sources)\r\n\r\n      // Verificar que se registró la verificación\r\n      expect(result.timestamp).toBeInstanceOf(Date)\r\n      expect(result.responseHash).toBeDefined()\r\n      expect(result.sourcesHash).toBeDefined()\r\n    })\r\n\r\n    test('debe mantener trazabilidad de verificaciones', async () => {\r\n      const response1 = 'Primera respuesta'\r\n      const response2 = 'Segunda respuesta'\r\n      const sources = []\r\n\r\n      mockOpenAIClient.chat.completions.create\r\n        .mockResolvedValueOnce({\r\n          choices: [{\r\n            message: {\r\n              content: JSON.stringify({\r\n                isAccurate: true,\r\n                confidence: 0.9,\r\n                supportedClaims: [],\r\n                unsupportedClaims: [],\r\n                sourceValidation: {},\r\n                recommendations: []\r\n              })\r\n            }\r\n          }]\r\n        })\r\n        .mockResolvedValueOnce({\r\n          choices: [{\r\n            message: {\r\n              content: JSON.stringify({\r\n                isAccurate: false,\r\n                confidence: 0.3,\r\n                supportedClaims: [],\r\n                unsupportedClaims: [],\r\n                sourceValidation: {},\r\n                recommendations: []\r\n              })\r\n            }\r\n          }]\r\n        })\r\n\r\n      const result1 = await antiHallucinationSystem.verifyResponse(response1, sources)\r\n      const result2 = await antiHallucinationSystem.verifyResponse(response2, sources)\r\n\r\n      expect(result1.responseHash).not.toBe(result2.responseHash)\r\n      expect(result1.timestamp).not.toEqual(result2.timestamp)\r\n    })\r\n  })\r\n})\r\n"],"version":3}