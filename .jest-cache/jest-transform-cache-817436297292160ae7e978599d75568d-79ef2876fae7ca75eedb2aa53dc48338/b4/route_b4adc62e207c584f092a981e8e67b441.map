{"version":3,"names":["cov_7kgoa9biq","actualCoverage","exports","POST","server_chat_helpers_1","s","require","ai_1","openai_1","__importDefault","conditional_web_search_1","runtime","maxDuration","request","f","json","chatSettings","messages","useSequentialThinking","profile","getServerProfile","error","console","log","email","openrouter_api_key","b","process","env","OPENROUTER_API_KEY","openrouterApiKey","Error","openai","default","apiKey","baseURL","enhancedMessages","lastUserMessage","filter","m","role","pop","userQuery","content","repeat","substring","model","searchResult","executeConditionalWebSearch","logDetection","shouldSearch","detectionResult","confidence","toFixed","reason","searchResults","results","length","systemMessage","generateSystemMessage","unshift","webSearchContext","split","response","chat","completions","create","temperature","max_tokens","undefined","stream","OpenAIStream","StreamingTextResponse","errorMessage","message","errorCode","status","toLowerCase","includes","Response","JSON","stringify"],"sources":["C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\app\\api\\chat\\openrouter\\route.ts"],"sourcesContent":["import { checkApiKey, getServerProfile } from \"@/lib/server/server-chat-helpers\"\r\nimport { ChatSettings } from \"@/types\"\r\nimport { OpenAIStream, StreamingTextResponse } from \"ai\"\r\nimport { ServerRuntime } from \"next\"\r\nimport OpenAI from \"openai\"\r\nimport { ChatCompletionCreateParamsBase } from \"openai/resources/chat/completions.mjs\"\r\nimport { executeConditionalWebSearch, generateSystemMessage } from \"@/lib/tools/conditional-web-search\"\r\n\r\nexport const runtime: ServerRuntime = \"nodejs\"\r\nexport const maxDuration = 60 // 60 segundos para Sequential Thinking\r\n\r\nexport async function POST(request: Request) {\r\n  const json = await request.json()\r\n  const { chatSettings, messages, useSequentialThinking } = json as {\r\n    chatSettings: ChatSettings\r\n    messages: any[]\r\n    useSequentialThinking?: boolean\r\n  }\r\n\r\n  try {\r\n    let profile\r\n    try {\r\n      profile = await getServerProfile()\r\n    } catch (error) {\r\n      console.log('‚ö†Ô∏è Usuario no autenticado, usando configuraci√≥n por defecto')\r\n      profile = {\r\n        email: 'usuario-anonimo',\r\n        openrouter_api_key: process.env.OPENROUTER_API_KEY || ''\r\n      }\r\n    }\r\n\r\n    // Usar API key de OpenRouter desde variables de entorno o perfil\r\n    const openrouterApiKey = process.env.OPENROUTER_API_KEY || profile.openrouter_api_key || \"\"\r\n\r\n    if (!openrouterApiKey) {\r\n      throw new Error(\"OpenRouter API Key no configurada. Por favor configura OPENROUTER_API_KEY en las variables de entorno o en tu perfil.\")\r\n    }\r\n\r\n    const openai = new OpenAI({\r\n      apiKey: openrouterApiKey,\r\n      baseURL: \"https://openrouter.ai/api/v1\"\r\n    })\r\n\r\n    // üß† B√öSQUEDA WEB INTELIGENTE - SOLO CUANDO ES NECESARIO\r\n    const enhancedMessages = [...messages]\r\n    const lastUserMessage = enhancedMessages.filter(m => m.role === 'user').pop()\r\n    const userQuery = lastUserMessage?.content || ''\r\n    \r\n    console.log(`\\n${\"üß†\".repeat(60)}`)\r\n    console.log(`üîç OPENROUTER - B√öSQUEDA WEB INTELIGENTE`)\r\n    console.log(`   Query: \"${userQuery.substring(0, 50)}...\"`)\r\n    console.log(`   Usuario: ${profile?.email || 'usuario-anonimo'}`)\r\n    console.log(`   Modelo: ${chatSettings.model}`)\r\n    console.log(`${\"üß†\".repeat(60)}\\n`)\r\n    \r\n    // Ejecutar b√∫squeda condicional inteligente\r\n    const searchResult = await executeConditionalWebSearch(userQuery, {\r\n      logDetection: true\r\n    })\r\n    \r\n    console.log(`\\n${\"üß†\".repeat(60)}`)\r\n    console.log(`‚úÖ AN√ÅLISIS INTELIGENTE COMPLETADO`)\r\n    console.log(`   üîç B√∫squeda requerida: ${searchResult.shouldSearch ? 'S√ç' : 'NO'}`)\r\n    console.log(`   üéØ Confianza: ${(searchResult.detectionResult.confidence * 100).toFixed(1)}%`)\r\n    console.log(`   üìã Raz√≥n: ${searchResult.detectionResult.reason}`)\r\n    if (searchResult.searchResults) {\r\n      console.log(`   üìä Resultados: ${searchResult.searchResults.results?.length || 0}`)\r\n    }\r\n    console.log(`${\"üß†\".repeat(60)}\\n`)\r\n    \r\n    // Generar mensaje de sistema apropiado\r\n    const systemMessage = {\r\n      role: \"system\",\r\n      content: generateSystemMessage(userQuery, searchResult)\r\n    }\r\n\r\n    // Insertar el mensaje de sistema al inicio si no hay uno\r\n    if (enhancedMessages.length === 0 || enhancedMessages[0].role !== \"system\") {\r\n      enhancedMessages.unshift(systemMessage)\r\n    } else {\r\n      // Si ya hay un mensaje de sistema, agregar las instrucciones\r\n      enhancedMessages[0].content = `${enhancedMessages[0].content}\\n\\n${systemMessage.content}`\r\n    }\r\n\r\n    console.log(`‚öñÔ∏è Tongyi Legal: Configurado con b√∫squeda autom√°tica ${webSearchContext ? `(${webSearchContext.split('\\n').length} l√≠neas de contexto)` : '(sin resultados)'}`)\r\n\r\n    const response = await openai.chat.completions.create({\r\n      model: chatSettings.model as ChatCompletionCreateParamsBase[\"model\"],\r\n      messages: enhancedMessages as ChatCompletionCreateParamsBase[\"messages\"],\r\n      temperature: chatSettings.temperature,\r\n      max_tokens: undefined,\r\n      stream: true\r\n    })\r\n\r\n    const stream = OpenAIStream(response)\r\n\r\n    return new StreamingTextResponse(stream)\r\n  } catch (error: any) {\r\n    let errorMessage = error.message || \"An unexpected error occurred\"\r\n    const errorCode = error.status || 500\r\n\r\n    if (errorMessage.toLowerCase().includes(\"api key not found\")) {\r\n      errorMessage =\r\n        \"OpenRouter API Key not found. Please set it in your profile settings.\"\r\n    }\r\n\r\n    return new Response(JSON.stringify({ message: errorMessage }), {\r\n      status: errorCode\r\n    })\r\n  }\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}