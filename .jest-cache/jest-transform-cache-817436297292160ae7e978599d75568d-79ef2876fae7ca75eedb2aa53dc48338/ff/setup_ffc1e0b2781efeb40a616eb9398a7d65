929fb26ff0b523b3a35e69dbbeaf5686
"use strict";
/**
 * Setup Global para Tests de Regresión
 *
 * Configuración global para todos los tests del sistema legal.
 */
// Configuración de mocks globales
jest.mock('@supabase/supabase-js', () => ({
    createClient: jest.fn(() => ({
        from: jest.fn(() => ({
            select: jest.fn(() => ({
                eq: jest.fn(() => ({
                    order: jest.fn(() => ({
                        limit: jest.fn(() => Promise.resolve({ data: [], error: null }))
                    }))
                }))
            })),
            insert: jest.fn(() => Promise.resolve({ data: [], error: null })),
            update: jest.fn(() => ({
                eq: jest.fn(() => Promise.resolve({ data: [], error: null }))
            })),
            upsert: jest.fn(() => Promise.resolve({ data: [], error: null })),
            delete: jest.fn(() => ({
                eq: jest.fn(() => Promise.resolve({ data: [], error: null }))
            }))
        }))
    }))
}));
jest.mock('openai', () => {
    return jest.fn().mockImplementation(() => ({
        chat: {
            completions: {
                create: jest.fn()
            }
        }
    }));
});
// Configuración de variables de entorno para testing
process.env.NODE_ENV = 'test';
process.env.SUPABASE_URL = 'http://localhost:54321';
process.env.SUPABASE_ANON_KEY = 'test-anon-key';
process.env.OPENAI_API_KEY = 'test-openai-key';
process.env.SERPER_API_KEY = 'test-serper-key';
process.env.FIRECRAWL_API_KEY = 'test-firecrawl-key';
// Configuración de console para tests
const originalConsole = console;
beforeAll(() => {
    // Suprimir logs durante tests para mantener output limpio
    global.console = {
        ...originalConsole,
        log: jest.fn(),
        debug: jest.fn(),
        info: jest.fn(),
        warn: jest.fn(),
        error: jest.fn()
    };
});
afterAll(() => {
    // Restaurar console original
    global.console = originalConsole;
});
// Mock de fetch para requests HTTP
global.fetch = jest.fn();
// Configuración de timers para tests
jest.useFakeTimers();
// Configuración de crypto para tests
Object.defineProperty(global, 'crypto', {
    value: {
        randomUUID: jest.fn(() => 'test-uuid-123')
    }
});
// Configuración de Date para tests consistentes
const mockDate = new Date('2024-01-15T10:00:00Z');
jest.spyOn(global, 'Date').mockImplementation(() => mockDate);
// Configuración de Math.random para tests determinísticos
jest.spyOn(Math, 'random').mockReturnValue(0.5);
// Configuración de setTimeout y setInterval para tests
jest.spyOn(global, 'setTimeout').mockImplementation((fn) => {
    fn();
    return 1;
});
jest.spyOn(global, 'setInterval').mockImplementation((fn) => {
    fn();
    return 1;
});
// Configuración de clearTimeout y clearInterval
jest.spyOn(global, 'clearTimeout').mockImplementation(() => { });
jest.spyOn(global, 'clearInterval').mockImplementation(() => { });
// Configuración de process.env para tests
process.env.TEST_MODE = 'true';
process.env.DISABLE_LOGGING = 'true';
// Configuración de errores no manejados
process.on('unhandledRejection', (reason, promise) => {
    console.error('Unhandled Rejection at:', promise, 'reason:', reason);
});
process.on('uncaughtException', (error) => {
    console.error('Uncaught Exception:', error);
});
// Configuración de cleanup después de cada test
afterEach(() => {
    // Limpiar todos los mocks
    jest.clearAllMocks();
    // Limpiar timers
    jest.clearAllTimers();
    // Resetear fetch mock
    if (global.fetch) {
        global.fetch.mockClear();
    }
});
// Configuración de cleanup global
afterAll(() => {
    // Restaurar timers reales
    jest.useRealTimers();
    // Restaurar Date real
    jest.restoreAllMocks();
    // Limpiar variables de entorno de test
    delete process.env.TEST_MODE;
    delete process.env.DISABLE_LOGGING;
});
// Configuración de helpers globales para tests
global.testHelpers = {
    // Helper para crear mock de respuesta de OpenAI
    createMockOpenAIResponse: (content) => ({
        choices: [{
                message: {
                    content: typeof content === 'string' ? content : JSON.stringify(content)
                }
            }]
    }),
    // Helper para crear mock de fuente legal
    createMockLegalSource: (overrides = {}) => ({
        title: 'Fuente Legal Test',
        url: 'https://www.test.gov.co',
        content: 'Contenido de prueba',
        snippet: 'Snippet de prueba',
        type: 'official',
        quality: 8,
        authority: 'maxima',
        currency: 'actualizada',
        recommendedUse: 'cita_principal',
        verificationNotes: 'Verificada en tests',
        ...overrides
    }),
    // Helper para crear mock de contexto de chat
    createMockChatContext: (overrides = {}) => ({
        chatId: 'test-chat-123',
        userId: 'test-user-456',
        conversationHistory: [],
        currentContext: '',
        searchHistory: [],
        userPreferences: {
            preferredSearchStrategy: 'AGENTE_UNIFICADO_TONGYI',
            maxSearchRounds: 5,
            enableModelDecision: true,
            preferredResearchMode: undefined,
            qualityThreshold: 0.85
        },
        cachedSources: [],
        qualityMetrics: {
            totalQueries: 0,
            averageQuality: 0,
            modePerformance: {
                react: { count: 0, avgQuality: 0, avgTime: 0 },
                iter_research: { count: 0, avgQuality: 0, avgTime: 0 },
                hybrid: { count: 0, avgQuality: 0, avgTime: 0 }
            },
            verificationStats: {
                totalVerifications: 0,
                passedVerifications: 0,
                averageConfidence: 0,
                successRate: 0
            }
        },
        ...overrides
    }),
    // Helper para crear mock de consulta legal
    createMockLegalQuery: (overrides = {}) => ({
        query: '¿Cuáles son los requisitos para constituir una SAS?',
        userId: 'test-user-123',
        chatId: 'test-chat-456',
        context: global.testHelpers.createMockChatContext(),
        ...overrides
    }),
    // Helper para esperar con timeout
    waitFor: (ms) => new Promise(resolve => setTimeout(resolve, ms)),
    // Helper para crear mock de error
    createMockError: (message, code) => {
        const error = new Error(message);
        if (code) {
            error.code = code;
        }
        return error;
    }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxwZWRyb1xcRG9jdW1lbnRzXFxHaXRIdWJcXEFzaXN0ZW50ZS1MZWdhbC1JbnRlbGlnZW50ZVxcX190ZXN0c19fXFxzZXR1cC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7R0FJRztBQThCSCxrQ0FBa0M7QUFDbEMsSUFBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3hDLFlBQVksRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFDM0IsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUNuQixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO2dCQUNyQixFQUFFLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO29CQUNqQixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO3dCQUNwQixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztxQkFDakUsQ0FBQyxDQUFDO2lCQUNKLENBQUMsQ0FBQzthQUNKLENBQUMsQ0FBQztZQUNILE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ2pFLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBQ3JCLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENB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LEVBQUUsVUFBVSxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFO2FBQ2hEO1lBQ0QsaUJBQWlCLEVBQUU7Z0JBQ2pCLGtCQUFrQixFQUFFLENBQUM7Z0JBQ3JCLG1CQUFtQixFQUFFLENBQUM7Z0JBQ3RCLGlCQUFpQixFQUFFLENBQUM7Z0JBQ3BCLFdBQVcsRUFBRSxDQUFDO2FBQ2Y7U0FDRjtRQUNELEdBQUcsU0FBUztLQUNiLENBQUM7SUFFRiwyQ0FBMkM7SUFDM0Msb0JBQW9CLEVBQUUsQ0FBQyxTQUFTLEdBQUcsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3pDLEtBQUssRUFBRSxxREFBcUQ7UUFDNUQsTUFBTSxFQUFFLGVBQWU7UUFDdkIsTUFBTSxFQUFFLGVBQWU7UUFDdkIsT0FBTyxFQUFFLE1BQU0sQ0FBQyxXQUFXLENBQUMscUJBQXFCLEVBQUU7UUFDbkQsR0FBRyxTQUFTO0tBQ2IsQ0FBQztJQUVGLGtDQUFrQztJQUNsQyxPQUFPLEVBQUUsQ0FBQyxFQUFVLEVBQUUsRUFBRSxDQUFDLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQztJQUV4RSxrQ0FBa0M7SUFDbEMsZUFBZSxFQUFFLENBQUMsT0FBZSxFQUFFLElBQWEsRUFBRSxFQUFFO1FBQ2xELE1BQU0sS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ2hDLElBQUksSUFBSSxFQUFFLENBQUM7WUFDUixLQUFhLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQTtRQUM1QixDQUFDO1FBQ0QsT0FBTyxLQUFLLENBQUE7SUFDZCxDQUFDO0NBQ0YsQ0FBQSIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHBlZHJvXFxEb2N1bWVudHNcXEdpdEh1YlxcQXNpc3RlbnRlLUxlZ2FsLUludGVsaWdlbnRlXFxfX3Rlc3RzX19cXHNldHVwLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBTZXR1cCBHbG9iYWwgcGFyYSBUZXN0cyBkZSBSZWdyZXNpw7NuXHJcbiAqIFxyXG4gKiBDb25maWd1cmFjacOzbiBnbG9iYWwgcGFyYSB0b2RvcyBsb3MgdGVzdHMgZGVsIHNpc3RlbWEgbGVnYWwuXHJcbiAqL1xyXG5cclxuLy8gQ29uZmlndXJhY2nDs24gZGUgdmFyaWFibGVzIGRlIGVudG9ybm8gcGFyYSB0ZXN0aW5nXHJcbnByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ3Rlc3QnXHJcbnByb2Nlc3MuZW52LlNVUEFCQVNFX1VSTCA9ICdodHRwOi8vbG9jYWxob3N0OjU0MzIxJ1xyXG5wcm9jZXNzLmVudi5TVVBBQkFTRV9BTk9OX0tFWSA9ICd0ZXN0LWFub24ta2V5J1xyXG5wcm9jZXNzLmVudi5PUEVOQUlfQVBJX0tFWSA9ICd0ZXN0LW9wZW5haS1rZXknXHJcbnByb2Nlc3MuZW52LlNFUlBFUl9BUElfS0VZID0gJ3Rlc3Qtc2VycGVyLWtleSdcclxucHJvY2Vzcy5lbnYuRklSRUNSQVdMX0FQSV9LRVkgPSAndGVzdC1maXJlY3Jhd2wta2V5J1xyXG5cclxuLy8gQ29uZmlndXJhY2nDs24gZGUgY29uc29sZSBwYXJhIHRlc3RzXHJcbmNvbnN0IG9yaWdpbmFsQ29uc29sZSA9IGNvbnNvbGVcclxuXHJcbmJlZm9yZUFsbCgoKSA9PiB7XHJcbiAgLy8gU3VwcmltaXIgbG9ncyBkdXJhbnRlIHRlc3RzIHBhcmEgbWFudGVuZXIgb3V0cHV0IGxpbXBpb1xyXG4gIGdsb2JhbC5jb25zb2xlID0ge1xyXG4gICAgLi4ub3JpZ2luYWxDb25zb2xlLFxyXG4gICAgbG9nOiBqZXN0LmZuKCksXHJcbiAgICBkZWJ1ZzogamVzdC5mbigpLFxyXG4gICAgaW5mbzogamVzdC5mbigpLFxyXG4gICAgd2FybjogamVzdC5mbigpLFxyXG4gICAgZXJyb3I6IGplc3QuZm4oKVxyXG4gIH1cclxufSlcclxuXHJcbmFmdGVyQWxsKCgpID0+IHtcclxuICAvLyBSZXN0YXVyYXIgY29uc29sZSBvcmlnaW5hbFxyXG4gIGdsb2JhbC5jb25zb2xlID0gb3JpZ2luYWxDb25zb2xlXHJcbn0pXHJcblxyXG4vLyBDb25maWd1cmFjacOzbiBkZSBtb2NrcyBnbG9iYWxlc1xyXG5qZXN0Lm1vY2soJ0BzdXBhYmFzZS9zdXBhYmFzZS1qcycsICgpID0+ICh7XHJcbiAgY3JlYXRlQ2xpZW50OiBqZXN0LmZuKCgpID0+ICh7XHJcbiAgICBmcm9tOiBqZXN0LmZuKCgpID0+ICh7XHJcbiAgICAgIHNlbGVjdDogamVzdC5mbigoKSA9PiAoe1xyXG4gICAgICAgIGVxOiBqZXN0LmZuKCgpID0+ICh7XHJcbiAgICAgICAgICBvcmRlcjogamVzdC5mbigoKSA9PiAoe1xyXG4gICAgICAgICAgICBsaW1pdDogamVzdC5mbigoKSA9PiBQcm9taXNlLnJlc29sdmUoeyBkYXRhOiBbXSwgZXJyb3I6IG51bGwgfSkpXHJcbiAgICAgICAgICB9KSlcclxuICAgICAgICB9KSlcclxuICAgICAgfSkpLFxyXG4gICAgICBpbnNlcnQ6IGplc3QuZm4oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgZGF0YTogW10sIGVycm9yOiBudWxsIH0pKSxcclxuICAgICAgdXBkYXRlOiBqZXN0LmZuKCgpID0+ICh7XHJcbiAgICAgICAgZXE6IGplc3QuZm4oKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHsgZGF0YTogW10sIGVycm9yOiBudWxsIH0pKVxyXG4gICAgICB9KSksXHJcbiAgICAgIHVwc2VydDogamVzdC5mbigoKSA9PiBQcm9taXNlLnJlc29sdmUoeyBkYXRhOiBbXSwgZXJyb3I6IG51bGwgfSkpLFxyXG4gICAgICBkZWxldGU6IGplc3QuZm4oKCkgPT4gKHtcclxuICAgICAgICBlcTogamVzdC5mbigoKSA9PiBQcm9taXNlLnJlc29sdmUoeyBkYXRhOiBbXSwgZXJyb3I6IG51bGwgfSkpXHJcbiAgICAgIH0pKVxyXG4gICAgfSkpXHJcbiAgfSkpXHJcbn0pKVxyXG5cclxuamVzdC5tb2NrKCdvcGVuYWknLCAoKSA9PiB7XHJcbiAgcmV0dXJuIGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gKHtcclxuICAgIGNoYXQ6IHtcclxuICAgICAgY29tcGxldGlvbnM6IHtcclxuICAgICAgICBjcmVhdGU6IGplc3QuZm4oKVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfSkpXHJcbn0pXHJcblxyXG4vLyBNb2NrIGRlIGZldGNoIHBhcmEgcmVxdWVzdHMgSFRUUFxyXG5nbG9iYWwuZmV0Y2ggPSBqZXN0LmZuKClcclxuXHJcbi8vIENvbmZpZ3VyYWNpw7NuIGRlIHRpbWVycyBwYXJhIHRlc3RzXHJcbmplc3QudXNlRmFrZVRpbWVycygpXHJcblxyXG4vLyBDb25maWd1cmFjacOzbiBkZSBjcnlwdG8gcGFyYSB0ZXN0c1xyXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZ2xvYmFsLCAnY3J5cHRvJywge1xyXG4gIHZhbHVlOiB7XHJcbiAgICByYW5kb21VVUlEOiBqZXN0LmZuKCgpID0+ICd0ZXN0LXV1aWQtMTIzJylcclxuICB9XHJcbn0pXHJcblxyXG4vLyBDb25maWd1cmFjacOzbiBkZSBEYXRlIHBhcmEgdGVzdHMgY29uc2lzdGVudGVzXHJcbmNvbnN0IG1vY2tEYXRlID0gbmV3IERhdGUoJzIwMjQtMDEtMTVUMTA6MDA6MDBaJylcclxuamVzdC5zcHlPbihnbG9iYWwsICdEYXRlJykubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IG1vY2tEYXRlKVxyXG5cclxuLy8gQ29uZmlndXJhY2nDs24gZGUgTWF0aC5yYW5kb20gcGFyYSB0ZXN0cyBkZXRlcm1pbsOtc3RpY29zXHJcbmplc3Quc3B5T24oTWF0aCwgJ3JhbmRvbScpLm1vY2tSZXR1cm5WYWx1ZSgwLjUpXHJcblxyXG4vLyBDb25maWd1cmFjacOzbiBkZSBzZXRUaW1lb3V0IHkgc2V0SW50ZXJ2YWwgcGFyYSB0ZXN0c1xyXG5qZXN0LnNweU9uKGdsb2JhbCwgJ3NldFRpbWVvdXQnKS5tb2NrSW1wbGVtZW50YXRpb24oKGZuKSA9PiB7XHJcbiAgZm4oKVxyXG4gIHJldHVybiAxXHJcbn0pXHJcblxyXG5qZXN0LnNweU9uKGdsb2JhbCwgJ3NldEludGVydmFsJykubW9ja0ltcGxlbWVudGF0aW9uKChmbikgPT4ge1xyXG4gIGZuKClcclxuICByZXR1cm4gMVxyXG59KVxyXG5cclxuLy8gQ29uZmlndXJhY2nDs24gZGUgY2xlYXJUaW1lb3V0IHkgY2xlYXJJbnRlcnZhbFxyXG5qZXN0LnNweU9uKGdsb2JhbCwgJ2NsZWFyVGltZW91dCcpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7fSlcclxuamVzdC5zcHlPbihnbG9iYWwsICdjbGVhckludGVydmFsJykubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IHt9KVxyXG5cclxuLy8gQ29uZmlndXJhY2nDs24gZGUgcHJvY2Vzcy5lbnYgcGFyYSB0ZXN0c1xyXG5wcm9jZXNzLmVudi5URVNUX01PREUgPSAndHJ1ZSdcclxucHJvY2Vzcy5lbnYuRElTQUJMRV9MT0dHSU5HID0gJ3RydWUnXHJcblxyXG4vLyBDb25maWd1cmFjacOzbiBkZSBlcnJvcmVzIG5vIG1hbmVqYWRvc1xyXG5wcm9jZXNzLm9uKCd1bmhhbmRsZWRSZWplY3Rpb24nLCAocmVhc29uLCBwcm9taXNlKSA9PiB7XHJcbiAgY29uc29sZS5lcnJvcignVW5oYW5kbGVkIFJlamVjdGlvbiBhdDonLCBwcm9taXNlLCAncmVhc29uOicsIHJlYXNvbilcclxufSlcclxuXHJcbnByb2Nlc3Mub24oJ3VuY2F1Z2h0RXhjZXB0aW9uJywgKGVycm9yKSA9PiB7XHJcbiAgY29uc29sZS5lcnJvcignVW5jYXVnaHQgRXhjZXB0aW9uOicsIGVycm9yKVxyXG59KVxyXG5cclxuLy8gQ29uZmlndXJhY2nDs24gZGUgY2xlYW51cCBkZXNwdcOpcyBkZSBjYWRhIHRlc3RcclxuYWZ0ZXJFYWNoKCgpID0+IHtcclxuICAvLyBMaW1waWFyIHRvZG9zIGxvcyBtb2Nrc1xyXG4gIGplc3QuY2xlYXJBbGxNb2NrcygpXHJcbiAgXHJcbiAgLy8gTGltcGlhciB0aW1lcnNcclxuICBqZXN0LmNsZWFyQWxsVGltZXJzKClcclxuICBcclxuICAvLyBSZXNldGVhciBmZXRjaCBtb2NrXHJcbiAgaWYgKGdsb2JhbC5mZXRjaCkge1xyXG4gICAgKGdsb2JhbC5mZXRjaCBhcyBqZXN0Lk1vY2spLm1vY2tDbGVhcigpXHJcbiAgfVxyXG59KVxyXG5cclxuLy8gQ29uZmlndXJhY2nDs24gZGUgY2xlYW51cCBnbG9iYWxcclxuYWZ0ZXJBbGwoKCkgPT4ge1xyXG4gIC8vIFJlc3RhdXJhciB0aW1lcnMgcmVhbGVzXHJcbiAgamVzdC51c2VSZWFsVGltZXJzKClcclxuICBcclxuICAvLyBSZXN0YXVyYXIgRGF0ZSByZWFsXHJcbiAgamVzdC5yZXN0b3JlQWxsTW9ja3MoKVxyXG4gIFxyXG4gIC8vIExpbXBpYXIgdmFyaWFibGVzIGRlIGVudG9ybm8gZGUgdGVzdFxyXG4gIGRlbGV0ZSBwcm9jZXNzLmVudi5URVNUX01PREVcclxuICBkZWxldGUgcHJvY2Vzcy5lbnYuRElTQUJMRV9MT0dHSU5HXHJcbn0pXHJcblxyXG4vLyBDb25maWd1cmFjacOzbiBkZSBoZWxwZXJzIGdsb2JhbGVzIHBhcmEgdGVzdHNcclxuZ2xvYmFsLnRlc3RIZWxwZXJzID0ge1xyXG4gIC8vIEhlbHBlciBwYXJhIGNyZWFyIG1vY2sgZGUgcmVzcHVlc3RhIGRlIE9wZW5BSVxyXG4gIGNyZWF0ZU1vY2tPcGVuQUlSZXNwb25zZTogKGNvbnRlbnQ6IGFueSkgPT4gKHtcclxuICAgIGNob2ljZXM6IFt7XHJcbiAgICAgIG1lc3NhZ2U6IHtcclxuICAgICAgICBjb250ZW50OiB0eXBlb2YgY29udGVudCA9PT0gJ3N0cmluZycgPyBjb250ZW50IDogSlNPTi5zdHJpbmdpZnkoY29udGVudClcclxuICAgICAgfVxyXG4gICAgfV1cclxuICB9KSxcclxuICBcclxuICAvLyBIZWxwZXIgcGFyYSBjcmVhciBtb2NrIGRlIGZ1ZW50ZSBsZWdhbFxyXG4gIGNyZWF0ZU1vY2tMZWdhbFNvdXJjZTogKG92ZXJyaWRlcyA9IHt9KSA9PiAoe1xyXG4gICAgdGl0bGU6ICdGdWVudGUgTGVnYWwgVGVzdCcsXHJcbiAgICB1cmw6ICdodHRwczovL3d3dy50ZXN0Lmdvdi5jbycsXHJcbiAgICBjb250ZW50OiAnQ29udGVuaWRvIGRlIHBydWViYScsXHJcbiAgICBzbmlwcGV0OiAnU25pcHBldCBkZSBwcnVlYmEnLFxyXG4gICAgdHlwZTogJ29mZmljaWFsJyxcclxuICAgIHF1YWxpdHk6IDgsXHJcbiAgICBhdXRob3JpdHk6ICdtYXhpbWEnLFxyXG4gICAgY3VycmVuY3k6ICdhY3R1YWxpemFkYScsXHJcbiAgICByZWNvbW1lbmRlZFVzZTogJ2NpdGFfcHJpbmNpcGFsJyxcclxuICAgIHZlcmlmaWNhdGlvbk5vdGVzOiAnVmVyaWZpY2FkYSBlbiB0ZXN0cycsXHJcbiAgICAuLi5vdmVycmlkZXNcclxuICB9KSxcclxuICBcclxuICAvLyBIZWxwZXIgcGFyYSBjcmVhciBtb2NrIGRlIGNvbnRleHRvIGRlIGNoYXRcclxuICBjcmVhdGVNb2NrQ2hhdENvbnRleHQ6IChvdmVycmlkZXMgPSB7fSkgPT4gKHtcclxuICAgIGNoYXRJZDogJ3Rlc3QtY2hhdC0xMjMnLFxyXG4gICAgdXNlcklkOiAndGVzdC11c2VyLTQ1NicsXHJcbiAgICBjb252ZXJzYXRpb25IaXN0b3J5OiBbXSxcclxuICAgIGN1cnJlbnRDb250ZXh0OiAnJyxcclxuICAgIHNlYXJjaEhpc3Rvcnk6IFtdLFxyXG4gICAgdXNlclByZWZlcmVuY2VzOiB7XHJcbiAgICAgIHByZWZlcnJlZFNlYXJjaFN0cmF0ZWd5OiAnQUdFTlRFX1VOSUZJQ0FET19UT05HWUknLFxyXG4gICAgICBtYXhTZWFyY2hSb3VuZHM6IDUsXHJcbiAgICAgIGVuYWJsZU1vZGVsRGVjaXNpb246IHRydWUsXHJcbiAgICAgIHByZWZlcnJlZFJlc2VhcmNoTW9kZTogdW5kZWZpbmVkLFxyXG4gICAgICBxdWFsaXR5VGhyZXNob2xkOiAwLjg1XHJcbiAgICB9LFxyXG4gICAgY2FjaGVkU291cmNlczogW10sXHJcbiAgICBxdWFsaXR5TWV0cmljczoge1xyXG4gICAgICB0b3RhbFF1ZXJpZXM6IDAsXHJcbiAgICAgIGF2ZXJhZ2VRdWFsaXR5OiAwLFxyXG4gICAgICBtb2RlUGVyZm9ybWFuY2U6IHtcclxuICAgICAgICByZWFjdDogeyBjb3VudDogMCwgYXZnUXVhbGl0eTogMCwgYXZnVGltZTogMCB9LFxyXG4gICAgICAgIGl0ZXJfcmVzZWFyY2g6IHsgY291bnQ6IDAsIGF2Z1F1YWxpdHk6IDAsIGF2Z1RpbWU6IDAgfSxcclxuICAgICAgICBoeWJyaWQ6IHsgY291bnQ6IDAsIGF2Z1F1YWxpdHk6IDAsIGF2Z1RpbWU6IDAgfVxyXG4gICAgICB9LFxyXG4gICAgICB2ZXJpZmljYXRpb25TdGF0czoge1xyXG4gICAgICAgIHRvdGFsVmVyaWZpY2F0aW9uczogMCxcclxuICAgICAgICBwYXNzZWRWZXJpZmljYXRpb25zOiAwLFxyXG4gICAgICAgIGF2ZXJhZ2VDb25maWRlbmNlOiAwLFxyXG4gICAgICAgIHN1Y2Nlc3NSYXRlOiAwXHJcbiAgICAgIH1cclxuICAgIH0sXHJcbiAgICAuLi5vdmVycmlkZXNcclxuICB9KSxcclxuICBcclxuICAvLyBIZWxwZXIgcGFyYSBjcmVhciBtb2NrIGRlIGNvbnN1bHRhIGxlZ2FsXHJcbiAgY3JlYXRlTW9ja0xlZ2FsUXVlcnk6IChvdmVycmlkZXMgPSB7fSkgPT4gKHtcclxuICAgIHF1ZXJ5OiAnwr9DdcOhbGVzIHNvbiBsb3MgcmVxdWlzaXRvcyBwYXJhIGNvbnN0aXR1aXIgdW5hIFNBUz8nLFxyXG4gICAgdXNlcklkOiAndGVzdC11c2VyLTEyMycsXHJcbiAgICBjaGF0SWQ6ICd0ZXN0LWNoYXQtNDU2JyxcclxuICAgIGNvbnRleHQ6IGdsb2JhbC50ZXN0SGVscGVycy5jcmVhdGVNb2NrQ2hhdENvbnRleHQoKSxcclxuICAgIC4uLm92ZXJyaWRlc1xyXG4gIH0pLFxyXG4gIFxyXG4gIC8vIEhlbHBlciBwYXJhIGVzcGVyYXIgY29uIHRpbWVvdXRcclxuICB3YWl0Rm9yOiAobXM6IG51bWJlcikgPT4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIG1zKSksXHJcbiAgXHJcbiAgLy8gSGVscGVyIHBhcmEgY3JlYXIgbW9jayBkZSBlcnJvclxyXG4gIGNyZWF0ZU1vY2tFcnJvcjogKG1lc3NhZ2U6IHN0cmluZywgY29kZT86IHN0cmluZykgPT4ge1xyXG4gICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IobWVzc2FnZSlcclxuICAgIGlmIChjb2RlKSB7XHJcbiAgICAgIChlcnJvciBhcyBhbnkpLmNvZGUgPSBjb2RlXHJcbiAgICB9XHJcbiAgICByZXR1cm4gZXJyb3JcclxuICB9XHJcbn1cclxuXHJcbi8vIENvbmZpZ3VyYWNpw7NuIGRlIHRpcG9zIGdsb2JhbGVzIHBhcmEgVHlwZVNjcmlwdFxyXG5kZWNsYXJlIGdsb2JhbCB7XHJcbiAgdmFyIHRlc3RIZWxwZXJzOiB7XHJcbiAgICBjcmVhdGVNb2NrT3BlbkFJUmVzcG9uc2U6IChjb250ZW50OiBhbnkpID0+IGFueVxyXG4gICAgY3JlYXRlTW9ja0xlZ2FsU291cmNlOiAob3ZlcnJpZGVzPzogYW55KSA9PiBhbnlcclxuICAgIGNyZWF0ZU1vY2tDaGF0Q29udGV4dDogKG92ZXJyaWRlcz86IGFueSkgPT4gYW55XHJcbiAgICBjcmVhdGVNb2NrTGVnYWxRdWVyeTogKG92ZXJyaWRlcz86IGFueSkgPT4gYW55XHJcbiAgICB3YWl0Rm9yOiAobXM6IG51bWJlcikgPT4gUHJvbWlzZTx2b2lkPlxyXG4gICAgY3JlYXRlTW9ja0Vycm9yOiAobWVzc2FnZTogc3RyaW5nLCBjb2RlPzogc3RyaW5nKSA9PiBFcnJvclxyXG4gIH1cclxufVxyXG4iXSwidmVyc2lvbiI6M30=