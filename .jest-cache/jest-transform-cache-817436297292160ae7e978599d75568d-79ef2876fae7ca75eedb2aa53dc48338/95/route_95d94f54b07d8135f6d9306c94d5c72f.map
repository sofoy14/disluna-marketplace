{"version":3,"names":["cov_2x56teek7","actualCoverage","s","exports","GET","server_1","require","client_1","config_1","billing_1","utils_1","dynamic","req","f","authHeader","headers","get","b","wompiConfig","cronSecret","NextResponse","json","error","status","isEnabled","console","log","failedInvoices","getFailedInvoicesForRetry","length","retriedCount","retryErrorCount","invoice","id","attempt_count","reference","generateRetryReference","transactionData","amount_in_cents","currency","customer_email","subscriptions","payment_sources","payment_method","type","installments","payment_source_id","wompi_id","redirect_url","process","env","NEXT_PUBLIC_APP_URL","recurrent","wompiTransaction","wompiClient","createTransaction","invoice_id","workspace_id","payment_method_type","status_message","raw_payload","updateInvoice","wompi_transaction_id","updateError","suspendedInvoices","getSuspendedInvoices","suspendedCount","updateSubscription","subscription_id","success","retried","retry_errors","suspended","total_failed_invoices","total_suspended_invoices"],"sources":["C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\app\\api\\cron\\dunning\\route.ts"],"sourcesContent":["// app/api/cron/dunning/route.ts\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport { wompiClient } from '@/lib/wompi/client';\r\nimport { wompiConfig } from '@/lib/wompi/config';\r\nimport { \r\n  getFailedInvoicesForRetry, \r\n  getSuspendedInvoices,\r\n  updateInvoice,\r\n  updateSubscription,\r\n  createTransaction \r\n} from '@/db/billing';\r\nimport { generateRetryReference } from '@/lib/wompi/utils';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport async function GET(req: NextRequest) {\r\n  try {\r\n    // Validate cron secret\r\n    const authHeader = req.headers.get('Authorization');\r\n    if (!authHeader || authHeader !== `Bearer ${wompiConfig.cronSecret}`) {\r\n      return NextResponse.json(\r\n        { error: 'Unauthorized' }, \r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Check if billing is enabled\r\n    if (!wompiConfig.isEnabled) {\r\n      return NextResponse.json(\r\n        { error: 'Billing is not enabled' }, \r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    console.log('Starting dunning cron job...');\r\n\r\n    // Process failed invoices for retry\r\n    const failedInvoices = await getFailedInvoicesForRetry();\r\n    console.log(`Found ${failedInvoices.length} failed invoices for retry`);\r\n\r\n    let retriedCount = 0;\r\n    let retryErrorCount = 0;\r\n\r\n    for (const invoice of failedInvoices) {\r\n      try {\r\n        console.log(`Retrying invoice ${invoice.id} (attempt ${invoice.attempt_count + 1})`);\r\n\r\n        // Create retry transaction in Wompi\r\n        const reference = generateRetryReference(invoice.id, invoice.attempt_count + 1);\r\n        const transactionData = {\r\n          amount_in_cents: invoice.amount_in_cents,\r\n          currency: 'COP',\r\n          customer_email: invoice.subscriptions.payment_sources.customer_email,\r\n          payment_method: {\r\n            type: invoice.subscriptions.payment_sources.type,\r\n            installments: 1\r\n          },\r\n          payment_source_id: invoice.subscriptions.payment_sources.wompi_id,\r\n          reference,\r\n          redirect_url: `${process.env.NEXT_PUBLIC_APP_URL}/billing/success`\r\n        };\r\n\r\n        // Add recurrent flag for cards\r\n        if (invoice.subscriptions.payment_sources.type === 'CARD') {\r\n          transactionData.recurrent = true;\r\n        }\r\n\r\n        const wompiTransaction = await wompiClient.createTransaction(transactionData);\r\n        console.log(`Created retry transaction ${wompiTransaction.id} for invoice ${invoice.id}`);\r\n\r\n        // Save transaction to database\r\n        await createTransaction({\r\n          invoice_id: invoice.id,\r\n          workspace_id: invoice.workspace_id,\r\n          wompi_id: wompiTransaction.id,\r\n          amount_in_cents: wompiTransaction.amount_in_cents,\r\n          status: wompiTransaction.status,\r\n          payment_method_type: invoice.subscriptions.payment_sources.type,\r\n          reference: wompiTransaction.reference,\r\n          status_message: wompiTransaction.status_message,\r\n          raw_payload: wompiTransaction\r\n        });\r\n\r\n        // Update invoice with new transaction ID\r\n        await updateInvoice(invoice.id, {\r\n          wompi_transaction_id: wompiTransaction.id,\r\n          attempt_count: invoice.attempt_count + 1\r\n        });\r\n\r\n        // TODO: Send retry notification email\r\n        console.log(`Retry transaction created for invoice ${invoice.id}`);\r\n        retriedCount++;\r\n\r\n      } catch (error) {\r\n        console.error(`Error retrying invoice ${invoice.id}:`, error);\r\n        retryErrorCount++;\r\n        \r\n        // Update attempt count even if retry failed\r\n        try {\r\n          await updateInvoice(invoice.id, {\r\n            attempt_count: invoice.attempt_count + 1\r\n          });\r\n        } catch (updateError) {\r\n          console.error(`Error updating invoice ${invoice.id} attempt count:`, updateError);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Suspend subscriptions with too many failed attempts\r\n    const suspendedInvoices = await getSuspendedInvoices();\r\n    console.log(`Found ${suspendedInvoices.length} invoices to suspend subscriptions`);\r\n\r\n    let suspendedCount = 0;\r\n\r\n    for (const invoice of suspendedInvoices) {\r\n      try {\r\n        await updateSubscription(invoice.subscription_id, {\r\n          status: 'past_due'\r\n        });\r\n\r\n        // TODO: Send suspension notification email\r\n        console.log(`Suspended subscription ${invoice.subscription_id}`);\r\n        suspendedCount++;\r\n\r\n      } catch (error) {\r\n        console.error(`Error suspending subscription ${invoice.subscription_id}:`, error);\r\n      }\r\n    }\r\n\r\n    console.log(`Dunning cron completed. Retried: ${retriedCount}, Retry errors: ${retryErrorCount}, Suspended: ${suspendedCount}`);\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      retried: retriedCount,\r\n      retry_errors: retryErrorCount,\r\n      suspended: suspendedCount,\r\n      total_failed_invoices: failedInvoices.length,\r\n      total_suspended_invoices: suspendedInvoices.length\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Dunning cron error:', error);\r\n    return NextResponse.json(\r\n      { error: 'Dunning cron failed' }, \r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n"],"mappings":"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","ignoreList":[]}