{"version":3,"names":["cov_2djqih17wz","actualCoverage","s","exports","GET","server_1","require","client_1","config_1","billing_1","utils_1","dynamic","req","f","authHeader","headers","get","b","wompiConfig","cronSecret","NextResponse","json","error","status","isEnabled","console","log","subscriptions","getSubscriptionsDueToday","length","processedCount","errorCount","subscription","cancel_at_period_end","id","payment_sources","isPaymentSourceAvailable","updateSubscription","invoice","createInvoice","subscription_id","workspace_id","period_start","current_period_start","period_end","current_period_end","amount_in_cents","plans","reference","generateTransactionReference","transactionData","currency","customer_email","payment_method","type","installments","payment_source_id","wompi_id","redirect_url","process","env","NEXT_PUBLIC_APP_URL","recurrent","wompiTransaction","wompiClient","createTransaction","invoice_id","payment_method_type","status_message","raw_payload","updateInvoice","wompi_transaction_id","newPeriodStart","Date","newPeriodEnd","setMonth","getMonth","toISOString","updateError","success","processed","errors","total_subscriptions"],"sources":["C:\\Users\\pedro\\Documents\\GitHub\\Asistente-Legal-Inteligente\\app\\api\\cron\\billing\\route.ts"],"sourcesContent":["// app/api/cron/billing/route.ts\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport { wompiClient } from '@/lib/wompi/client';\r\nimport { wompiConfig } from '@/lib/wompi/config';\r\nimport { \r\n  getSubscriptionsDueToday, \r\n  createInvoice, \r\n  createTransaction, \r\n  updateInvoice,\r\n  updateSubscription \r\n} from '@/db/billing';\r\nimport { generateTransactionReference, isPaymentSourceAvailable } from '@/lib/wompi/utils';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport async function GET(req: NextRequest) {\r\n  try {\r\n    // Validate cron secret\r\n    const authHeader = req.headers.get('Authorization');\r\n    if (!authHeader || authHeader !== `Bearer ${wompiConfig.cronSecret}`) {\r\n      return NextResponse.json(\r\n        { error: 'Unauthorized' }, \r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Check if billing is enabled\r\n    if (!wompiConfig.isEnabled) {\r\n      return NextResponse.json(\r\n        { error: 'Billing is not enabled' }, \r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    console.log('Starting billing cron job...');\r\n\r\n    // Get subscriptions due today\r\n    const subscriptions = await getSubscriptionsDueToday();\r\n    console.log(`Found ${subscriptions.length} subscriptions due today`);\r\n\r\n    let processedCount = 0;\r\n    let errorCount = 0;\r\n\r\n    for (const subscription of subscriptions) {\r\n      try {\r\n        // Skip if subscription is set to cancel at period end\r\n        if (subscription.cancel_at_period_end) {\r\n          console.log(`Skipping subscription ${subscription.id} - set to cancel`);\r\n          continue;\r\n        }\r\n\r\n        // Validate payment source is available\r\n        if (!subscription.payment_sources || !isPaymentSourceAvailable(subscription.payment_sources.status)) {\r\n          console.log(`Skipping subscription ${subscription.id} - payment source not available`);\r\n          // Mark subscription as requiring action\r\n          await updateSubscription(subscription.id, { status: 'past_due' });\r\n          continue;\r\n        }\r\n\r\n        // Create invoice\r\n        const invoice = await createInvoice({\r\n          subscription_id: subscription.id,\r\n          workspace_id: subscription.workspace_id,\r\n          period_start: subscription.current_period_start,\r\n          period_end: subscription.current_period_end,\r\n          amount_in_cents: subscription.plans.amount_in_cents,\r\n          status: 'pending'\r\n        });\r\n\r\n        console.log(`Created invoice ${invoice.id} for subscription ${subscription.id}`);\r\n\r\n        // Create transaction in Wompi\r\n        const reference = generateTransactionReference(invoice.id);\r\n        const transactionData = {\r\n          amount_in_cents: subscription.plans.amount_in_cents,\r\n          currency: 'COP',\r\n          customer_email: subscription.payment_sources.customer_email,\r\n          payment_method: {\r\n            type: subscription.payment_sources.type,\r\n            installments: 1\r\n          },\r\n          payment_source_id: subscription.payment_sources.wompi_id,\r\n          reference,\r\n          redirect_url: `${process.env.NEXT_PUBLIC_APP_URL}/billing/success`\r\n        };\r\n\r\n        // Add recurrent flag for cards\r\n        if (subscription.payment_sources.type === 'CARD') {\r\n          transactionData.recurrent = true;\r\n        }\r\n\r\n        const wompiTransaction = await wompiClient.createTransaction(transactionData);\r\n        console.log(`Created Wompi transaction ${wompiTransaction.id} for invoice ${invoice.id}`);\r\n\r\n        // Save transaction to database\r\n        await createTransaction({\r\n          invoice_id: invoice.id,\r\n          workspace_id: subscription.workspace_id,\r\n          wompi_id: wompiTransaction.id,\r\n          amount_in_cents: wompiTransaction.amount_in_cents,\r\n          status: wompiTransaction.status,\r\n          payment_method_type: subscription.payment_sources.type,\r\n          reference: wompiTransaction.reference,\r\n          status_message: wompiTransaction.status_message,\r\n          raw_payload: wompiTransaction\r\n        });\r\n\r\n        // Update invoice with transaction ID\r\n        await updateInvoice(invoice.id, {\r\n          wompi_transaction_id: wompiTransaction.id\r\n        });\r\n\r\n        // Extend subscription period\r\n        const newPeriodStart = new Date(subscription.current_period_end);\r\n        const newPeriodEnd = new Date(newPeriodStart);\r\n        newPeriodEnd.setMonth(newPeriodEnd.getMonth() + 1);\r\n\r\n        await updateSubscription(subscription.id, {\r\n          current_period_start: newPeriodStart.toISOString(),\r\n          current_period_end: newPeriodEnd.toISOString()\r\n        });\r\n\r\n        console.log(`Extended subscription ${subscription.id} period`);\r\n        processedCount++;\r\n\r\n      } catch (error) {\r\n        console.error(`Error processing subscription ${subscription.id}:`, error);\r\n        errorCount++;\r\n        \r\n        // Mark subscription as past due if there's an error\r\n        try {\r\n          await updateSubscription(subscription.id, { status: 'past_due' });\r\n        } catch (updateError) {\r\n          console.error(`Error updating subscription ${subscription.id} status:`, updateError);\r\n        }\r\n      }\r\n    }\r\n\r\n    console.log(`Billing cron completed. Processed: ${processedCount}, Errors: ${errorCount}`);\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      processed: processedCount,\r\n      errors: errorCount,\r\n      total_subscriptions: subscriptions.length\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Billing cron error:', error);\r\n    return NextResponse.json(\r\n      { error: 'Billing cron failed' }, \r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAmBQ;IAAAA,cAAA,YAAAA,CAAA;MAAA,OAAAC,cAAA;IAAA;EAAA;EAAA,OAAAA,cAAA;AAAA;AAAAD,cAAA;AAAAA,cAAA,GAAAE,CAAA;;;;;;;;;AAJRC,OAAA,CAAAC,GAAA,GAAAA,GAAA;AAfA;AACA,MAAAC,QAAA;AAAA;AAAA,CAAAL,cAAA,GAAAE,CAAA,OAAAI,OAAA;AACA,MAAAC,QAAA;AAAA;AAAA,CAAAP,cAAA,GAAAE,CAAA,OAAAI,OAAA;AACA,MAAAE,QAAA;AAAA;AAAA,CAAAR,cAAA,GAAAE,CAAA,OAAAI,OAAA;AACA,MAAAG,SAAA;AAAA;AAAA,CAAAT,cAAA,GAAAE,CAAA,OAAAI,OAAA;AAOA,MAAAI,OAAA;AAAA;AAAA,CAAAV,cAAA,GAAAE,CAAA,OAAAI,OAAA;AAA2F;AAAAN,cAAA,GAAAE,CAAA;AAE9EC,OAAA,CAAAQ,OAAO,GAAG,eAAe;AAE/B,eAAeP,GAAGA,CAACQ,GAAgB;EAAA;EAAAZ,cAAA,GAAAa,CAAA;EAAAb,cAAA,GAAAE,CAAA;EACxC,IAAI;IACF;IACA,MAAMY,UAAU;IAAA;IAAA,CAAAd,cAAA,GAAAE,CAAA,QAAGU,GAAG,CAACG,OAAO,CAACC,GAAG,CAAC,eAAe,CAAC;IAAC;IAAAhB,cAAA,GAAAE,CAAA;IACpD;IAAI;IAAA,CAAAF,cAAA,GAAAiB,CAAA,WAACH,UAAU;IAAA;IAAA,CAAAd,cAAA,GAAAiB,CAAA,UAAIH,UAAU,KAAK,UAAUN,QAAA,CAAAU,WAAW,CAACC,UAAU,EAAE,GAAE;MAAA;MAAAnB,cAAA,GAAAiB,CAAA;MAAAjB,cAAA,GAAAE,CAAA;MACpE,OAAOG,QAAA,CAAAe,YAAY,CAACC,IAAI,CACtB;QAAEC,KAAK,EAAE;MAAc,CAAE,EACzB;QAAEC,MAAM,EAAE;MAAG,CAAE,CAChB;IACH,CAAC;IAAA;IAAA;MAAAvB,cAAA,GAAAiB,CAAA;IAAA;IAED;IAAAjB,cAAA,GAAAE,CAAA;IACA,IAAI,CAACM,QAAA,CAAAU,WAAW,CAACM,SAAS,EAAE;MAAA;MAAAxB,cAAA,GAAAiB,CAAA;MAAAjB,cAAA,GAAAE,CAAA;MAC1B,OAAOG,QAAA,CAAAe,YAAY,CAACC,IAAI,CACtB;QAAEC,KAAK,EAAE;MAAwB,CAAE,EACnC;QAAEC,MAAM,EAAE;MAAG,CAAE,CAChB;IACH,CAAC;IAAA;IAAA;MAAAvB,cAAA,GAAAiB,CAAA;IAAA;IAAAjB,cAAA,GAAAE,CAAA;IAEDuB,OAAO,CAACC,GAAG,CAAC,8BAA8B,CAAC;IAE3C;IACA,MAAMC,aAAa;IAAA;IAAA,CAAA3B,cAAA,GAAAE,CAAA,QAAG,MAAM,IAAAO,SAAA,CAAAmB,wBAAwB,GAAE;IAAC;IAAA5B,cAAA,GAAAE,CAAA;IACvDuB,OAAO,CAACC,GAAG,CAAC,SAASC,aAAa,CAACE,MAAM,0BAA0B,CAAC;IAEpE,IAAIC,cAAc;IAAA;IAAA,CAAA9B,cAAA,GAAAE,CAAA,QAAG,CAAC;IACtB,IAAI6B,UAAU;IAAA;IAAA,CAAA/B,cAAA,GAAAE,CAAA,QAAG,CAAC;IAAC;IAAAF,cAAA,GAAAE,CAAA;IAEnB,KAAK,MAAM8B,YAAY,IAAIL,aAAa,EAAE;MAAA;MAAA3B,cAAA,GAAAE,CAAA;MACxC,IAAI;QAAA;QAAAF,cAAA,GAAAE,CAAA;QACF;QACA,IAAI8B,YAAY,CAACC,oBAAoB,EAAE;UAAA;UAAAjC,cAAA,GAAAiB,CAAA;UAAAjB,cAAA,GAAAE,CAAA;UACrCuB,OAAO,CAACC,GAAG,CAAC,yBAAyBM,YAAY,CAACE,EAAE,kBAAkB,CAAC;UAAC;UAAAlC,cAAA,GAAAE,CAAA;UACxE;QACF,CAAC;QAAA;QAAA;UAAAF,cAAA,GAAAiB,CAAA;QAAA;QAED;QAAAjB,cAAA,GAAAE,CAAA;QACA;QAAI;QAAA,CAAAF,cAAA,GAAAiB,CAAA,WAACe,YAAY,CAACG,eAAe;QAAA;QAAA,CAAAnC,cAAA,GAAAiB,CAAA,UAAI,CAAC,IAAAP,OAAA,CAAA0B,wBAAwB,EAACJ,YAAY,CAACG,eAAe,CAACZ,MAAM,CAAC,GAAE;UAAA;UAAAvB,cAAA,GAAAiB,CAAA;UAAAjB,cAAA,GAAAE,CAAA;UACnGuB,OAAO,CAACC,GAAG,CAAC,yBAAyBM,YAAY,CAACE,EAAE,iCAAiC,CAAC;UACtF;UAAA;UAAAlC,cAAA,GAAAE,CAAA;UACA,MAAM,IAAAO,SAAA,CAAA4B,kBAAkB,EAACL,YAAY,CAACE,EAAE,EAAE;YAAEX,MAAM,EAAE;UAAU,CAAE,CAAC;UAAC;UAAAvB,cAAA,GAAAE,CAAA;UAClE;QACF,CAAC;QAAA;QAAA;UAAAF,cAAA,GAAAiB,CAAA;QAAA;QAED;QACA,MAAMqB,OAAO;QAAA;QAAA,CAAAtC,cAAA,GAAAE,CAAA,QAAG,MAAM,IAAAO,SAAA,CAAA8B,aAAa,EAAC;UAClCC,eAAe,EAAER,YAAY,CAACE,EAAE;UAChCO,YAAY,EAAET,YAAY,CAACS,YAAY;UACvCC,YAAY,EAAEV,YAAY,CAACW,oBAAoB;UAC/CC,UAAU,EAAEZ,YAAY,CAACa,kBAAkB;UAC3CC,eAAe,EAAEd,YAAY,CAACe,KAAK,CAACD,eAAe;UACnDvB,MAAM,EAAE;SACT,CAAC;QAAC;QAAAvB,cAAA,GAAAE,CAAA;QAEHuB,OAAO,CAACC,GAAG,CAAC,mBAAmBY,OAAO,CAACJ,EAAE,qBAAqBF,YAAY,CAACE,EAAE,EAAE,CAAC;QAEhF;QACA,MAAMc,SAAS;QAAA;QAAA,CAAAhD,cAAA,GAAAE,CAAA,QAAG,IAAAQ,OAAA,CAAAuC,4BAA4B,EAACX,OAAO,CAACJ,EAAE,CAAC;QAC1D,MAAMgB,eAAe;QAAA;QAAA,CAAAlD,cAAA,GAAAE,CAAA,QAAG;UACtB4C,eAAe,EAAEd,YAAY,CAACe,KAAK,CAACD,eAAe;UACnDK,QAAQ,EAAE,KAAK;UACfC,cAAc,EAAEpB,YAAY,CAACG,eAAe,CAACiB,cAAc;UAC3DC,cAAc,EAAE;YACdC,IAAI,EAAEtB,YAAY,CAACG,eAAe,CAACmB,IAAI;YACvCC,YAAY,EAAE;WACf;UACDC,iBAAiB,EAAExB,YAAY,CAACG,eAAe,CAACsB,QAAQ;UACxDT,SAAS;UACTU,YAAY,EAAE,GAAGC,OAAO,CAACC,GAAG,CAACC,mBAAmB;SACjD;QAED;QAAA;QAAA7D,cAAA,GAAAE,CAAA;QACA,IAAI8B,YAAY,CAACG,eAAe,CAACmB,IAAI,KAAK,MAAM,EAAE;UAAA;UAAAtD,cAAA,GAAAiB,CAAA;UAAAjB,cAAA,GAAAE,CAAA;UAChDgD,eAAe,CAACY,SAAS,GAAG,IAAI;QAClC,CAAC;QAAA;QAAA;UAAA9D,cAAA,GAAAiB,CAAA;QAAA;QAED,MAAM8C,gBAAgB;QAAA;QAAA,CAAA/D,cAAA,GAAAE,CAAA,QAAG,MAAMK,QAAA,CAAAyD,WAAW,CAACC,iBAAiB,CAACf,eAAe,CAAC;QAAC;QAAAlD,cAAA,GAAAE,CAAA;QAC9EuB,OAAO,CAACC,GAAG,CAAC,6BAA6BqC,gBAAgB,CAAC7B,EAAE,gBAAgBI,OAAO,CAACJ,EAAE,EAAE,CAAC;QAEzF;QAAA;QAAAlC,cAAA,GAAAE,CAAA;QACA,MAAM,IAAAO,SAAA,CAAAwD,iBAAiB,EAAC;UACtBC,UAAU,EAAE5B,OAAO,CAACJ,EAAE;UACtBO,YAAY,EAAET,YAAY,CAACS,YAAY;UACvCgB,QAAQ,EAAEM,gBAAgB,CAAC7B,EAAE;UAC7BY,eAAe,EAAEiB,gBAAgB,CAACjB,eAAe;UACjDvB,MAAM,EAAEwC,gBAAgB,CAACxC,MAAM;UAC/B4C,mBAAmB,EAAEnC,YAAY,CAACG,eAAe,CAACmB,IAAI;UACtDN,SAAS,EAAEe,gBAAgB,CAACf,SAAS;UACrCoB,cAAc,EAAEL,gBAAgB,CAACK,cAAc;UAC/CC,WAAW,EAAEN;SACd,CAAC;QAEF;QAAA;QAAA/D,cAAA,GAAAE,CAAA;QACA,MAAM,IAAAO,SAAA,CAAA6D,aAAa,EAAChC,OAAO,CAACJ,EAAE,EAAE;UAC9BqC,oBAAoB,EAAER,gBAAgB,CAAC7B;SACxC,CAAC;QAEF;QACA,MAAMsC,cAAc;QAAA;QAAA,CAAAxE,cAAA,GAAAE,CAAA,QAAG,IAAIuE,IAAI,CAACzC,YAAY,CAACa,kBAAkB,CAAC;QAChE,MAAM6B,YAAY;QAAA;QAAA,CAAA1E,cAAA,GAAAE,CAAA,QAAG,IAAIuE,IAAI,CAACD,cAAc,CAAC;QAAC;QAAAxE,cAAA,GAAAE,CAAA;QAC9CwE,YAAY,CAACC,QAAQ,CAACD,YAAY,CAACE,QAAQ,EAAE,GAAG,CAAC,CAAC;QAAC;QAAA5E,cAAA,GAAAE,CAAA;QAEnD,MAAM,IAAAO,SAAA,CAAA4B,kBAAkB,EAACL,YAAY,CAACE,EAAE,EAAE;UACxCS,oBAAoB,EAAE6B,cAAc,CAACK,WAAW,EAAE;UAClDhC,kBAAkB,EAAE6B,YAAY,CAACG,WAAW;SAC7C,CAAC;QAAC;QAAA7E,cAAA,GAAAE,CAAA;QAEHuB,OAAO,CAACC,GAAG,CAAC,yBAAyBM,YAAY,CAACE,EAAE,SAAS,CAAC;QAAC;QAAAlC,cAAA,GAAAE,CAAA;QAC/D4B,cAAc,EAAE;MAElB,CAAC,CAAC,OAAOR,KAAK,EAAE;QAAA;QAAAtB,cAAA,GAAAE,CAAA;QACduB,OAAO,CAACH,KAAK,CAAC,iCAAiCU,YAAY,CAACE,EAAE,GAAG,EAAEZ,KAAK,CAAC;QAAC;QAAAtB,cAAA,GAAAE,CAAA;QAC1E6B,UAAU,EAAE;QAEZ;QAAA;QAAA/B,cAAA,GAAAE,CAAA;QACA,IAAI;UAAA;UAAAF,cAAA,GAAAE,CAAA;UACF,MAAM,IAAAO,SAAA,CAAA4B,kBAAkB,EAACL,YAAY,CAACE,EAAE,EAAE;YAAEX,MAAM,EAAE;UAAU,CAAE,CAAC;QACnE,CAAC,CAAC,OAAOuD,WAAW,EAAE;UAAA;UAAA9E,cAAA,GAAAE,CAAA;UACpBuB,OAAO,CAACH,KAAK,CAAC,+BAA+BU,YAAY,CAACE,EAAE,UAAU,EAAE4C,WAAW,CAAC;QACtF;MACF;IACF;IAAC;IAAA9E,cAAA,GAAAE,CAAA;IAEDuB,OAAO,CAACC,GAAG,CAAC,sCAAsCI,cAAc,aAAaC,UAAU,EAAE,CAAC;IAAC;IAAA/B,cAAA,GAAAE,CAAA;IAE3F,OAAOG,QAAA,CAAAe,YAAY,CAACC,IAAI,CAAC;MACvB0D,OAAO,EAAE,IAAI;MACbC,SAAS,EAAElD,cAAc;MACzBmD,MAAM,EAAElD,UAAU;MAClBmD,mBAAmB,EAAEvD,aAAa,CAACE;KACpC,CAAC;EAEJ,CAAC,CAAC,OAAOP,KAAK,EAAE;IAAA;IAAAtB,cAAA,GAAAE,CAAA;IACduB,OAAO,CAACH,KAAK,CAAC,qBAAqB,EAAEA,KAAK,CAAC;IAAC;IAAAtB,cAAA,GAAAE,CAAA;IAC5C,OAAOG,QAAA,CAAAe,YAAY,CAACC,IAAI,CACtB;MAAEC,KAAK,EAAE;IAAqB,CAAE,EAChC;MAAEC,MAAM,EAAE;IAAG,CAAE,CAChB;EACH;AACF","ignoreList":[]}